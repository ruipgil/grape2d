'use strict';var Grape2D={vernum:0,version:"1.0.0-alpha"};(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var e=(new Date).getTime(),g=Math.max(0,16-(e-a)),k=window.setTimeout(function(){b(e+g)},g);a=e+g;return k});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();Grape2D.utils={getDocumentSize:function(){return{width:document.width||document.documentElement.clientWidth,height:document.height||document.documentElement.clientHeight}}};Grape2D.utils.Clock=function(){this.frameCount=0;this.lastFrame=this.end=this.start=(new Date).getTime();this.timeEl=this.fps=0};Grape2D.utils.Clock.prototype={constructor:Grape2D.utils.Clock,update:function(){var a=(new Date).getTime(),b=a-this.lastFrame;this.frameCount++;this.timeEl++;1E3<=this.timeEl&&this.reset(a);this.lastFrame=a;return b},reset:function(a){this.fps=this.frameCount;this.frameCount=this.timeEl=0;this.end=a}};Grape2D.Math={PI:3.141592653589793,PIx2:6.283185307179586,PId2:1.5707963267948966,PId4:0.7853981633974483,PId6:0.5235987755982988,PId8:0.39269908169872414,abs:function(a){return Math.abs(a)},floor:function(a){return~~a},ceil:function(a){return Math.ceil(a)},round:function(a){return~~(a+0.5)},randFloat:function(a,b){return b?a+Math.random()*(b-a):Math.random()*a},randInt:function(a,b){return Grape2D.Math.floor(Grape2D.Math.randFloat(a,b)+0.5)},cos:Math.cos,sin:Math.sin,tan:Math.tan,sqrt:Math.sqrt,
pow:Math.pow,min:Math.min,max:Math.max,clamp:function(a,b,c){return a<b?b:a>c?c:a},overlaps:function(a,b){return a.min<=b.min?a.max-b.min:Grape2D.Math.overlaps(b,a)},sq:function(a){return a*a}};Grape2D.Vector=function(a,b){this.x=a||0;this.y=b||0};
Grape2D.Vector.prototype={constructor:Grape2D.Vector,getX:function(){return this.x},setX:function(a){this.x=a},getY:function(){return this.y},setY:function(a){this.y=a},set:function(a){this.x=a.x;this.y=a.y;return this},add:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},multiplyByScalar:function(a){this.x*=a;this.y*=a;return this},divideByScalar:function(a){this.x/=a;this.y/=a;return this},negate:function(){return this.multiplyByScalar(-1)},normalize:function(){return this.divideByScalar(this.getMagnitude())},
getMagnitude:function(){return Grape2D.Math.sqrt(this.x*this.x+this.y*this.y)},length:function(){return this.getMagnitude()},lengthSquared:function(){return this.x*this.x+this.y*this.y},getAngle:function(){var a=1;0>this.y&&(a=-1);return Math.acos(this.x/this.length())*a},dot:function(a){return this.x*a.x+this.y*a.y},project:function(a){var b=this.dot(a),c=new Grape2D.Vector;c.x=b*a.x;c.y=b*a.y;return c},rightNormal:function(){return new Grape2D.Vector(-this.y,this.x)},isParallelTo:function(a){return Grape2D.Math.abs(a.x)==
Grape2D.Math.abs(this.x)&&Grape2D.Math.abs(a.y)==Grape2D.Math.abs(this.y)},distanceTo:function(a){return Grape2D.Math.sqrt(a.x*this.x+a.y*this.y)},sqDistanceTo:function(a){return a.x*this.x+a.y*this.y},equals:function(a){return this.x==a.x&&this.y==a.y},clone:function(){return new Grape2D.Vector(this.x,this.y)},toString:function(){return"Grape2D.Vector ("+this.x+","+this.y+")"},use:function(a){this.x=a(this.x);this.y=a(this.y);return this},reset:function(){this.y=this.x=0;return this}};
Grape2D.Vector.createFromPoints=function(a,b){return new Grape2D.Vector(b.x-a.x,b.y-a.y)};Grape2D.Vector.createFromAngle=function(a,b){return new Grape2D.Vector(b*Grape2D.Math.cos(a),b*Grape2D.Math.sin(a))};Grape2D.Matrix=function(a,b,c,d,f,e,g,k,h){this.v=[];void 0!==a?this.v=[a,b,c,d,f,e,g,k,h]:this.identity()};
Grape2D.Matrix.prototype={constructor:Grape2D.Matrix,set:function(a,b,c,d,f,e,g,k,h){a=this.v;a[0]=a[4]=a[8]=1;a[1]=a[2]=a[3]=a[5]=a[6]=a[7]=0;return this},add:function(a){for(var b=0;9>b;b++)this.v[b]+=a.v[b];return this},identity:function(){this.v=[1,0,0,0,1,0,0,0,1];return this},invert:function(){var a=this.determinant(),b=this.v;this.v=[b[4]*b[8]-b[5]*b[7],b[2]*b[7]-b[1]*b[8],b[1]*b[5]-b[2]*b[4],b[5]*b[6]-b[8]*b[3],b[0]*b[8]-b[2]*b[6],b[2]*b[3]-b[0]*b[5],b[3]*b[7]-b[4]*b[6],b[1]*b[6]-b[0]*b[7],
b[0]*b[4]-b[1]*b[3]];return this.multiplyByScalar(1/a)},determinant:function(){var a=this.v;return a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6])},multiplyByVector:function(a){return new Grape2D.Vector(this.v[0]*a.getX()+this.v[1]*a.getY()+this.v[2],this.v[3]*a.getX()+this.v[4]*a.getY()+this.v[5])},multiplyByScalar:function(a){this.v[0]*=a;this.v[1]*=a;this.v[2]*=a;this.v[3]*=a;this.v[4]*=a;this.v[5]*=a;this.v[6]*=a;this.v[7]*=a;this.v[8]*=a;return this},multiplyByMatrix:function(a){var b=
this.v;a=a.v;return new Grape2D.Matrix(b[0]*a[0]+b[1]*a[3]+b[2]*a[6],b[0]*a[1]+b[1]*a[4]+b[2]*a[7],b[0]*a[2]+b[1]*a[5]+b[2]*a[8],b[3]*a[0]+b[4]*a[3]+b[5]*a[6],b[3]*a[1]+b[4]*a[4]+b[5]*a[7],b[3]*a[2]+b[4]*a[5]+b[5]*a[8],b[6]*a[0]+b[7]*a[3]+b[8]*a[6],b[6]*a[1]+b[7]*a[4]+b[8]*a[7],b[6]*a[2]+b[7]*a[5]+b[8]*a[8])},transpose:function(){var a,b=this.v;a=b[1];b[1]=b[3];b[3]=a;a=b[2];b[2]=b[6];b[6]=a;a=b[5];b[5]=b[7];b[7]=a;return this},clone:function(){return new Grape2D.Matrix(this.v[0],this.v[1],this.v[2],
this.v[3],this.v[4],this.v[5],this.v[6],this.v[7],this.v[8])},toString:function(){return"Grape2D.Matrix\n"+this.v[0]+" "+this.v[1]+" "+this.v[2]+"\n"+this.v[3]+" "+this.v[4]+" "+this.v[5]+"\n"+this.v[6]+" "+this.v[7]+" "+this.v[8]}};Grape2D.Renderer=function(){};
Grape2D.Renderer.prototype={constructor:Grape2D.Renderer,getWidth:function(){},getHalfWidth:function(){},setWidth:function(a){},getHeight:function(){},getHalfHeight:function(){},setHeight:function(a){},renderTexture:function(a,b){},renderObject2D:function(a,b){},renderImage:function(a,b,c,d,f,e,g,k,h){},renderAABB:function(a,b){},renderCircle:function(a,b){},renderPolygon:function(a,b){},renderText:function(a,b){},start:function(){},end:function(){},appendToDOMElement:function(a){},getDOMElement:function(){},
setStrokeColor:function(a){},setFillColor:function(a){},renderParticle:function(a,b){}};Grape2D.Canvas=function(a){a=a||{};this.canvas=document.createElement("Canvas");this.canvas.width=a.width||300;this.canvas.height=a.height||150;this.halfWidth=this.canvas.width/2;this.halfHeight=this.canvas.height/2;this.context=this.canvas.getContext("2d")};
Grape2D.Canvas.prototype={getWidth:function(){return this.canvas.width},getHalfWidth:function(){return this.halfWidth},setWidth:function(a){this.canvas.width=a;this.halfWidth=a/2},getHeight:function(){return this.canvas.height},getHalfHeight:function(){return this.halfHeight},setHeight:function(a){this.canvas.height=a;this.halfHeight=a/2},toDataURL:function(a,b){return this.canvas.toDataURL(a,b)},getContext:function(){return this.context},save:function(){this.context.save();return this},restore:function(){this.context.restore();
return this},scale:function(a,b){this.context.scale(a,b);return this},rotate:function(a){this.context.rotate(a);return this},translate:function(a,b){this.context.translate(a,b);return this},transform:function(a,b,c,d,f,e){this.context.transform(a,b,c,d,f,e);return this},drawImage:function(a,b,c,d,f,e,g,k,h){this.context.drawImage(a,b,c,d,f,e,g,k,h);return this},setGlobalAlpha:function(a){this.context.globalAlpha=a;return this},globalCompositeOperation:function(a){this.context.globalCompositeOperation=
a;return this},setLineWidth:function(a){this.context.lineWidth=a;return this},setLineCap:function(a){this.context.lineCap=a;return this},setLineJoin:function(a){this.context.lineJoin=a;return this},setMiterLimit:function(a){this.context.miterLimit=a;return this},setStrokeStyle:function(a){this.context.strokeStyle=a;return this},setFillStyle:function(a){this.context.fillStyle=a;return this},setShadowOffsetX:function(a){this.context.shadowOffsetX=a;return this},setShadowOffsetY:function(a){this.context.shadowOffsetY=
a;return this},setShadowBlur:function(a){this.context.shadowBlur=a;return this},setShadowColor:function(a){this.context.shadowColor=a;return this},createLinearGradient:function(a,b,c,d){return this.context.createLinearGradient(a,b,c,d)},createRadialGradient:function(a,b,c,d,f,e){return this.context.createRadialGradient(a,b,c,d,f,e)},createPattern:function(a,b){return this.context.createPattern(a,b)},beginPath:function(){this.context.beginPath();return this},closePath:function(){this.context.closePath();
return this},fill:function(){this.context.fill();return this},stroke:function(){this.context.stroke();return this},clip:function(){this.context.clip();return this},moveTo:function(a,b){this.context.moveTo(a,b);return this},lineTo:function(a,b){this.context.lineTo(a,b);return this},quadraticCurveTo:function(a,b,c,d){this.context.quadraticCurveTo(a,b,c,d);return this},bezierCurveTo:function(a,b,c,d,f,e){this.context.bezierCurveTo(a,b,c,d,f,e);return this},arcTo:function(a,b,c,d,f){this.context.arcTo(a,
b,c,d,f);return this},arc:function(a,b,c,d,f,e){this.context.arc(a,b,c,d||0,f||Grape2D.Math.PIx2,e||!1);return this},rect:function(a,b,c,d){this.context.rect(a,b,c,d);return this},isPointInPath:function(a,b){return this.context.isPointInPath(a,b)},setFont:function(a){this.context.font=a;return this},setTextAlign:function(a){this.context.textAlign=a;return this},setTextBaseline:function(a){this.context.textBaseline=a;return this},fillText:function(a,b,c){this.context.fillText(a,b,c);return this},strokeText:function(a,
b,c){this.context.strokeText(a,b,c);return this},measureText:function(a){return this.context.measureText(a)},clearRect:function(a,b,c,d){this.context.clearRect(a,b,c,d);return this},fillRect:function(a,b,c,d){this.context.fillRect(a,b,c,d);return this},strokeRect:function(a,b,c,d){this.context.strokeRect(a,b,c,d);return this},createImageData:function(a,b){return this.context.createImageData(a,b)},getImageData:function(a,b,c,d){return this.context.getImageData(a,b,c,d)},putImageData:function(a,b,c,
d,f,e,g){this.context.putImageData(a,b,c,d,f,e,g);return this},resize:function(a,b){this.setWidth(a);this.setHeight(b);return this},appendOn:function(a){a.appendChild(this.canvas);return this},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};Grape2D.CanvasRenderer=function(a){this.canvas=new Grape2D.Canvas(a)};Grape2D.CanvasRenderer.prototype=Object.create(Grape2D.Renderer.prototype);Grape2D.CanvasRenderer.prototype.getWidth=function(){return this.canvas.getWidth()};Grape2D.CanvasRenderer.prototype.getHalfWidth=function(){return this.canvas.getHalfWidth()};Grape2D.CanvasRenderer.prototype.setWidth=function(a){this.canvas.setWidth(a)};Grape2D.CanvasRenderer.prototype.getHeight=function(){return this.canvas.getHeight()};
Grape2D.CanvasRenderer.prototype.getHalfHeight=function(){return this.canvas.getHalfHeight()};Grape2D.CanvasRenderer.prototype.setHeight=function(a){this.canvas.setHeight(a)};Grape2D.CanvasRenderer.prototype.renderTexture=function(a,b){this.canvas.drawImage(a.getBuffer(),0,0,a.getWidth(),a.getHeight(),b.getX(),b.getY(),1*a.getWidth(),1*a.getHeight())};Grape2D.CanvasRenderer.prototype.renderObject2D=function(a,b){a.getTexture().render(this,b.wcsToViewport(this,a.getTexturePosition()))};
Grape2D.CanvasRenderer.prototype.renderImage=function(a,b,c,d,f,e,g,k,h){this.canvas.drawImage(a,b,c,d,f,e,g,k,h)};Grape2D.CanvasRenderer.prototype.renderAABB=function(a,b){var c=a.getPosition(),c=new Grape2D.Vector(c.x-a.getHalfWidth(),c.y-a.getHalfHeight()),c=b.wcsToViewport(this,c);this.canvas.strokeRect(c.x,c.y,a.getWidth()*b.getScale().x,a.getHeight()*b.getScale().y)};
Grape2D.CanvasRenderer.prototype.renderCircle=function(a,b){var c=b.wcsToViewport(this,a.getPosition());this.canvas.beginPath();this.canvas.arc(c.x,c.y,a.getRadius(),0,Grape2D.Math.PIx2,!1);this.canvas.stroke()};
Grape2D.CanvasRenderer.prototype.renderPolygon=function(a,b){var c=a.getPosition(),d=null,f=c.clone(),e=a.getVertexList(),f=b.wcsToViewport(this,f.add(e[0]));this.canvas.beginPath();this.canvas.moveTo(f.getX(),f.getY());for(var g=1;g<e.length;g++)d=c.clone(),d=b.wcsToViewport(this,d.add(e[g])),this.canvas.lineTo(d.getX(),d.getY());this.canvas.lineTo(f.getX(),f.getY());this.canvas.stroke()};Grape2D.CanvasRenderer.prototype.renderText=function(a,b){this.canvas.strokeText(a,b.getX(),b.getY())};
Grape2D.CanvasRenderer.prototype.start=function(){this.canvas.clear()};Grape2D.CanvasRenderer.prototype.end=function(){};Grape2D.CanvasRenderer.prototype.appendToDOMElement=function(a){this.canvas.appendOn(a)};Grape2D.CanvasRenderer.prototype.getDOMElement=function(){return this.canvas.canvas};Grape2D.CanvasRenderer.prototype.getContext=function(){return this.canvas.context};Grape2D.CanvasRenderer.prototype.setStrokeColor=function(a){this.canvas.setStrokeStyle(a)};
Grape2D.CanvasRenderer.prototype.setFillColor=function(a){this.canvas.setFillStyle(a)};Grape2D.CanvasRenderer.prototype.renderParticle=function(a,b){var c=b.wcsToViewport(this,a.getPosition());this.canvas.beginPath();this.canvas.arc(c.x,c.y,1,0,Grape2D.Math.PIx2,!1);this.canvas.fill()};Grape2D.WireframeRenderer=function(a){this.renderer=a};Grape2D.WireframeRenderer.prototype=Object.create(Grape2D.Renderer.prototype);Grape2D.WireframeRenderer.prototype.getWidth=function(){return this.renderer.getWidth()};Grape2D.WireframeRenderer.prototype.getHalfWidth=function(){return this.renderer.getHalfWidth()};Grape2D.WireframeRenderer.prototype.setWidth=function(a){this.renderer.setWidth(a)};Grape2D.WireframeRenderer.prototype.getHeight=function(){return this.renderer.getHeight()};
Grape2D.WireframeRenderer.prototype.getHalfHeight=function(){return this.renderer.getHalfHeight()};Grape2D.WireframeRenderer.prototype.setHeight=function(a){this.renderer.setHeight(a)};Grape2D.WireframeRenderer.prototype.renderTexture=function(a,b){this.renderer.renderTexture(a,b)};Grape2D.WireframeRenderer.prototype.renderObject2D=function(a,b){var c=b.wcsToViewport(this,a.getPosition());this.renderer.canvas.fillRect(c.x,c.y,2,2);a.getBoundingBox().render(this,b)};
Grape2D.WireframeRenderer.prototype.renderImage=function(a,b,c,d,f,e,g,k,h){this.renderer.renderImage(a,b,c,d,f,e,g,k,h)};Grape2D.WireframeRenderer.prototype.renderAABB=function(a,b){this.renderer.renderAABB(a,b)};Grape2D.WireframeRenderer.prototype.renderCircle=function(a,b){this.renderer.renderCircle(a,b)};Grape2D.WireframeRenderer.prototype.renderPolygon=function(a,b){this.renderer.renderPolygon(a,b)};Grape2D.WireframeRenderer.prototype.renderText=function(a,b){this.renderer.renderText(a,b)};
Grape2D.WireframeRenderer.prototype.start=function(){this.renderer.start()};Grape2D.WireframeRenderer.prototype.end=function(){this.renderer.end()};Grape2D.WireframeRenderer.prototype.appendToDOMElement=function(a){this.renderer.appendToDOMElement(a)};Grape2D.WireframeRenderer.prototype.getDOMElement=function(){return this.renderer.getDOMElement()};Grape2D.WireframeRenderer.prototype.setStrokeColor=function(a){this.renderer.setStrokeColor(a)};Grape2D.WireframeRenderer.prototype.setFillColor=function(a){this.renderer.setFillColor(a)};
Grape2D.WireframeRenderer.prototype.renderParticle=function(a,b){this.renderer.renderParticle(a,b)};Grape2D.Object2D=function(a){this.position=a.position||new Grape2D.Vector;this.visible=a.visible||!0;this.texture=a.texture;this.textureOffset=a.textureOffset||new Grape2D.Vector;this.texturePosition=new Grape2D.Vector;this.computeTexturePosition();this.boundingBox=a.boundingBox;this.boundingBoxOffset=a.boundingBoxOffset||new Grape2D.Vector;this.computeBoundingBoxPosition();this.castShadow=a.castShadow||!1;this.receiveLight=a.receiveLight||!1};
Grape2D.Object2D.prototype={constructor:Grape2D.Object2D,isVisible:function(){return this.visible},setVisible:function(a){this.visible=a},getTexture:function(){return this.texture},setTexture:function(a){this.texture=a},getBoundingBox:function(){return this.boundingBox},setBoundingBox:function(a){this.boundingBox=a;this.computeBoundingBoxPosition()},canCastShadow:function(){return this.castShadow},setCastShadow:function(a){this.castShadow=a},canReceiveLight:function(){return this.receiveLight},setReceiveLight:function(a){this.receiveLight=
a},getPosition:function(){return this.position},setPosition:function(a){this.position.set(a);this.computeBoundingBoxPosition();this.computeTexturePosition()},setTextureOffset:function(a){this.textureOffset.set(a);this.computeTexturePosition()},getTextureOffset:function(){return this.textureOffset},setBoundingBoxOffset:function(a){this.boundingBoxOffset.set(a);this.computeBoundingBoxPosition()},getBoundingBoxOffset:function(){return this.boundingBoxOffset},computeBoundingBoxPosition:function(){this.boundingBox.setPosition(this.position);
this.boundingBox.getPosition().add(this.boundingBoxOffset)},getBoundingBoxPosition:function(){return this.boundingBox.getPosition()},computeTexturePosition:function(){this.texturePosition.set(this.position).add(this.textureOffset)},getTexturePosition:function(){return this.texturePosition},render:function(a,b){a.renderObject2D(this,b)},update:function(a,b){}};Grape2D.Shape=function(a){a=a||{};this.position=a.position||new Grape2D.Vector};Grape2D.Shape.prototype={constructor:Grape2D.Shape,getPosition:function(){return this.position},setPosition:function(a){this.position.set(a)},render:function(a,b){},createBV:function(a){},getStaticType:function(){}};Grape2D.AABB=function(a){Grape2D.Shape.call(this,a);this.min=new Grape2D.Vector;this.max=new Grape2D.Vector;if(a.width&&a.height)this.setWidth(a.width),this.setHeight(a.height);else{var b=this.getPosition();this.min.setX(a.minX);this.min.setY(a.minY);this.max.setX(a.maxX);this.max.setY(a.maxY);b.setX(a.minX+(this.max.getX()-this.min.getX())/2);b.setY(a.minY+(this.max.getY()-this.min.getY())/2)}};Grape2D.AABB.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.AABB.prototype.getMin=function(){return this.min};
Grape2D.AABB.prototype.getMinX=function(){return this.min.getX()};Grape2D.AABB.prototype.getMinY=function(){return this.min.getY()};Grape2D.AABB.prototype.getMax=function(){return this.max};Grape2D.AABB.prototype.getMaxX=function(){return this.max.getX()};Grape2D.AABB.prototype.getMaxY=function(){return this.max.getY()};Grape2D.AABB.prototype.getWidth=function(){return Grape2D.Math.abs(this.max.getX()-this.min.getX())};
Grape2D.AABB.prototype.getHeight=function(){return Grape2D.Math.abs(this.max.getY()-this.min.getY())};Grape2D.AABB.prototype.getHalfWidth=function(){return this.getWidth()/2};Grape2D.AABB.prototype.getHalfHeight=function(){return this.getHeight()/2};Grape2D.AABB.prototype.setWidth=function(a){a/=2;this.min.setX(this.getPosition().getX()-a);this.max.setX(this.getPosition().getX()+a)};
Grape2D.AABB.prototype.setHeight=function(a){a/=2;this.min.setY(this.getPosition().getY()-a);this.max.setY(this.getPosition().getY()+a)};Grape2D.AABB.prototype.render=function(a,b){a.renderAABB(this,b)};Grape2D.AABB.prototype.createBV=function(a){return a.createFromAABB(this)};Grape2D.AABB.prototype.getStaticType=function(){return Grape2D.AABB.TYPE};Grape2D.AABB.TYPE="AABB";Grape2D.Circle=function(a){Grape2D.Shape.call(this,a);this.radius=a.radius};Grape2D.Circle.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.Circle.prototype.getRadius=function(){return this.radius};Grape2D.Circle.prototype.setRadius=function(a){this.radius=a};Grape2D.Circle.prototype.render=function(a,b){a.renderCircle(this,b)};Grape2D.Circle.prototype.createBV=function(a){return a.createFromCircle(this)};Grape2D.Circle.prototype.getStaticType=function(){return Grape2D.Circle.TYPE};
Grape2D.Circle.TYPE="Circle";Grape2D.Polygon=function(a){Grape2D.Shape.call(this,a);this.vertexList=a.vertexList;this.computedVertexList=[];this.computeVertexList()};Grape2D.Polygon.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.Polygon.prototype.getVertexList=function(){return this.vertexList};Grape2D.Polygon.prototype.setVertexList=function(a){this.vertexList=a;this.computeVertexList()};Grape2D.Polygon.prototype.getComputedVertexList=function(){return this.computedVertexList};
Grape2D.Polygon.prototype.render=function(a,b){a.renderPolygon(this,b)};Grape2D.Polygon.prototype.createBV=function(a){return a.createFromPolygon(this)};Grape2D.Polygon.prototype.getStaticType=function(){return Grape2D.Polygon.TYPE};Grape2D.Polygon.prototype.computeVertexList=function(){this.computedVertexList=[];for(var a=0;a<this.vertexList.length;a++)this.computedVertexList.push(this.getPosition().clone().add(this.vertexList[a]))};
Grape2D.Polygon.prototype.setPosition=function(a){Grape2D.Shape.prototype.setPosition.call(this,a);this.computeVertexList()};Grape2D.Polygon.TYPE="Polygon";Grape2D.Particle=function(a){Grape2D.Shape.call(this,a);this.velocity=a.velocity||new Grape2D.Vector;this.acceleration=a.acceleration||new Grape2D.Vector;this.lifeTime=a.lifeTime||250};Grape2D.Particle.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.Particle.prototype.getVelocity=function(){return this.velocity};Grape2D.Particle.prototype.setVelocity=function(a){this.velocity.set(a)};Grape2D.Particle.prototype.getAcceleration=function(){return this.velocity};
Grape2D.Particle.prototype.setAcceleration=function(a){this.acceleration.set(a)};Grape2D.Particle.prototype.getLifeTime=function(){return this.lifeTime};Grape2D.Particle.prototype.setLifeTime=function(a){this.lifeTime=a};Grape2D.Particle.prototype.render=function(a,b){a.renderParticle(this,b)};Grape2D.Particle.prototype.isAlive=function(){return 0<this.lifeTime};Grape2D.Particle.prototype.isDead=function(){return 0>=this.lifeTime};
Grape2D.Particle.prototype.revive=function(a,b,c){this.position.set(a);this.velocity.set(b);this.lifeTime=c;this.acceleration.reset()};Grape2D.Particle.prototype.submitToFields=function(a){for(var b=new Grape2D.Vector,c=0;c<a.length;c++)b.add(a[c].computeAcceleration(this.position));this.acceleration.set(b)};
Grape2D.Particle.prototype.update=function(a,b){this.velocity.setX(this.velocity.getX()+this.acceleration.getX()*a);this.velocity.setY(this.velocity.getY()+this.acceleration.getY()*a);this.position.setX(this.position.getX()+this.velocity.getX()*a);this.position.setY(this.position.getY()+this.velocity.getY()*a);this.lifeTime-=a};Grape2D.ParticleSystem=function(){Grape2D.Object2D.call(this,{texture:new Grape2D.VoidTexture,boundingBox:new Grape2D.AABB({width:0,height:0})});this.emitters=[];this.fields=[];this.miny=this.minx=Infinity;this.maxy=this.maxx=-Infinity};Grape2D.ParticleSystem.prototype=Object.create(Grape2D.Object2D.prototype);Grape2D.ParticleSystem.prototype.addEmitter=function(a){a.setParticleSystem(this);this.emitters.push(a)};
Grape2D.ParticleSystem.prototype.removeEmitter=function(a){this.emitters.splice(this.emitters.indexOf(a),1)};Grape2D.ParticleSystem.prototype.getEmitters=function(){return this.emitters};Grape2D.ParticleSystem.prototype.addField=function(a){this.fields.push(a)};Grape2D.ParticleSystem.prototype.removeField=function(a){this.fields.splice(this.fields.indexOf(a),1)};Grape2D.ParticleSystem.prototype.getFields=function(){return this.fields};
Grape2D.ParticleSystem.prototype.update=function(a,b){this.miny=this.minx=Infinity;this.maxy=this.maxx=-Infinity;for(var c=0;c<this.emitters.length;c++)this.emitters[c].update(a,b);var c=this.maxx-this.minx,d=this.maxy-this.miny,f=new Grape2D.Vector(this.minx+c/2,this.miny+d/2),e=this.getBoundingBox();e.setWidth(c);e.setHeight(d);e.setPosition(f)};
Grape2D.ParticleSystem.prototype.submitParticle=function(a){var b=a.getPosition().getX();a=a.getPosition().getY();this.minx>b&&(this.minx=b);this.miny>a&&(this.miny=a);this.maxx<b&&(this.maxx=b);this.maxy<a&&(this.maxy=a)};Grape2D.ParticleSystem.prototype.getPosition=function(){return this.getBoundingBox().getPosition()};Grape2D.ParticleSystem.prototype.render=function(a,b){for(var c=0;c<this.emitters.length;c++)this.emitters[c].render(a,b);this.getBoundingBox().render(a,b)};Grape2D.Emitter=function(a){this.position=a.position;this.velocity=a.velocity;this.vAngle=this.velocity.getAngle();this.vMagnitude=this.velocity.getMagnitude();this.speedVariation=a.speedVariation||0;this.spread=a.spread||0;this.particleLife=a.particleLife||200;this.particleLifeVariation=a.particleLifeVariation||0;this.maxParticles=a.maxParticles;this.rate=a.rate||60;this.mrate=this.rate/1E3;this.particles=[];this.createParticles();this.particleSystem=null;this.renderedParticles=0};
Grape2D.Emitter.prototype={constructor:Grape2D.Emitter,getPosition:function(){return this.position},setPosition:function(a){this.position.set(a)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.set(a)},getSpeedVariation:function(){return this.speedVariation},setSpeedVariation:function(a){this.speedVariation=a},getSpread:function(){return this.spread},setSpread:function(a){this.spread=a},getParticleLife:function(){return this.particleLife},setParticleLife:function(a){this.particleLife=
a},getParticleLifeVariation:function(){return this.particleLifeVariation},setParticleLifeVariation:function(a){this.particleLifeVariation=a},getRate:function(){return this.rate},setRate:function(a){this.rate=a},getParticles:function(){return this.particles},getParticleSystem:function(){return this.particleSystem},setParticleSystem:function(a){this.particleSystem=a},getRenderedParticles:function(){return this.renderedParticles},createParticles:function(){for(var a=0;a<this.maxParticles;a++)this.particles.push(new Grape2D.Particle({position:this.position.clone(),
velocity:Grape2D.Vector.createFromAngle(this.vAngle+Grape2D.Math.randFloat(-this.spread,this.spread),this.vMagnitude+Grape2D.Math.randFloat(-this.speedVariation,this.speedVariation)),lifeTime:-1}))},reviveParticle:function(a){a.revive(this.position,Grape2D.Vector.createFromAngle(this.vAngle+Grape2D.Math.randFloat(-this.spread,this.spread),this.vMagnitude+Grape2D.Math.randFloat(-this.speedVariation,this.speedVariation)),this.particleLife+Grape2D.Math.randInt(-this.particleLifeVariation,this.particleLifeVariation))},
update:function(a,b){for(var c=Grape2D.Math.floor(this.mrate*a),d=this.particleSystem.getFields(),f,e=0;e<this.particles.length;e++)f=this.particles[e],f.isDead()?0<=c&&(this.reviveParticle(f),c--,this.particleSystem.submitParticle(f)):(f.submitToFields(d),f.update(a,b),this.particleSystem.submitParticle(f))},render:function(a,b){for(var c=this.renderedParticles=0;c<this.particles.length;c++)this.particles[c].isAlive()&&(this.particles[c].render(a,b),this.renderedParticles++)}};Grape2D.Field=function(a){this.mass=a.mass;this.position=a.position};Grape2D.Field.prototype={constructor:Grape2D.Field,getMass:function(){return this.mass},setMass:function(a){this.mass=a},getPosition:function(){return this.position},setPosition:function(a){this.position.set(a)},computeAcceleration:function(a){a=this.position.clone().sub(a);var b=this.mass/Grape2D.Math.pow(Grape2D.Math.sq(a.getX())+Grape2D.Math.sq(a.getY())+this.mass,1.5);return a.multiplyByScalar(b)}};Grape2D.InputManager=function(a){this.mouseUp=[];this.mouseDown=[];this.mouseMove=[];this.mouseOver=[];this.mouseOut=[];this.mouseWheel=[];this.click=[];this.drag=[];this.dragStart=new Grape2D.Vector;this.isDragging=!1;this.resize=[];this.keyDown={};this.keyUp={};this.keyPress={};this.rendererBinding=a;this.bindToRenderer(a)};
Grape2D.InputManager.prototype={constructor:Grape2D.InputManager,bindToRenderer:function(a){this.rendererBinding=a;a=this.rendererBinding.getDOMElement();var b=this;a.addEventListener("mouseup",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseUp),!1);a.addEventListener("mousedown",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseDown),!1);a.addEventListener("mousemove",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseMove),!1);a.addEventListener("mouseover",Grape2D.InputManager.bindFn(this.rendererBinding,
this.mouseOver),!1);a.addEventListener("mouseout",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseOut),!1);a.addEventListener("mousewheel",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseWheel),!1);a.addEventListener("click",Grape2D.InputManager.bindFn(this.rendererBinding,this.click),!1);this.addMouseDown(function(a){b.dragStart.set(a.getPosition());b.isDragging=!0});this.addMouseMove(function(a){if(b.isDragging){var d=new Grape2D.Vector(a.getRaw().pageX,a.getRaw().pageY);a=
new Grape2D.InputManagerDragEvent(a.getRaw(),b.dragStart);for(var f=b.getDragBindStack(),e=0;e<f.length;e++)f[e](a);b.dragStart.set(d)}});this.addMouseUp(function(a){b.isDragging=!1});this.addMouseOut(function(a){b.isDragging=!1})},getMouseUpBindStack:function(){return this.mouseUp},addMouseUp:function(a){this.mouseUp.push(a)},removeMouseUp:function(a){0<=this.mouseUp.indexOf(a)&&this.mouseUp.splice(this.mouseUp.indexOf(a),1)},getMouseDownBindStack:function(){return this.mouseDown},addMouseDown:function(a){this.mouseDown.push(a)},
removeMouseDown:function(a){0<=this.mouseDown.indexOf(a)&&this.mouseDown.splice(this.mouseDown.indexOf(a),1)},getMouseMoveBindStack:function(){return this.mouseMove},addMouseMove:function(a){this.mouseMove.push(a)},removeMouseMove:function(a){0<=this.mouseMove.indexOf(a)&&this.mouseMove.splice(this.mouseMove.indexOf(a),1)},getMouseOverBindStack:function(){return this.mouseOver},addMouseOver:function(a){this.mouseOver.push(a)},removeMouseOver:function(a){0<=this.mouseOver.indexOf(a)&&this.mouseOver.splice(this.mouseOver.indexOf(a),
1)},getMouseOutBindStack:function(){return this.mouseOut},addMouseOut:function(a){this.mouseOut.push(a)},removeMouseOut:function(a){0<=this.mouseOut.indexOf(a)&&this.mouseOut.splice(this.mouseOut.indexOf(a),1)},getMouseWheelBindStack:function(){return this.mouseWheel},addMouseWheel:function(a){this.mouseWheel.push(a)},removeMouseWheel:function(a){0<=this.mouseWheel.indexOf(a)&&this.mouseWheel.splice(this.mouseWheel.indexOf(a),1)},getResizeBindStack:function(){return this.resize},addResize:function(a){this.resize.push(a);
Grape2D.InputManager.registerGlobalResize(a)},removeResize:function(a,b){0<=this.resize.indexOf(b)&&this.resize.splice(this.resize.indexOf(b),1);Grape2D.InputManager.unregisterGlobalResize(b)},getKeyDownBindStack:function(){return this.keyDown},addKeyDown:function(a,b){this.keyDown[a]||(this.keyDown[a]=[]);this.keyDown[a].push(b);Grape2D.InputManager.registerGlobalKeyDown(a,b)},removeKeyDown:function(a,b){if(this.keyDown[a]){var c=this.keyDown[a].indexOf(b);0<=c&&(this.keyDown[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyDown(a,
b))}},getKeyUpBindStack:function(){return this.keyDown},addKeyUp:function(a,b){this.keyUp[a]||(this.keyUp[a]=[]);this.keyUp[a].push(b);Grape2D.InputManager.registerGlobalKeyUp(a,b)},removeKeyUp:function(a,b){if(this.keyUp[a]){var c=this.keyUp[a].indexOf(b);0<=c&&(this.keyUp[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyUp(a,b))}},getKeyPressBindStack:function(){return this.keyPress},addKeyPress:function(a,b){this.keyPress[a]||(this.keyPress[a]=[]);this.keyPress[a].push(b);Grape2D.InputManager.registerGlobalKeyPress(a,
b)},removeKeyPress:function(a,b){if(this.keyPress[a]){var c=this.keyPress[a].indexOf(b);0<=c&&(this.keyPress[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyPress(a,b))}},getDragBindStack:function(){return this.drag},addDrag:function(a){this.drag.push(a)},removeDrag:function(a){0<=this.drag.indexOf(a)&&this.drag.splice(this.drag.indexOf(a),1)},getClickBindStack:function(){return this.click},addClick:function(a){this.click.push(a)},removeClick:function(a){0<=this.click.indexOf(a)&&this.click.splice(this.click.indexOf(a),
1)}};Grape2D.InputManager.bindFn=function(a,b){return function(a){var d=0;for(a=new Grape2D.InputManagerMouseEvent(a);d<b.length;d++)b[d](a)}};Grape2D.InputManager.registerGlobalResize=function(a){Grape2D.InputManager.globalRegistry.resize.push(a)};Grape2D.InputManager.unregisterGlobalResize=function(a){a=Grape2D.InputManager.globalRegistry.resize.indexOf(a);0<=a&&Grape2D.InputManager.globalRegistry.resize.splice(a,1)};
Grape2D.InputManager.registerGlobalKeyDown=function(a,b){Grape2D.InputManager.globalRegistry.keyDown[a]||(Grape2D.InputManager.globalRegistry.keyDown[a]=[]);Grape2D.InputManager.globalRegistry.keyDown[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyDown=function(a,b){if(Grape2D.InputManager.globalRegistry.keyDown[a]){var c=Grape2D.InputManager.globalRegistry.keyDown[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyDown[a].splice(c,1)}};
Grape2D.InputManager.registerGlobalKeyUp=function(a,b){Grape2D.InputManager.globalRegistry.keyUp[a]||(Grape2D.InputManager.globalRegistry.keyUp[a]=[]);Grape2D.InputManager.globalRegistry.keyUp[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyUp=function(a,b){if(Grape2D.InputManager.globalRegistry.keyUp[a]){var c=Grape2D.InputManager.globalRegistry.keyUp[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyUp[a].splice(c,1)}};
Grape2D.InputManager.registerGlobalKeyPress=function(a,b){Grape2D.InputManager.globalRegistry.keyPress[a]||(Grape2D.InputManager.globalRegistry.keyPress[a]=[]);Grape2D.InputManager.globalRegistry.keyPress[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyPress=function(a,b){if(Grape2D.InputManager.globalRegistry.keyPress[a]){var c=Grape2D.InputManager.globalRegistry.keyPress[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyPress[a].splice(c,1)}};
Grape2D.InputManager.keyDispatcher=function(a){return function(b){var c=b.keyCode;if(a[c])for(var d=0;d<a[c].length;d++)a[c][d](b)}};Grape2D.InputManager.resizeDispatcher=function(){return function(a){for(var b=0;b<Grape2D.InputManager.globalRegistry.resize.length;b++)Grape2D.InputManager.globalRegistry.resize[b](a)}};
Grape2D.InputManager.setupGlobals=function(){window.addEventListener("resize",Grape2D.InputManager.resizeDispatcher(),!1);window.addEventListener("keyup",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyUp),!1);window.addEventListener("keydown",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyDown),!1);window.addEventListener("keypress",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyPress),!1)};
Grape2D.InputManager.globalRegistry={resize:[],keyDown:{},keyUp:{},keyPress:{}};
Grape2D.InputManager.KEY={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Backspace:8,Tab:9,Enter:13,SHIFT:16,CTRL:17,ALT:18,META:91,META_RIGHT:93,
"Caps Lock":20,Esc:27,Spacebar:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,"Num Lock":144,ScrLk:145,"Pause/Break":19};Grape2D.InputManager.setupGlobals();Grape2D.InputManagerEvent=function(a){this.raw=a};Grape2D.InputManagerEvent.prototype={constructor:Grape2D.InputManagerEvent,getRaw:function(){return this.raw}};Grape2D.InputManagerMouseEvent=function(a){Grape2D.InputManagerEvent.call(this,a);var b=a.target.getBoundingClientRect();this.target=a.target;this.position=new Grape2D.Vector(a.clientX-b.left,a.clientY-b.top);this.button=a.button;this.wheelDelta=0;"mousewheel"==a.type&&(this.wheelDelta=a.wheelDelta)};Grape2D.InputManagerMouseEvent.prototype=Object.create(Grape2D.InputManagerEvent.prototype);Grape2D.InputManagerMouseEvent.prototype.getTarget=function(){return this.target};
Grape2D.InputManagerMouseEvent.prototype.getPosition=function(){return this.position};Grape2D.InputManagerMouseEvent.prototype.getWheelDelta=function(){return this.wheelDelta};Grape2D.InputManagerDragEvent=function(a,b){Grape2D.InputManagerEvent.call(this,a);var c=a.target.getBoundingClientRect();this.target=a.target;this.start=(new Grape2D.Vector).set(b);this.end=new Grape2D.Vector(a.clientX-c.left,a.clientY-c.top);this.delta=this.end.clone().sub(this.start)};Grape2D.InputManagerDragEvent.prototype=Object.create(Grape2D.InputManagerEvent.prototype);Grape2D.InputManagerDragEvent.prototype.getTarget=function(){return this.target};
Grape2D.InputManagerDragEvent.prototype.getStart=function(){return this.start};Grape2D.InputManagerDragEvent.prototype.getEnd=function(){return this.end};Grape2D.InputManagerDragEvent.prototype.getDelta=function(){return this.delta};Grape2D.Camera=function(a){a=a||{};this.rscale=new Grape2D.Vector(1,1);this.scale=a.scale||new Grape2D.Vector(1,1);this.lookAt=a.lookAt||new Grape2D.Vector;this.transformation=a.transformation||new Grape2D.Matrix;this.cM=new Grape2D.Matrix;this.icM=new Grape2D.Matrix;this.computeMatrix()};
Grape2D.Camera.prototype={constructor:Grape2D.Camera,computeMatrix:function(){this.cM=this.transformation.clone();this.cM.v[0]*=this.scale.getX()*this.rscale.getX();this.cM.v[1]*=this.scale.getX()*this.rscale.getX();this.cM.v[2]*=this.scale.getX()*this.rscale.getX();this.cM.v[3]*=this.scale.getY()*this.rscale.getY();this.cM.v[4]*=this.scale.getY()*this.rscale.getY();this.cM.v[5]*=this.scale.getY()*this.rscale.getY();this.icM=this.cM.clone().invert()},wcsToViewport:function(a,b){var c=this.cM.multiplyByVector(b.clone().sub(this.lookAt));
c.setX(c.getX()+a.getHalfWidth());c.setY(c.getY()+a.getHalfHeight());return c},viewportToWcs:function(a,b){var c=b.clone();c.setX(c.getX()-a.getHalfWidth());c.setY(c.getY()-a.getHalfHeight());return c=this.icM.multiplyByVector(c).sub(this.lookAt)},rescale:function(a){this.rscale.setX(a.getX()/this.scale.getX());this.rscale.setY(a.getY()/this.scale.getY());this.computeMatrix()},setLookAt:function(a){this.lookAt.set(a)},getLookAt:function(){return this.lookAt},getScale:function(){return this.scale},
computeShape:function(a){var b=(new Grape2D.Vector).set(this.lookAt),c=a.getWidth()/this.scale.getX();a=a.getHeight()/this.scale.getY();return new Grape2D.AABB({position:b,width:c,height:a})}};Grape2D.AliasingCamera=function(a){Grape2D.Camera.call(this,a)};Grape2D.AliasingCamera.prototype=Object.create(Grape2D.Camera.prototype);Grape2D.AliasingCamera.prototype.wcsToViewport=function(a,b){return Grape2D.Camera.prototype.wcsToViewport.call(this,a,b).use(Grape2D.Math.floor)};Grape2D.Map=function(){};Grape2D.Map.prototype={constructor:Grape2D.Map,add:function(a){},remove:function(a){},query:function(a){},queryPoint:function(a){},clear:function(){},update:function(a,b){},rebuild:function(){}};Grape2D.SimpleMap=function(){this.objs=[]};Grape2D.SimpleMap.prototype=Object.create(Grape2D.Map);Grape2D.SimpleMap.prototype.add=function(a){this.objs.push(a)};Grape2D.SimpleMap.prototype.remove=function(a){this.objs.splice(this.objs.indexOf(a),1)};Grape2D.SimpleMap.prototype.query=function(a){return this.objs};Grape2D.SimpleMap.prototype.queryPoint=function(a){return this.objs};Grape2D.SimpleMap.prototype.clear=function(){this.objs=[]};
Grape2D.SimpleMap.prototype.update=function(a,b){for(var c=0;c<this.objs.length;c++)this.objs[c].update(a,b)};Grape2D.SimpleMap.prototype.rebuild=function(){};Grape2D.CollisionChecker=function(){};
Grape2D.CollisionChecker.prototype={constructor:Grape2D.CollisionChecker,aabbVsAabb:function(a,b){},aabbVsCircle:function(a,b){},aabbVsPolygon:function(a,b){},aabbVsPoint:function(a,b){},aabbVsRay:function(a,b,c,d){},circleVsAabb:function(a,b){},circleVsCircle:function(a,b){},circleVsPolygon:function(a,b){},circleVsPoint:function(a,b){},circleVsRay:function(a,b,c,d){},polygonVsAabb:function(a,b){},polygonVsCircle:function(a,b){},polygonVsPolygon:function(a,b){},polygonVsPoint:function(a,b){},polygonVsRay:function(a,
b,c,d){}};Grape2D.GenericCollisionChecker=function(){};Grape2D.GenericCollisionChecker.prototype=Object.create(Grape2D.CollisionChecker);Grape2D.GenericCollisionChecker.prototype.aabbVsAabb=function(a,b){return 0<=Grape2D.Math.overlaps({min:a.getMinX(),max:a.getMaxX()},{min:b.getMinX(),max:b.getMaxX()})&&0<=Grape2D.Math.overlaps({min:a.getMinY(),max:a.getMaxY()},{min:b.getMinY(),max:b.getMaxY()})};
Grape2D.GenericCollisionChecker.prototype.aabbVsPoint=function(a,b){return a.getMinX()<=b.getX()&&a.getMaxX()>=b.getX()&&a.getMinY()<=b.getY()&&a.getMaxY()>=b.getY()};Grape2D.GenericCollisionChecker.prototype.aabbVsCircle=function(a,b){var c=Grape2D.Math.clamp(b.getPosition().getX(),a.getMinX(),a.getMaxX()),d=Grape2D.Math.clamp(b.getPosition().getY(),a.getMinY(),a.getMaxY());return Grape2D.Math.sq(b.getPosition().getX()-c)+Grape2D.Math.sq(b.getPosition().getY()-d)<=Grape2D.Math.sq(b.getRadius())};
Grape2D.GenericCollisionChecker.prototype.circleVsAabb=function(a,b){return this.aabbVsCircle(b,a)};Grape2D.GenericCollisionChecker.prototype.aabbVsRay=function(a,b,c,d){return!1};Grape2D.GenericCollisionChecker.prototype.circleVsRay=function(a,b,c,d){return!1};Grape2D.GenericCollisionChecker.prototype.polygonVsRay=function(a,b,c,d){return!1};
Grape2D.GenericCollisionChecker.prototype.circleVsCircle=function(a,b){return Grape2D.Math.sqrt(Grape2D.Math.sq(b.getPosition().getX()-a.getPosition().getX())+Grape2D.Math.sq(b.getPosition().getY()-a.getPosition().getY()))<=a.getRadius()+b.getRadius()};Grape2D.GenericCollisionChecker.prototype.circleVsPoint=function(a,b){return Grape2D.Math.sqrt(Grape2D.Math.sq(a.getPosition().getX()-b.getX())+Grape2D.Math.sq(a.getPosition().getY()-b.getY()))<=a.getRadius()};
Grape2D.GenericCollisionChecker.prototype.polygonVsAabb=function(a,b){return this.aabbVsPolygon(b,a)};Grape2D.GenericCollisionChecker.prototype.polygonVsCircle=function(a,b){return this.circleVsPolygon(b,a)};Grape2D.GenericCollisionChecker.prototype.aabbVsPolygon=function(a,b){return!1};
Grape2D.GenericCollisionChecker.prototype.circleVsPolygon=function(a,b){for(var c=b.getComputedVertexList(),d=a.getPosition(),f=Grape2D.Math.sq(a.getRadius()),e=0;e<c.length;e++)if(c[e].sqDistanceTo(d)>=f)return!0;return!1};Grape2D.GenericCollisionChecker.prototype.polygonVsPolygon=function(a,b){return!1};
Grape2D.GenericCollisionChecker.prototype.polygonVsPoint=function(a,b){var c=a.getVertexList(),d=[],f,e;d.push(c[0].clone().sub(b));for(f=0;f<d.length;++f)if(e=(f+1)%d.length,0<e&&d.push(c[e].clone().sub(b)),d[e].getX()*d[f].getY()-d[f].getX()*d[e].getY())return!1;return!0};Grape2D.SATCollisionChecker=function(){};Grape2D.SATCollisionChecker.prototype=Object.create(Grape2D.GenericCollisionChecker.prototype);Grape2D.SATCollisionChecker.prototype.aabbVsPolygon=function(a,b){var c=new Grape2D.Polygon({vertexList:Grape2D.SATCollisionChecker.aabbToVertexList(a)});return this.polygonVsPolygon(c,b)};
Grape2D.SATCollisionChecker.prototype.polygonVsPolygon=function(a,b){for(var c=this.computeAxis(a),d=this.computeAxis(b),c=this.selectAxis(c,d),d=this.computeIntervals(a.getComputedVertexList(),c),f=this.computeIntervals(b.getComputedVertexList(),c),e,g=0;g<c.length;g++)if(e=Grape2D.Math.overlaps(d[g],f[g]),0>e)return!1;return!0};
Grape2D.SATCollisionChecker.prototype.computeAxis=function(a){var b=[];a=a.getComputedVertexList();var c,d;for(d=0;d<a.length;d++)c=(d+1)%a.length,b.push(Grape2D.Vector.createFromPoints(a[d],a[c]).normalize().rightNormal());return b};Grape2D.SATCollisionChecker.prototype.selectAxis=function(a,b){for(var c=[],d,f=0;f<a.length;f++)c.push(a[f]);f=0;for(d=!0;f<b.length;f++,d=!0){for(var e=0;e<a.length;e++)if(c[e].isParallelTo(b[f])){d=!1;break}d&&c.push(b[f])}return c};
Grape2D.SATCollisionChecker.prototype.computeIntervals=function(a,b){for(var c=[],d=Infinity,f=-Infinity,e,g,k=0;k<b.length;k++){for(var d=Infinity,f=-Infinity,h=0;h<a.length;h++)e=a[h].dot(b[k]),g=a[(h+1)%a.length].dot(b[k]),e>f&&(f=e),e<d&&(d=e),g>f&&(f=g),g<d&&(d=e);c.push({min:d,max:f})}return c};
Grape2D.SATCollisionChecker.prototype.aabbVsRay=function(a,b,c,d){d=d.rightNormal();for(var f=Infinity,e=-Infinity,g,k=Grape2D.SATCollisionChecker.aabbToVertexList(a),h=0;h<k.length;h++)g=k[h].dot(d),g>e?e=g:g<f&&(f=g);return f<=g&&g<=e?0<=Grape2D.Math.overlaps({min:b.getX(),max:c.getX()},{min:a.getMinX(),max:a.getMaxX()})&&0<=Grape2D.Math.overlaps({min:b.getY(),max:c.getY()},{min:a.getMinY(),max:a.getMaxY()}):!1};
Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST=[new Grape2D.Vector,new Grape2D.Vector,new Grape2D.Vector,new Grape2D.Vector];
Grape2D.SATCollisionChecker.aabbToVertexList=function(a){Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[0].setX(a.getMinX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[0].setY(a.getMinY());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[1].setX(a.getMinX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[1].setY(a.getMaxY());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[2].setX(a.getMaxX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[2].setY(a.getMinY());
Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[3].setX(a.getMaxX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[3].setY(a.getMaxY());return Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST};
Grape2D.SATCollisionChecker.prototype.circleVsRay=function(a,b,c,d){var f=d.rightNormal();d=a.getPosition();var e=a.getRadius();a=d.dot(f);f=b.dot(f);return a-e<=f&&f<=a+e?(d.getX(),d.getX(),0<=Grape2D.Math.overlaps({min:b.getX(),max:c.getX()},{min:d.getX()-e,max:d.getX()+e})&&0<=Grape2D.Math.overlaps({min:b.getY(),max:c.getY()},{min:d.getY()-e,max:d.getY()+e})):!1};Grape2D.SATCollisionChecker.prototype.polygonVsRay=function(a,b,c,d){return!1};
Grape2D.SATCollisionChecker.aabbAxis=[new Grape2D.Vector(1,0),new Grape2D.Vector(0,1)];Grape2D.CollisionDispatcher={aabbVsAabb:function(a,b,c){return a.aabbVsAabb(b,c)},aabbVsCircle:function(a,b,c){return a.aabbVsCircle(b,c)},aabbVsPolygon:function(a,b,c){return a.aabbVsPolygon(b,c)},aabbVsPoint:function(a,b,c){return a.aabbVsPoint(b,c)},circleVsAabb:function(a,b,c){return a.circleVsAabb(b,c)},circleVsCircle:function(a,b,c){return a.circleVsCircle(b,c)},circleVsPolygon:function(a,b,c){return a.circleVsPolygon(b,c)},circleVsPoint:function(a,b,c){return a.circleVsPoint(b,c)},polygonVsAabb:function(a,
b,c){return a.polygonVsAabb(b,c)},polygonVsCircle:function(a,b,c){return a.polygonVsCircle(b,c)},polygonVsPolygon:function(a,b,c){return a.polygonVsPolygon(b,c)},polygonVsPoint:function(a,b,c){return a.polygonVsPoint(b,c)},dcache:{},dispatch:function(a,b,c){return Grape2D.CollisionDispatcher.dcache[b.getStaticType()][c.getStaticType()](a,b,c)}};
Grape2D.CollisionDispatcher.dcache={AABB:{AABB:Grape2D.CollisionDispatcher.aabbVsAabb,Circle:Grape2D.CollisionDispatcher.aabbVsCircle,Polygon:Grape2D.CollisionDispatcher.aabbVsPolygon,Point:Grape2D.CollisionDispatcher.aabbVsPoint},Circle:{AABB:Grape2D.CollisionDispatcher.circleVsAabb,Circle:Grape2D.CollisionDispatcher.circleVsCircle,Polygon:Grape2D.CollisionDispatcher.circleVsPolygon,Point:Grape2D.CollisionDispatcher.circleVsPoint},Polygon:{AABB:Grape2D.CollisionDispatcher.polygonVsAabb,Circle:Grape2D.CollisionDispatcher.polygonVsCircle,
Polygon:Grape2D.CollisionDispatcher.polygonVsPolygon,Point:Grape2D.CollisionDispatcher.polygonVsPoint}};Grape2D.CollisionCheckerSingleton={instance:new Grape2D.SATCollisionChecker,getCollisionChecker:function(){return Grape2D.CollisionCheckerSingleton.instance},setCollisionChecker:function(a){Grape2D.CollisionCheckerSingleton.instance=a},collide:function(a,b){return Grape2D.CollisionDispatcher.dispatch(Grape2D.CollisionCheckerSingleton.instance,a,b)}};Grape2D.BVHTree=function(){};Grape2D.BVHTree.prototype=Object.create(Grape2D.Map.prototype);Grape2D.TopDownBVHTree=function(a){this.objs=a||[];this.rootNode=null;this.objs.length&&this.rebuild()};Grape2D.TopDownBVHTree.prototype=Object.create(Grape2D.BVHTree.prototype);Grape2D.TopDownBVHTree.prototype.rebuild=function(){this.rootNode=new Grape2D.TopDownBVHNode(null,this.objs)};Grape2D.TopDownBVHTree.prototype.add=function(a){this.objs.push(a)};Grape2D.TopDownBVHTree.prototype.remove=function(a){this.objs.splice(this.objs.indexOf(a),1)};Grape2D.TopDownBVHTree.prototype.query=function(a){return this.rootNode.query(a)};
Grape2D.TopDownBVHTree.prototype.queryPoint=function(a){return this.rootNode.queryPoint(a)};Grape2D.TopDownBVHTree.prototype.clear=function(){this.objs=[];this.rootNode=null};Grape2D.TopDownBVHTree.prototype.update=function(a,b){for(var c=0;c<this.objs.length;c++)this.objs[c].update(a,b)};Grape2D.TopDownBVHTree.MAX_DEPTH=5;Grape2D.TopDownBVHTree.DEFAULT_PER_LEAF=2;Grape2D.TopDownBVHNode=function(a,b){this.bv=Grape2D.BVFactorySingleton.getPlaceHolder();this.leaf=!1;this.objects=[];this.parent=a;this.right=this.left=null;this.depth=a?a.getDepth()+1:0;this.compute(b)};
Grape2D.TopDownBVHNode.prototype={constructor:Grape2D.TopDownBVHNode,compute:function(a){var b;if(a.length<=Grape2D.TopDownBVHTree.DEFAULT_PER_LEAF||this.depth>=Grape2D.TopDownBVHTree.MAX_DEPTH)for(this.leaf=!0,b=0;b<a.length;b++)this.objects.push(a[b]);else{var c=Grape2D.BVHStrategySingleton.getStrategy().solve(a),d=Grape2D.BVFactorySingleton.getFactory();if(c.endState)for(this.leaf=!0,b=0;b<a.length;b++)this.objects.push(a[b]);else{this.bv=d.merge(a[0].getBoundingBox(),a[1].getBoundingBox());for(b=
2;b<a.length;b++)this.bv=d.merge(this.bv,a[b].getBoundingBox());this.left=new Grape2D.TopDownBVHNode(this,c.left);this.right=new Grape2D.TopDownBVHNode(this,c.right)}}},isLeaf:function(){return this.leaf},getBoundingVolume:function(){return this.bv},getParent:function(){return this.parent},getObjects:function(){return this.objects},getLeft:function(){return this.left},getRight:function(){return this.left},query:function(a){var b=[],c;if(this.leaf)for(c=0;c<this.objects.length;c++)Grape2D.CollisionCheckerSingleton.collide(a,
this.objects[c].getBoundingBox())&&b.push(this.objects[c]);else if(Grape2D.CollisionCheckerSingleton.collide(a,this.bv)){var d=this.left.query(a);for(c=0;c<d.length;c++)b.push(d[c]);d=this.right.query(a);for(c=0;c<d.length;c++)b.push(d[c])}return b},getDepth:function(){return this.depth}};Grape2D.BVHStrategy=function(){};Grape2D.BVHStrategy.prototype={constructor:Grape2D.BVHStrategy,solve:function(a){}};Grape2D.MedianCutBVHStrategy=function(){};Grape2D.MedianCutBVHStrategy.prototype=Object.create(Grape2D.BVHStrategy.prototype);
Grape2D.MedianCutBVHStrategy.prototype.solve=function(a){for(var b={left:[],right:[],endState:!1},c=Infinity,d=-Infinity,f=Infinity,e=-Infinity,g=0,k,h=0;h<a.length;h++)k=a[h].getBoundingBoxPosition(),c>k.getX()&&(c=k.getX()),d<k.getX()&&(d=k.getX()),f>k.getY()&&(f=k.getY()),e<k.getY()&&(e=k.getY());if(0===d-c&&0===e-f)return b.endState=!0,b;if(c+d>=f+e)for(g=(d+c)/2,h=0;h<a.length;h++)k=a[h].getBoundingBoxPosition(),k.getX()>g?b.right.push(a[h]):b.left.push(a[h]);else for(g=(e+f)/2,h=0;h<a.length;h++)k=
a[h].getBoundingBoxPosition(),k.getY()>g?b.right.push(a[h]):b.left.push(a[h]);return b};Grape2D.BVHStrategySingleton={strategy:new Grape2D.MedianCutBVHStrategy,setStrategy:function(a){Grape2D.BVHStrategySingleton.strategy=a},getStrategy:function(){return Grape2D.BVHStrategySingleton.strategy}};Grape2D.BVFactory=function(){};Grape2D.BVFactory.prototype={constructor:Grape2D.BVFactory,createFromAABB:function(a){},createFromCircle:function(a){},createFromPolygon:function(a){},createSceneBV:function(a,b){},getPlaceHolder:function(){}};Grape2D.AabbBVFactory=function(){};Grape2D.AabbBVFactory.prototype=Object.create(Grape2D.BVFactory.prototype);Grape2D.AabbBVFactory.prototype.createFromAABB=function(a){return a};Grape2D.AabbBVFactory.prototype.createFromCircle=function(a){var b=2*a.getRadius();return new Grape2D.AABB({position:a.getPosition(),width:b,height:b})};
Grape2D.AabbBVFactory.prototype.createFromPolygon=function(a){var b=Infinity,c=-Infinity,d=Infinity,f=-Infinity;a=a.getVertexList();for(var e,g=0;g<a.length;g++)e=a[g],b>e.getX()&&(b=e.getX()),c<e.getX()&&(c=e.getX()),d>e.getY()&&(d=e.getY()),c<e.getY()&&(f=e.getY());b=c-b;d=f-d;return new Grape2D.AABB({position:new Grape2D.Vector(b/2+b,d/2+d),width:b,height:d})};
Grape2D.AabbBVFactory.prototype.createSceneBV=function(a,b){return new Grape2D.AABB({position:b.getLookAt(),width:a.getWidth()/b.getScale().getX(),height:a.getHeight()/b.getScale().getY()})};Grape2D.AabbBVFactory.prototype.merge=function(a,b){var c=Grape2D.Math.min(a.getMinX(),b.getMinX()),d=Grape2D.Math.max(a.getMaxX(),b.getMaxX()),f=Grape2D.Math.min(a.getMinY(),b.getMinY()),e=Grape2D.Math.max(a.getMaxY(),b.getMaxY());return new Grape2D.AABB({minX:c,minY:f,maxX:d,maxY:e})};
Grape2D.AabbBVFactory.prototype.getPlaceHolder=function(){return Grape2D.AabbBVFactory.PLACE_HOLDER};Grape2D.AabbBVFactory.PLACE_HOLDER=new Grape2D.AABB({width:0,height:0});Grape2D.BVFactorySingleton={bvfactory:new Grape2D.AabbBVFactory,getFactory:function(){return Grape2D.BVFactorySingleton.bvfactory},setFactory:function(a){Grape2D.BVFactorySingleton.bvfactory=a},create:function(a){return a.createBV(Grape2D.BVFactorySingleton.bvfactory)},getPlaceHolder:function(){return Grape2D.BVFactorySingleton.bvfactory.getPlaceHolder()}};Grape2D.ITexture=function(){};Grape2D.ITexture.prototype={constructor:Grape2D.ITexture,getWidth:function(){},getHalfWidth:function(){},setWidth:function(a){},getHeight:function(){},getHalfHeight:function(){},setHeight:function(a){},render:function(a,b){}};Grape2D.Texture=function(a){a=a||{};this.width=2;this.hwidth=1;this.height=2;this.hheight=1;this.buffer=new Grape2D.CanvasRenderer;a.image?this.bufferImage(a.image):a.useTexure&&(this.buffer=a.useTexure)};Grape2D.Texture.prototype=Object.create(Grape2D.ITexture);Grape2D.Texture.prototype.getWidth=function(){return this.width};Grape2D.Texture.prototype.getHeight=function(){return this.height};Grape2D.Texture.prototype.setWidth=function(a){this.width=a;this.hwidth=this.width/2};
Grape2D.Texture.prototype.setHeight=function(a){this.height=a;this.hheight=this.height/2};Grape2D.Texture.prototype.getHalfWidth=function(){return this.hwidth};Grape2D.Texture.prototype.getHalfHeight=function(){return this.hheight};Grape2D.Texture.prototype.getBuffer=function(){return this.buffer.canvas.canvas};
Grape2D.Texture.prototype.bufferImage=function(a){this.setWidth(a.width);this.setHeight(a.height);this.buffer=new Grape2D.CanvasRenderer;this.buffer.renderImage(a,0,0,this.width,this.height,0,0,this.width,this.height)};Grape2D.Texture.prototype.render=function(a,b){a.renderTexture(this,b)};Grape2D.Texture.createFromImage=function(a,b){var c=new Image,d=new Grape2D.Texture;c.onload=function(a){d.bufferImage(this);b&&b(d,this,a)};c.src=a;return d};Grape2D.VoidTexture=function(){};Grape2D.VoidTexture.prototype=Object.create(Grape2D.ITexture);Grape2D.VoidTexture.prototype.getWidth=function(){return 0};Grape2D.VoidTexture.prototype.getHalfWidth=function(){return 0};Grape2D.VoidTexture.prototype.setWidth=function(a){};Grape2D.VoidTexture.prototype.getHeight=function(){return 0};Grape2D.VoidTexture.prototype.getHalfHeight=function(){return 0};Grape2D.VoidTexture.prototype.setHeight=function(a){};Grape2D.VoidTexture.prototype.render=function(){};Grape2D.Scene=function(){};Grape2D.Scene.prototype={constructor:Grape2D.Scene,update:function(a){},render:function(a,b){}};Grape2D.SceneGroup=function(){this.childs=[]};Grape2D.SceneGroup.prototype=Object.create(Grape2D.Scene.prototype);Grape2D.SceneGroup.prototype.update=function(a){for(var b=0;b<this.childs.length;b++)this.childs[b].update(a)};Grape2D.SceneGroup.prototype.render=function(a,b){for(var c=0;c<this.childs.length;c++)this.childs[c].render(a,b)};Grape2D.SceneGroup.prototype.addChild=function(a){this.childs.push(a)};
Grape2D.SceneGroup.prototype.removeChild=function(a){this.childs.splice(this.childs.indexOf(a),1)};Grape2D.SceneLayer=function(a){a=a||{};this.map=a.map||new Grape2D.SimpleMap};Grape2D.SceneLayer.prototype=Object.create(Grape2D.Scene.prototype);Grape2D.SceneLayer.prototype.update=function(a){this.map.update(a)};Grape2D.SceneLayer.prototype.render=function(a,b){var c=this.map.query(Grape2D.BVFactorySingleton.getFactory().createSceneBV(a,b));a.start();for(var d=0;d<c.length;d++)c[d].render(a,b);a.end()};Grape2D.SceneLayer.prototype.getMap=function(){return this.map};Grape2D.Game=function(){};Grape2D.Game.prototype={constructor:Grape2D.Game,setup:function(){},start:function(){},stop:function(){},render:function(){},update:function(a){},animate:function(){}};Grape2D.SimpleGame=function(a,b,c){this.camera=c;this.clock=new Grape2D.utils.Clock;this.renderer=a;this.scene=b};Grape2D.SimpleGame.prototype=Object.create(Grape2D.Game.prototype);Grape2D.SimpleGame.prototype.getCamera=function(){return this.camera};Grape2D.SimpleGame.prototype.getClock=function(){return this.clock};Grape2D.SimpleGame.prototype.getRenderer=function(){return this.renderer};Grape2D.SimpleGame.prototype.getScene=function(){return this.scene};Grape2D.SimpleGame.prototype.setup=function(){};
Grape2D.SimpleGame.prototype.start=function(){this.animate()};Grape2D.SimpleGame.prototype.stop=function(){cancelAnimationFrame()};Grape2D.SimpleGame.prototype.render=function(){this.scene.render(this.renderer,this.camera)};Grape2D.SimpleGame.prototype.update=function(a){this.scene.update(a)};
Grape2D.SimpleGame.prototype.animate=function(){var a=this,b=this.clock.update();requestAnimationFrame(function(){a.animate()});this.update(b);this.render();this.renderer.renderText("FPS: "+this.clock.fps,new Grape2D.Vector(10,10))};
