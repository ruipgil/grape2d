(function(){ 'use strict';var Grape2D={version:"1.3.0-alpha",NODE:!1,WINDOW:{}};(function(){"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=Grape2D),exports.Grape2D=Grape2D,Grape2D.NODE=!0,Grape2D.WINDOW={}):(window.Grape2D=Grape2D,Grape2D.NODE=!1,Grape2D.WINDOW=window)})();
(function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(a,c){var d=(new Date).getTime(),h=Math.max(0,16-(d-b)),k=setTimeout(function(){a(d+h)},h);b=d+h;return k});a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})})(Grape2D.WINDOW);Grape2D.utils={getDocumentSize:function(){return{width:window.innerWidth,height:window.innerHeight}},requestAnimationFrame:function(a){return Grape2D.NODE?Grape2D.WINDOW.requestAnimationFrame(a):window.requestAnimationFrame(a)},cancelAnimationFrame:function(a){return Grape2D.NODE?Grape2D.WINDOW.cancelAnimationFrame(a):window.cancelAnimationFrame(a)}};Grape2D.utils.Clock=function(){this.frameCount=0;this.lastFrame=this.end=this.start=(new Date).getTime();this.timeEl=this.fps=0};
Grape2D.utils.Clock.prototype={constructor:Grape2D.utils.Clock,update:function(){var a=(new Date).getTime(),b=a-this.lastFrame;this.frameCount++;this.timeEl+=b;1E3<=this.timeEl&&this.reset(a);this.lastFrame=a;return b},reset:function(a){this.fps=this.frameCount;this.frameCount=this.timeEl=0;this.end=a},getTime:function(){return(new Date).getTime()},getFps:function(){return this.fps},getFrameCount:function(){return this.frameCount}};Grape2D.utils.SynchronizedClock=function(){Grape2D.utils.Clock.call(this);this.deltaSync=0};Grape2D.utils.SynchronizedClock.prototype=Object.create(Grape2D.utils.Clock.prototype);Grape2D.utils.SynchronizedClock.prototype.getTime=function(){return Grape2D.utils.Clock.prototype.getTime.call(this)-this.deltaSync};Grape2D.utils.SynchronizedClock.prototype.sync=function(a){this.deltaSync=a};Grape2D.utils.UUIDGenerator=function(){};Grape2D.utils.UUIDGenerator.prototype={constructor:Grape2D.utils.UUIDGenerator,s4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},generate:function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()}};Grape2D.utils.UUIDGeneratorSingleton={instance:new Grape2D.utils.UUIDGenerator,getInstance:function(){return Grape2D.utils.UUIDGeneratorSingleton.instance},setInstance:function(a){Grape2D.utils.UUIDGeneratorSingleton.instance=a},generate:function(){return Grape2D.utils.UUIDGeneratorSingleton.instance.generate()}};Grape2D.Color=function(a){this.color=new Float32Array(a||[0,0,0,1])};
Grape2D.Color.prototype={constructor:Grape2D.Color,getRaw:function(){return this.color},getR:function(){return this.color[0]},getG:function(){return this.color[1]},getB:function(){return this.color[2]},getA:function(){return this.color[3]},setR:function(a){this.color[0]=a},setG:function(a){this.color[1]=a},setB:function(a){this.color[2]=a},setA:function(a){this.color[3]=a},set:function(a){this.setR(a.getR());this.setG(a.getG());this.setB(a.getB());this.setA(a.getA())},toString:function(){return"rgba("+
this.getR()+","+this.getG()+","+this.getB()+","+this.getA()+")"}};Grape2D.Color.RGB_A_REG_EXP=/rgb[a]?\([\s]*(\d{1,3})[\s]*,[\s]*(\d{1,3})[\s]*,[\s]*(\d{1,3})[\s]*(?:,[\s]*(1|(:?0\.[0-9]+)|0)[\s]*)?\)[;]?/i;Grape2D.Color.createFromRgb=function(a){a=Grape2D.Color.RGB_A_REG_EXP.exec(a);return new Grape2D.Color([parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),1])};
Grape2D.Color.createFromRgba=function(a){a=Grape2D.Color.RGB_A_REG_EXP.exec(a);return new Grape2D.Color([parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),parseInt(a[4],10)])};Grape2D.Color.createFromHex=function(a){return new Grape2D.Color([parseInt(a.substr(1,2),16),parseInt(a.substr(3,2),16),parseInt(a.substr(5,2),16),1])};
Grape2D.Color.createFromString=function(a){var b=null;"#"==a.charAt(0)?b=Grape2D.Color.createFromHex(a):"rgba"==a.substr(0,4)?b=Grape2D.Color.createFromRgba(a):"rgb"==a.substr(0,3)&&(b=Grape2D.Color.createFromRgb(a));return b};Grape2D.Color.RED=[255,0,0,1];Grape2D.Color.GREEN=[0,255,0,1];Grape2D.Color.BLUE=[0,0,255,1];Grape2D.Color.BLACK=[0,0,0,1];Grape2D.Color.WHITE=[255,255,255,1];Grape2D.Color.YELLOW=[255,255,0,1];Grape2D.Color.ORANGE=[255,128,0,1];Grape2D.Color.IVORY=[255,255,240,1];
Grape2D.Color.BEIGE=[245,245,220,1];Grape2D.Color.WHEAT=[245,222,179,1];Grape2D.Color.TAN=[210,180,140,1];Grape2D.Color.KHAKI=[195,176,145,1];Grape2D.Color.Silver=[192,192,192,1];Grape2D.Color.GRAY=[128,128,128,1];Grape2D.Color.CHARCOAL=[70,70,70,1];Grape2D.Color.NAVY_BLUE=[0,0,128,1];Grape2D.Color.ROYAL_BLUE=[8,76,158,1];Grape2D.Color.MEDIUM_BLUE=[0,0,205,1];Grape2D.Color.AZURE=[0,127,255,1];Grape2D.Color.CYAN=[0,255,255,1];Grape2D.Color.AQUAMARINE=[127,255,212,1];Grape2D.Color.TEAL=[0,128,128,1];
Grape2D.Color.FOREST_GREEN=[34,139,34,1];Grape2D.Color.OLIVE=[128,128,0,1];Grape2D.Color.CHARTREUSE=[127,255,0,1];Grape2D.Color.LIME=[191,255,0,1];Grape2D.Color.GOLDEN=[255,215,0,1];Grape2D.Color.GOLDENROD=[218,165,32,1];Grape2D.Color.CORAL=[255,127,80,1];Grape2D.Color.SALMON=[250,128,114,1];Grape2D.Color.HOT_PINK=[252,15,192,1];Grape2D.Color.FUCHSIA=[255,119,255,1];Grape2D.Color.PUCE=[204,136,153,1];Grape2D.Color.MAUVE=[224,176,255,1];Grape2D.Color.LAVENDER=[181,126,220,1];
Grape2D.Color.PLUM=[132,49,121,1];Grape2D.Color.INDIGO=[75,0,130,1];Grape2D.Color.MAROON=[128,0,0,1];Grape2D.Color.CRIMSON=[220,20,60,1];Grape2D.Math={E:Math.E,SQRT2:Math.SQRT2,SQRT1_2:Math.SQRT1_2,LN2:Math.LN2,LN10:Math.LN10,LOG2E:Math.LOG2E,LOG10E:Math.LOG10E,PI:Math.PI,PIx2:2*Math.PI,PId2:Math.PI/2,PId4:Math.PI/4,PId6:Math.PI/6,PId8:Math.PI/8,abs:function(a){return 0<a?a:-a},floor:function(a){return 0<a?~~a:a==~~a?a:~~a-1},floorPositive:function(a){return~~a},ceil:function(a){return~~a==a?a:0>a?~~a:~~a+1},round:function(a){return a+(0>a?-0.5:0.5)>>0},roundOne:function(a){return 0.1*Grape2D.Math.round(10*a)},roundTwo:function(a){return 0.01*
Grape2D.Math.round(100*a)},roundThree:function(a){return 0.001*Grape2D.Math.round(1E3*a)},roundFour:function(a){return 1E-4*Grape2D.Math.round(1E4*a)},roundN:function(a,b){var c=Grape2D.Math.pow(10,b);return Grape2D.Math.round(a*c)/c},randFloat:function(a,b){return b?a+Math.random()*(b-a):Math.random()*a},randInt:function(a,b){return Grape2D.Math.floor(Grape2D.Math.randFloat(a,b)+0.5)},cos:Math.cos,sin:Math.sin,tan:Math.tan,sqrt:Math.sqrt,pow:Math.pow,min:function(a,b){return a<b?a:b},max:function(a,
b){return a>b?a:b},clamp:function(a,b,c){return a<=b?b:a>c?c:a},overlaps:function(a,b){return a.min<=b.min?a.max-b.min:b.max-a.min},sq:function(a){return a*a},isPowerOfTwo:function(a){return a&&!(a&a-1)},nextPowerOfTwo:function(a){a--;a|=a>>1;a|=a>>2;a|=a>>4;a|=a>>8;a|=a>>16;a++;return a}};Grape2D.Vector=function(a,b){this.x=a||0;this.y=b||0};
Grape2D.Vector.prototype={constructor:Grape2D.Vector,getX:function(){return this.x},setX:function(a){this.x=a},getY:function(){return this.y},setY:function(a){this.y=a},setXY:function(a,b){this.x=a;this.y=b},set:function(a){this.x=a.x;this.y=a.y;return this},add:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},multiplyByScalar:function(a){this.x*=a;this.y*=a;return this},divideByScalar:function(a){this.x/=a;this.y/=a;return this},negate:function(){return this.multiplyByScalar(-1)},
normalize:function(){return this.divideByScalar(this.getMagnitude())},getMagnitude:function(){return Grape2D.Math.sqrt(this.x*this.x+this.y*this.y)},length:function(){return this.getMagnitude()},lengthSquared:function(){return this.x*this.x+this.y*this.y},getAngle:function(){return 0<this.x?Math.atan(this.y/this.x):Math.PI-Math.atan(this.y/this.x)},dot:function(a){return this.x*a.x+this.y*a.y},project:function(a){var b=this.dot(a),c=new Grape2D.Vector;c.x=b*a.x;c.y=b*a.y;return c},rightNormal:function(){return new Grape2D.Vector(-this.y,
this.x)},leftNormal:function(){return new Grape2D.Vector(this.y,-this.x)},isParallelTo:function(a){return Grape2D.Math.abs(a.x)==Grape2D.Math.abs(this.x)&&Grape2D.Math.abs(a.y)==Grape2D.Math.abs(this.y)},distanceTo:function(a){return Grape2D.Math.sqrt(Grape2D.Math.sq(a.x-this.x)+Grape2D.Math.sq(a.y-this.y))},sqDistanceTo:function(a){return Grape2D.Math.sq(a.x-this.x)+Grape2D.Math.sq(a.y-this.y)},xDistanceTo:function(a){return this.x>a.x?Grape2D.Math.abs(this.x-a.x):Grape2D.Math.abs(a.x-this.x)},yDistanceTo:function(a){return this.y>
a.y?Grape2D.Math.abs(this.y-a.y):Grape2D.Math.abs(a.y-this.y)},equals:function(a){return this.x==a.x&&this.y==a.y},clone:function(){return new Grape2D.Vector(this.x,this.y)},toString:function(){return"Grape2D.Vector ("+this.x+","+this.y+")"},use:function(a){this.x=a(this.x);this.y=a(this.y);return this},reset:function(){this.y=this.x=0;return this},getStaticType:function(){return Grape2D.Vector.STATIC_TYPE},isZero:function(){return 0==this.x&&0==this.y}};
Grape2D.Vector.createFromPoints=function(a,b){return new Grape2D.Vector(b.x-a.x,b.y-a.y)};Grape2D.Vector.createFromAngle=function(a,b){return new Grape2D.Vector(b*Grape2D.Math.cos(a),b*Grape2D.Math.sin(a))};Grape2D.Vector.lerp=function(a,b,c){return a.clone().add(b.clone().sub(a).multiplyByScalar(c))};Grape2D.Vector.STATIC_TYPE="Vector";Grape2D.IMatrix=function(){};Grape2D.IMatrix.prototype={constructor:Grape2D.IMatrix};Grape2D.Matrix=function(a,b,c,d,e,f,g,h,k){this.v=new Float32Array(9);void 0!==a?(this.v[0]=a,this.v[1]=b,this.v[2]=c,this.v[3]=d,this.v[4]=e,this.v[5]=f,this.v[6]=g,this.v[7]=h,this.v[8]=k):this.identity()};
Grape2D.Matrix.prototype={constructor:Grape2D.Matrix,set:function(a,b,c,d,e,f,g,h,k){var l=this.v;l[0]=a;l[1]=b;l[2]=c;l[3]=d;l[4]=e;l[5]=f;l[6]=g;l[7]=h;l[8]=k;return this},setFromMatrix:function(a){a=a.v;return this.set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},add:function(a){for(var b=0;9>b;b++)this.v[b]+=a.v[b];return this},identity:function(){var a=this.v;a[0]=a[4]=a[8]=1;a[1]=a[2]=a[3]=a[5]=a[6]=a[7]=0;return this},invert:function(){var a=this.determinant(),b=this.v;this.v=new Float32Array([b[4]*
b[8]-b[5]*b[7],b[2]*b[7]-b[1]*b[8],b[1]*b[5]-b[2]*b[4],b[5]*b[6]-b[8]*b[3],b[0]*b[8]-b[2]*b[6],b[2]*b[3]-b[0]*b[5],b[3]*b[7]-b[4]*b[6],b[1]*b[6]-b[0]*b[7],b[0]*b[4]-b[1]*b[3]]);return this.multiplyByScalar(1/a)},determinant:function(){var a=this.v;return a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6])},multiplyByVector:function(a){return new Grape2D.Vector(this.v[0]*a.getX()+this.v[1]*a.getY()+this.v[2],this.v[3]*a.getX()+this.v[4]*a.getY()+this.v[5])},multiplyByScalar:function(a){this.v[0]*=
a;this.v[1]*=a;this.v[2]*=a;this.v[3]*=a;this.v[4]*=a;this.v[5]*=a;this.v[6]*=a;this.v[7]*=a;this.v[8]*=a;return this},multiplyByMatrix:function(a){var b=this.v;a=a.v;return new Grape2D.Matrix(b[0]*a[0]+b[1]*a[3]+b[2]*a[6],b[0]*a[1]+b[1]*a[4]+b[2]*a[7],b[0]*a[2]+b[1]*a[5]+b[2]*a[8],b[3]*a[0]+b[4]*a[3]+b[5]*a[6],b[3]*a[1]+b[4]*a[4]+b[5]*a[7],b[3]*a[2]+b[4]*a[5]+b[5]*a[8],b[6]*a[0]+b[7]*a[3]+b[8]*a[6],b[6]*a[1]+b[7]*a[4]+b[8]*a[7],b[6]*a[2]+b[7]*a[5]+b[8]*a[8])},selfMultiplyByMatrix:function(a){var b=
this.v;a=a.v;this.set(b[0]*a[0]+b[1]*a[3]+b[2]*a[6],b[0]*a[1]+b[1]*a[4]+b[2]*a[7],b[0]*a[2]+b[1]*a[5]+b[2]*a[8],b[3]*a[0]+b[4]*a[3]+b[5]*a[6],b[3]*a[1]+b[4]*a[4]+b[5]*a[7],b[3]*a[2]+b[4]*a[5]+b[5]*a[8],b[6]*a[0]+b[7]*a[3]+b[8]*a[6],b[6]*a[1]+b[7]*a[4]+b[8]*a[7],b[6]*a[2]+b[7]*a[5]+b[8]*a[8]);return this},translate:function(a,b){this.v[2]=this.v[0]*a+this.v[1]*b+this.v[2];this.v[5]=this.v[3]*a+this.v[4]*b+this.v[5];return this},scale:function(a,b){var c=this.v;c[0]*=a;c[1]*=b;c[3]*=a;c[4]*=b;c[6]*=
a;c[7]*=b;return this},rotate:function(a){var b=Grape2D.Math.cos(a);a=Grape2D.Math.sin(a);var c=this.v,d=-c[0]*a+c[1]*a,e=c[3]*b+c[4]*a,f=-c[3]*a+c[4]*a,g=c[6]*b+c[7]*a,h=-c[6]*a+c[7]*a;c[0]=c[0]*b+c[1]*a;c[1]=d;c[3]=e;c[4]=f;c[6]=g;c[7]=h;return this},transpose:function(){var a,b=this.v;a=b[1];b[1]=b[3];b[3]=a;a=b[2];b[2]=b[6];b[6]=a;a=b[5];b[5]=b[7];b[7]=a;return this},clone:function(){return new Grape2D.Matrix(this.v[0],this.v[1],this.v[2],this.v[3],this.v[4],this.v[5],this.v[6],this.v[7],this.v[8])},
toString:function(){return"Grape2D.Matrix\n"+this.v[0]+" "+this.v[1]+" "+this.v[2]+"\n"+this.v[3]+" "+this.v[4]+" "+this.v[5]+"\n"+this.v[6]+" "+this.v[7]+" "+this.v[8]},getRaw:function(){return this.v}};Grape2D.Matrix.createFromTranslation=function(a,b){return new Grape2D.Matrix(1,0,a,0,1,b,0,0,1)};Grape2D.Matrix.createFromScale=function(a,b){return new Grape2D.Matrix(a,0,0,0,b,0,0,0,1)};
Grape2D.Matrix.createFromRotation=function(a){var b=Grape2D.Math.cos(a);a=Grape2D.Math.sin(a);return new Grape2D.Matrix(b,-a,0,a,b,0,0,0,1)};Grape2D.MatrixStack=function(){Grape2D.IMatrix.call(this);this.stack=[];this.identity=!1;this.head=null};Grape2D.MatrixStack.prototype=Object.create(Grape2D.IMatrix.prototype);Grape2D.MatrixStack.prototype.push=function(a){this.identity&&this.stack.push(new Grape2D.Matrix);this.stack.push(a);this.head=a;return this};Grape2D.MatrixStack.prototype.pushIdentity=function(){if(this.pushIdentity){var a=new Grape2D.Matrix;this.stack.push(a);this.head=a}else this.identity=!0;return this};
Grape2D.MatrixStack.prototype.pop=function(){this.identity?this.identity=!1:(this.stack.pop(),this.head=this.stack[this.stack.length-1]);return this};Grape2D.MatrixStack.prototype.getHead=function(){this.identity&&(this.identity=!1,this.push(new Grape2D.Matrix));return this.head};Grape2D.MatrixStack.prototype.translate=function(a){this.identity?(a=Grape2D.Matrix.createFromTranslation(a.getX(),a.getY()),this.identity=!1,this.push(a)):this.head.translate(a.getX(),a.getY());return this};
Grape2D.MatrixStack.prototype.scale=function(a,b){this.identity?(this.identity=!1,this.push(Grape2D.Matrix.createFromScale(a,b))):this.head.scale(a,b);return this};Grape2D.MatrixStack.prototype.rotate=function(a){this.identity?(this.identity=!1,this.push(Grape2D.Matrix.createFromRotation(a))):this.head.rotate(a);return this};Grape2D.MatrixStack.prototype.reset=function(){this.stack=[];this.identity=!1;this.head=null;return this};Grape2D.Renderer=function(){};
Grape2D.Renderer.prototype={constructor:Grape2D.Renderer,getWidth:function(){},getHalfWidth:function(){},setWidth:function(a){},getHeight:function(){},getHalfHeight:function(){},setHeight:function(a){},renderColoredShape:function(a){},renderTexture:function(a,b){},renderREntity:function(a){},renderAABB:function(a){},renderCircle:function(a){},renderPolygon:function(a){},renderText:function(a){},renderAbsoluteText:function(a){},start:function(a){},end:function(){},appendToDOMElement:function(a){},getDOMElement:function(){},
setStrokeColorMode:function(){},setFillColorMode:function(a){},setColor:function(a){},renderLineSegment:function(a,b){},renderPoint:function(a){}};Grape2D.Canvas=function(a){a=a||{};this.canvas=document.createElement("Canvas");this.canvas.width=a.width||300;this.canvas.height=a.height||150;this.halfWidth=this.canvas.width/2;this.halfHeight=this.canvas.height/2;this.context=this.canvas.getContext("2d")};
Grape2D.Canvas.prototype={getWidth:function(){return this.canvas.width},getHalfWidth:function(){return this.halfWidth},setWidth:function(a){this.canvas.width=a;this.halfWidth=a/2},getHeight:function(){return this.canvas.height},getHalfHeight:function(){return this.halfHeight},setHeight:function(a){this.canvas.height=a;this.halfHeight=a/2},toDataURL:function(a,b){return this.canvas.toDataURL(a,b)},getContext:function(){return this.context},save:function(){this.context.save();return this},restore:function(){this.context.restore();
return this},scale:function(a,b){this.context.scale(a,b);return this},rotate:function(a){this.context.rotate(a);return this},translate:function(a,b){this.context.translate(a,b);return this},transform:function(a,b,c,d,e,f){this.context.transform(a,b,c,d,e,f);return this},drawImage:function(a,b,c,d,e,f,g,h,k){this.context.drawImage(a,b,c,d,e,f,g,h,k);return this},setGlobalAlpha:function(a){this.context.globalAlpha=a;return this},globalCompositeOperation:function(a){this.context.globalCompositeOperation=
a;return this},setLineWidth:function(a){this.context.lineWidth=a;return this},setLineCap:function(a){this.context.lineCap=a;return this},setLineJoin:function(a){this.context.lineJoin=a;return this},setMiterLimit:function(a){this.context.miterLimit=a;return this},setStrokeStyle:function(a){this.context.strokeStyle=a.toString();return this},setFillStyle:function(a){this.context.fillStyle=a.toString();return this},setShadowOffsetX:function(a){this.context.shadowOffsetX=a;return this},setShadowOffsetY:function(a){this.context.shadowOffsetY=
a;return this},setShadowBlur:function(a){this.context.shadowBlur=a;return this},setShadowColor:function(a){this.context.shadowColor=a.toString();return this},createLinearGradient:function(a,b,c,d){return this.context.createLinearGradient(a,b,c,d)},createRadialGradient:function(a,b,c,d,e,f){return this.context.createRadialGradient(a,b,c,d,e,f)},createPattern:function(a,b){return this.context.createPattern(a,b)},beginPath:function(){this.context.beginPath();return this},closePath:function(){this.context.closePath();
return this},fill:function(){this.context.fill();return this},stroke:function(){this.context.stroke();return this},clip:function(){this.context.clip();return this},moveTo:function(a,b){this.context.moveTo(a,b);return this},lineTo:function(a,b){this.context.lineTo(a,b);return this},quadraticCurveTo:function(a,b,c,d){this.context.quadraticCurveTo(a,b,c,d);return this},bezierCurveTo:function(a,b,c,d,e,f){this.context.bezierCurveTo(a,b,c,d,e,f);return this},arcTo:function(a,b,c,d,e){this.context.arcTo(a,
b,c,d,e);return this},arc:function(a,b,c,d,e,f){this.context.arc(a,b,c,d||0,e||Grape2D.Math.PIx2,f||!1);return this},rect:function(a,b,c,d){this.context.rect(a,b,c,d);return this},isPointInPath:function(a,b){return this.context.isPointInPath(a,b)},setFont:function(a){this.context.font=a;return this},setTextAlign:function(a){this.context.textAlign=a;return this},setTextBaseline:function(a){this.context.textBaseline=a;return this},fillText:function(a,b,c){this.context.fillText(a,b,c);return this},strokeText:function(a,
b,c){this.context.strokeText(a,b,c);return this},measureText:function(a){return this.context.measureText(a)},clearRect:function(a,b,c,d){this.context.clearRect(a,b,c,d);return this},fillRect:function(a,b,c,d){this.context.fillRect(a,b,c,d);return this},strokeRect:function(a,b,c,d){this.context.strokeRect(a,b,c,d);return this},createImageData:function(a,b){return this.context.createImageData(a,b)},getImageData:function(a,b,c,d){return this.context.getImageData(a,b,c,d)},putImageData:function(a,b,c,
d,e,f,g){this.context.putImageData(a,b,c,d,e,f,g);return this},resize:function(a,b){this.setWidth(a);this.setHeight(b);return this},appendOn:function(a){a.appendChild(this.canvas);return this},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},addEventListener:function(a,b,c){this.canvas.addEventListener(a,b,c||!1)},setStyle:function(a){for(var b in a)this.canvas.style[b]=a[b]},getRaw:function(){return this.canvas}};Grape2D.CanvasRenderer=function(a){a=a||{};this.canvas=new Grape2D.Canvas(a);this.color=new Grape2D.Color;a.color&&this.color.set(a.color);this.colorMode="fill";this.clearColorCanvas=new Grape2D.Canvas({width:this.getWidth(),height:this.getHeight()});this.setClearColor(a.clearColor||new Grape2D.Color);this.camera=null;this.rawCamera=new Grape2D.Camera({transformation:Grape2D.Matrix.createFromTranslation(-this.getHalfWidth(),-this.getHalfHeight())});this.modelView=new Grape2D.MatrixStack;var b=this;
this.init();this.canvas.addEventListener("resize",function(){b.init()})};Grape2D.CanvasRenderer.prototype=Object.create(Grape2D.Renderer.prototype);Grape2D.CanvasRenderer.prototype.init=function(){this.canvas.translate(this.canvas.getHalfWidth(),this.canvas.getHalfHeight())};Grape2D.CanvasRenderer.prototype.setClearColor=function(a){console.log(a+"");this.clearColorCanvas.setFillStyle(a);this.clearColorCanvas.fillRect(0,0,this.clearColorCanvas.getWidth(),this.clearColorCanvas.getHeight())};
Grape2D.CanvasRenderer.prototype.getWidth=function(){return this.canvas.getWidth()};Grape2D.CanvasRenderer.prototype.getHalfWidth=function(){return this.canvas.getHalfWidth()};Grape2D.CanvasRenderer.prototype.setWidth=function(a){this.canvas.setWidth(a);this.clearColorCanvas.setWidth(a)};Grape2D.CanvasRenderer.prototype.getHeight=function(){return this.canvas.getHeight()};Grape2D.CanvasRenderer.prototype.getHalfHeight=function(){return this.canvas.getHalfHeight()};
Grape2D.CanvasRenderer.prototype.setHeight=function(a){this.canvas.setHeight(a);this.clearColorCanvas.setHeight(a)};Grape2D.CanvasRenderer.prototype.renderColoredShape=function(a){this.setColor(a.getColor());a.getShape().render(this)};Grape2D.CanvasRenderer.prototype.renderTexture=function(a,b){this.canvas.drawImage(a.getBuffer(),0,0,a.getWidth(),a.getHeight(),b.getX(),b.getY(),1*a.getWidth(),1*a.getHeight())};
Grape2D.CanvasRenderer.prototype.renderREntity=function(a){this.modelView.pushIdentity().translate(a.getPosition()).translate(a.getTextureOffset());a.getTexture().render(this,this.camera.wcsToVcs(a.getPosition(),this.modelView.getHead()));this.modelView.pop()};
Grape2D.CanvasRenderer.prototype.renderAABB=function(a){this.canvas.beginPath();var b=this.camera.wcsToVcs(a.getMin()),c;this.canvas.moveTo(b.getX(),b.getY());c=this.camera.wcsToVcs(new Grape2D.Vector(a.getMaxX(),a.getMinY()));this.canvas.lineTo(c.getX(),c.getY());c=this.camera.wcsToVcs(a.getMax());this.canvas.lineTo(c.getX(),c.getY());c=this.camera.wcsToVcs(new Grape2D.Vector(a.getMinX(),a.getMaxY()));this.canvas.lineTo(c.getX(),c.getY());this.canvas.lineTo(b.getX(),b.getY());this.canvas[this.colorMode]()};
Grape2D.CanvasRenderer.prototype.renderCircle=function(a){var b=this.camera.wcsToVcs(a.getPosition());a=this.camera.getProjection().multiplyByVector(new Grape2D.Vector(a.getRadius(),a.getRadius()));this.canvas.beginPath();this.canvas.arc(b.x,b.y,Grape2D.Math.floor(a.getX()),0,Grape2D.Math.PIx2,!1);this.canvas[this.colorMode]()};
Grape2D.CanvasRenderer.prototype.renderPolygon=function(a){var b=a.getPosition(),c=null,d=b.clone();a=a.getVertexList();d=this.camera.wcsToVcs(d.add(a[0]));this.canvas.beginPath();this.canvas.moveTo(d.getX(),d.getY());for(var e=1;e<a.length;e++)c=b.clone(),c=this.camera.wcsToVcs(c.add(a[e])),this.canvas.lineTo(c.getX(),c.getY());this.canvas.lineTo(d.getX(),d.getY());this.canvas[this.colorMode]()};Grape2D.CanvasRenderer.prototype.renderText=function(a){this.renderTexture(a.getBuffer(),a.getPosition())};
Grape2D.CanvasRenderer.prototype.renderAbsoluteText=function(a){var b=this.camera;this.camera=this.rawCamera;this.renderTexture(a.getBuffer(),this.camera.wcsToVcs(a.getPosition()));this.camera=b};Grape2D.CanvasRenderer.prototype.start=function(a){this.canvas.clearRect(-this.canvas.getHalfWidth(),-this.canvas.getHalfHeight(),this.canvas.getWidth(),this.canvas.getHeight());this.camera=a;this.modelView.reset()};Grape2D.CanvasRenderer.prototype.end=function(){};
Grape2D.CanvasRenderer.prototype.appendToDOMElement=function(a){this.canvas.appendOn(a);this.clearColorCanvas.setStyle({top:this.canvas.getRaw().offsetTop+"px",left:this.canvas.getRaw().offsetLeft+"px",position:"absolute","z-index":"-1"});this.clearColorCanvas.appendOn(a)};Grape2D.CanvasRenderer.prototype.getDOMElement=function(){return this.canvas.canvas};Grape2D.CanvasRenderer.prototype.getContext=function(){return this.canvas.context};
Grape2D.CanvasRenderer.prototype.setStrokeColorMode=function(){this.colorMode="stroke";return this};Grape2D.CanvasRenderer.prototype.setFillColorMode=function(){this.colorMode="fill";return this};Grape2D.CanvasRenderer.prototype.setColor=function(a){this.color.set(a);this.canvas.setFillStyle(this.color);this.canvas.setStrokeStyle(this.color);return this};
Grape2D.CanvasRenderer.prototype.renderLineSegment=function(a,b){var c=this.camera.wcsToVcs(a),d=this.camera.wcsToVcs(b);this.canvas.beginPath();this.canvas.moveTo(c.getX(),c.getY());this.canvas.lineTo(d.getX(),d.getY());this.canvas.stroke()};Grape2D.CanvasRenderer.prototype.renderPoint=function(a){a=this.camera.wcsToVcs(a);this.canvas.beginPath();this.canvas.arc(a.x,a.y,2,0,Grape2D.Math.PIx2,!1);this.canvas.fill()};Grape2D.CanvasRenderer.CIRCLE_PRECISION=32;Grape2D.WebGLProgram=function(a,b){this.gl=this.compiled=null;this.vertexShader=a;this.fragmentShader=b;this.cache={uniform:{},attribute:{}}};
Grape2D.WebGLProgram.prototype={constructor:Grape2D.WebGLProgram,compileShader:function(a,b,c){c=b.createShader(c);b.shaderSource(c,a);b.compileShader(c);return c},setUniform:function(a,b,c,d,e){this.cache.uniform[a].set(b,c,d,e)},setAttribute:function(a,b,c,d,e){this.cache.attribute[a].set(b,c,d,e)},compile:function(a){var b=a.createProgram(),c=Grape2D.WebGLProgram.G2D_SPECIFIC_FN+this.vertexShader,d=c+this.fragmentShader;a.attachShader(b,this.compileShader(c,a,a.VERTEX_SHADER));a.attachShader(b,
this.compileShader(this.fragmentShader,a,a.FRAGMENT_SHADER));a.linkProgram(b);if(a.getProgramParameter(b,a.LINK_STATUS))this.gl=a;else throw Error("Couldn't initialize the shader program");this.compiled=b;this.compileSetters(d);return this},isCompiled:function(){return null!=this.compile},use:function(){this.gl.useProgram(this.compiled);for(var a in this.cache.attribute)this.gl.enableVertexAttribArray(this.cache.attribute[a].id);return this},unuse:function(){for(var a in this.cache.attribute)this.gl.disableVertexAttribArray(this.cache.attribute[a].id);
return this},getUniformLocation:function(a){return this.cache.uniform[a].id},getAttributeLocation:function(a){return this.cache.attribute[a].id}};
Grape2D.WebGLProgram.prototype.compileSetters=function(a){var b=this.gl,c=this.buildAssociationObject(),d=/(attribute|uniform) ((?:(?:(?:[i|b])?vec|mat)(?:[2|3|4]))|int|unsigned int|float|bool|sampler2D|samplerCube) ([\w|\d|_]+);/g,e;e=null;for(var f,g,h;null!==(e=d.exec(a));)f=e[1],h=e[2],g=e[3],e="attribute"==f?b.getAttribLocation(this.compiled,g):b.getUniformLocation(this.compiled,g),this.cache[f][g]={set:c[f][h](e),id:e}};
Grape2D.WebGLProgram.prototype.buildAssociationObject=function(){var a=this.gl,b=function(b){return function(c){a.uniform1i(b,c)}},c=function(b){return function(c,d,e,f){a.uniform4i(b,c,d,e,f)}},d=function(b){return function(c,d,e){a.uniform3i(b,c,d,e)}},e=function(b){return function(c,d){a.uniform2i(b,c,d)}},f=function(a){return function(b){throw Error("[id:"+b+"] "+a);}},g=function(b){return function(c,d){a.vertexAttribPointer(b,1,a.FLOAT,!1,c||0,d||0)}},h=function(b){return function(c,d){a.vertexAttribPointer(b,
2,a.FLOAT,!1,c||0,d||0)}},k=function(b){return function(c,d){a.vertexAttribPointer(b,3,a.FLOAT,!1,c||0,d||0)}},l=function(b){return function(c,d){a.vertexAttribPointer(b,4,a.FLOAT,!1,c||0,d||0)}};return{uniform:{vec4:function(b){return function(c,d,e,f){a.uniform4f(b,c,d,e,f)}},vec3:function(b){return function(c,d,e){a.uniform3f(b,c,d,e)}},vec2:function(b){return function(c,d){a.uniform2f(b,c,d)}},bvec4:c,bvec3:d,bvec2:e,ivec4:c,ivec3:d,ivec2:e,mat4:f("This version of Grape2D doesn't support mat4 uniforms."),
mat3:function(b){return function(c){a.uniformMatrix3fv(b,!1,c.getRaw())}},mat2:f("This version of Grape2D doesn't support mat3 uniforms."),"float":function(b){return function(c){a.uniform1f(b,c)}},bool:b,"int":b,"unsigned int":b,sampler2D:b,samplerCube:b},attribute:{vec4:l,vec3:k,vec2:h,bvec4:l,bvec3:k,bvec2:h,ivec4:l,ivec3:k,ivec2:h,mat4:f("This version of Grape2D doesn't support mat4 attributes."),mat3:f("This version of Grape2D doesn't support mat3 attributes."),mat2:f("This version of Grape2D doesn't support mat2 attributes."),
"float":g,bool:g,"int":g,"unsigned int":g,sampler2D:g,samplerCube:g}}};Grape2D.WebGLProgram.createColorDefault=function(){return new Grape2D.WebGLProgram(Grape2D.WebGLProgram.DEFAULT_COLOR_VS,Grape2D.WebGLProgram.DEFAULT_COLOR_FS)};Grape2D.WebGLProgram.createTextureDefault=function(){return new Grape2D.WebGLProgram(Grape2D.WebGLProgram.DEFAULT_TEXTR_VS,Grape2D.WebGLProgram.DEFAULT_TEXTR_FS)};Grape2D.WebGLProgram.DEFAULT_COLOR_VS="varying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform mat3 rendererProjectionMatrix;\nuniform mat3 cameraProjectionMatrix;\nuniform mat3 modelViewMatrix;\nuniform mat3 projectionMatrix;\nuniform vec2 cameraPosition;\nuniform vec4 vertexColor;\nattribute vec2 vertexPosition;\nvoid main(void) {\ngl_PointSize = 2.0;\ngl_Position = \ngrape2DMatrixToMat4(rendererProjectionMatrix) * \ngrape2DMatrixToMat4(cameraProjectionMatrix) * \ngrape2DMatrixToMat4(modelViewMatrix) * \nvec4(vertexPosition-cameraPosition, 0.0, 1.0);\nvColor = vertexColor;\n}";
Grape2D.WebGLProgram.DEFAULT_COLOR_FS="precision mediump float;\nvarying vec4 vColor;\nvoid main(void) {\ngl_FragColor = vColor;\n}";Grape2D.WebGLProgram.DEFAULT_TEXTR_VS="varying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform mat3 rendererProjectionMatrix;\nuniform mat3 cameraProjectionMatrix;\nuniform mat3 modelViewMatrix;\nuniform vec2 cameraPosition;\nattribute vec2 textureCoord;\nattribute vec2 vertexPosition;\nvec4 vPos;\nvec4 center;\nmat4 renderer2x;\nvoid main(void) {\nrenderer2x = grape2DMatrixToMat4(rendererProjectionMatrix) * \nmat4(2.0, 0.0, 0.0, 0.0,  0.0, 2.0, 0.0, 0.0,  0.0, 0.0, 1.0, 0.0,  0.0, 0.0, 0.0, 1.0);\ncenter = renderer2x * \ngrape2DMatrixToMat4(cameraProjectionMatrix) * \ngrape2DMatrixToMat4(modelViewMatrix) * \nvec4(-cameraPosition, 0.0, 1.0);\nvPos = renderer2x * vec4(vertexPosition, 0.0, 1.0);\ngl_Position = vPos+center;\nvTextureCoord = textureCoord;\n}";
Grape2D.WebGLProgram.DEFAULT_TEXTR_FS="precision mediump float;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\nvoid main(void) {\ngl_FragColor = texture2D(uSampler, vec2(vTextureCoord.t, vTextureCoord.s));\n}";Grape2D.WebGLProgram.G2D_SPECIFIC_FN="mat4 grape2DMatrixToMat4(mat3 m){\nreturn mat4(m[0][0], m[1][0], 0, m[2][0], m[0][1], m[1][1], 0, m[2][1], 0, 0, 1, 0, m[0][2], m[1][2], 0, m[2][2]);\n}";Grape2D.WebGLRenderer=function(a){a=a||{};this.width=a.width||800;this.height=a.height||600;this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.gl=this.canvas.getContext("webgl");this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.enable(this.gl.BLEND);this.clearColor=a.clearColor||new Grape2D.Color;this.gl.clearColor(this.clearColor.getR(),this.clearColor.getG(),this.clearColor.getB(),this.clearColor.getA());this.clearFlag=
a.depthBuffer?this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT:this.gl.COLOR_BUFFER_BIT;this.buffer=this.gl.createBuffer();this.shaderProgram=null;this.textureShaderProgram=(a.textureShaderProgram||Grape2D.WebGLProgram.createTextureDefault()).compile(this.gl);this.colorShaderProgram=(a.colorShaderProgram||Grape2D.WebGLProgram.createColorDefault()).compile(this.gl);this.modelView=new Grape2D.MatrixStack;this.projection=new Grape2D.Matrix;this.colorMode=this.gl.LINE_LOOP;this.color=new Grape2D.Color([0,
0,0,1]);this.camera=null;this.rawCamera=new Grape2D.Camera({transformation:Grape2D.Matrix.createFromTranslation(-this.getHalfWidth(),-this.getHalfHeight())});var b=this;this.canvas.addEventListener("resize",function(){b.updateProjection()},!1);this.updateProjection()};Grape2D.WebGLRenderer.prototype=Object.create(Grape2D.Renderer.prototype);Grape2D.WebGLRenderer.prototype.setClearColor=function(a){this.clearColor.set(a)};
Grape2D.WebGLRenderer.prototype.updateProjection=function(){this.projection=Grape2D.Matrix.createFromScale(2/this.width,-2/this.height)};Grape2D.WebGLRenderer.prototype.getWidth=function(){return this.width};Grape2D.WebGLRenderer.prototype.getHalfWidth=function(){return this.width/2};Grape2D.WebGLRenderer.prototype.setWidth=function(a){this.width=a};Grape2D.WebGLRenderer.prototype.getHeight=function(){return this.height};
Grape2D.WebGLRenderer.prototype.getHalfHeight=function(){return this.height/2};Grape2D.WebGLRenderer.prototype.setHeight=function(a){this.height=a};Grape2D.WebGLRenderer.prototype.renderColoredShape=function(a){};
Grape2D.WebGLRenderer.prototype.generateTextureBuffer=function(a){var b=this.gl,c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);Grape2D.Math.isPowerOfTwo(a.getWidth())||Grape2D.Math.isPowerOfTwo(a.getWidth())||(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE));
b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a.getBuffer());a.setGlBuffer(c)};Grape2D.WebGLRenderer.prototype.changeProgram=function(a){this.shaderProgram!==a&&(this.shaderProgram&&this.shaderProgram.unuse(),a.use(),this.shaderProgram=a)};
Grape2D.WebGLRenderer.prototype.renderTexture=function(a){this.changeProgram(this.textureShaderProgram);var b=a.getWidth(),c=a.getHeight(),d=this.gl,e=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,e);d.bufferData(d.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),d.STATIC_DRAW);a.glBuffer||this.generateTextureBuffer(a);var f=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f);d.bufferData(d.ARRAY_BUFFER,new Float32Array([0,0,0,c,b,c,b,0]),d.STATIC_DRAW);b=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,
b);d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),d.STATIC_DRAW);d.bindBuffer(d.ARRAY_BUFFER,f);this.shaderProgram.setAttribute("vertexPosition");d.bindBuffer(d.ARRAY_BUFFER,e);this.shaderProgram.setAttribute("textureCoord");d.activeTexture(d.TEXTURE0);d.bindTexture(d.TEXTURE_2D,a.glBuffer);this.shaderProgram.setUniform("uSampler",0);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,b);this.setMatrixUniforms();d.drawElements(d.TRIANGLES,6,d.UNSIGNED_SHORT,0)};
Grape2D.WebGLRenderer.prototype.renderREntity=function(a){this.modelView.pushIdentity().translate(a.getPosition()).translate(a.getTextureOffset());a.getTexture().render(this);this.modelView.pop()};Grape2D.WebGLRenderer.prototype.renderAABB=function(a){this.changeProgram(this.colorShaderProgram);var b=a.getHalfWidth(),c=a.getHalfHeight(),b=[b,c,b,-c,-b,-c,-b,c];this.modelView.pushIdentity().translate(a.getPosition());this.lineRender(new Float32Array(b),4);this.modelView.pop()};
Grape2D.WebGLRenderer.prototype.renderCircle=function(a){this.changeProgram(this.colorShaderProgram);for(var b=Grape2D.WebGLRenderer.CIRCLE_PRECISION,c,d=1/b,e=[],f=0;f<b;f++)c=f*d*Grape2D.Math.PIx2,e.push(a.radius*Math.cos(c),a.radius*Math.sin(c));this.modelView.pushIdentity().translate(a.getPosition());this.lineRender(new Float32Array(e),b);this.modelView.pop();this.renderPoint(a.getPosition())};
Grape2D.WebGLRenderer.prototype.lineRender=function(a,b,c){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.STATIC_DRAW);this.shaderProgram.setAttribute("vertexPosition");this.setMatrixUniforms();this.shaderProgram.setUniform("vertexColor",this.color.getR(),this.color.getG(),this.color.getB(),this.color.getA());this.gl.drawArrays(this.gl.LINE_LOOP,0,b)};
Grape2D.WebGLRenderer.prototype.setMatrixUniforms=function(){this.shaderProgram.setUniform("rendererProjectionMatrix",this.projection);this.shaderProgram.setUniform("cameraProjectionMatrix",this.camera.getProjection());this.shaderProgram.setUniform("modelViewMatrix",this.modelView.getHead());this.shaderProgram.setUniform("cameraPosition",this.camera.getLookAt().getX(),this.camera.getLookAt().getY())};
Grape2D.WebGLRenderer.prototype.renderPolygon=function(a){this.changeProgram(this.colorShaderProgram);this.modelView.pushIdentity().translate(a.getPosition());a=a.getVertexList();for(var b=a.length,c=[],d=0;d<b;d++)c.push(a[d].getX(),a[d].getY());this.lineRender(new Float32Array(c),b);this.modelView.pop()};Grape2D.WebGLRenderer.prototype.renderText=function(a){this.modelView.pushIdentity().translate(a.getPosition());this.renderTexture(a.getBuffer());this.modelView.pop()};
Grape2D.WebGLRenderer.prototype.renderAbsoluteText=function(a){var b=this.camera;this.camera=this.rawCamera;this.modelView.pushIdentity().translate(a.getPosition());this.renderTexture(a.getBuffer());this.modelView.pop();this.camera=b};Grape2D.WebGLRenderer.prototype.start=function(a){this.gl.viewport(0,0,this.width,this.height);this.gl.clear(this.clearFlag);this.camera=a;this.modelView.reset().pushIdentity()};Grape2D.WebGLRenderer.prototype.end=function(){};
Grape2D.WebGLRenderer.prototype.appendToDOMElement=function(a){a.appendChild(this.canvas)};Grape2D.WebGLRenderer.prototype.getDOMElement=function(){return this.canvas};Grape2D.WebGLRenderer.prototype.getContext=function(){return this.gl};Grape2D.WebGLRenderer.prototype.getColor=function(){return this.color};Grape2D.WebGLRenderer.prototype.setColor=function(a){this.color.set(a)};Grape2D.WebGLRenderer.prototype.setStrokeColorMode=function(){this.colorMode=this.gl.LINE_LOOP};
Grape2D.WebGLRenderer.prototype.setFillColorMode=function(){};Grape2D.WebGLRenderer.prototype.renderLineSegment=function(a,b){this.changeProgram(this.colorShaderProgram);var c=new Float32Array([a.getX(),a.getY(),b.getX(),b.getY()]);this.lineRender(c,2,this.gl.LINES)};
Grape2D.WebGLRenderer.prototype.renderPoint=function(a){this.changeProgram(this.colorShaderProgram);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([a.getX(),a.getY()]),this.gl.STATIC_DRAW);this.shaderProgram.setAttribute("vertexPosition");this.shaderProgram.setUniform("vertexColor",this.color.getR(),this.color.getG(),this.color.getB(),this.color.getA());this.setMatrixUniforms();this.gl.drawArrays(this.gl.POINTS,0,1)};
Grape2D.WebGLRenderer.CIRCLE_PRECISION=32;Grape2D.WireframeRenderer=function(a){this.renderer=a};Grape2D.WireframeRenderer.prototype=Object.create(Grape2D.Renderer.prototype);Grape2D.WireframeRenderer.prototype.getWidth=function(){return this.renderer.getWidth()};Grape2D.WireframeRenderer.prototype.getHalfWidth=function(){return this.renderer.getHalfWidth()};Grape2D.WireframeRenderer.prototype.setWidth=function(a){this.renderer.setWidth(a)};Grape2D.WireframeRenderer.prototype.getHeight=function(){return this.renderer.getHeight()};
Grape2D.WireframeRenderer.prototype.getHalfHeight=function(){return this.renderer.getHalfHeight()};Grape2D.WireframeRenderer.prototype.setHeight=function(a){this.renderer.setHeight(a)};Grape2D.WireframeRenderer.prototype.renderTexture=function(a,b){this.renderer.renderTexture(a,b)};Grape2D.WireframeRenderer.prototype.renderREntity=function(a){this.renderPoint(a.getPosition());a.getBoundingBox().render(this)};Grape2D.WireframeRenderer.prototype.renderAABB=function(a){this.renderer.renderAABB(a)};
Grape2D.WireframeRenderer.prototype.renderCircle=function(a){this.renderer.renderCircle(a)};Grape2D.WireframeRenderer.prototype.renderPolygon=function(a){this.renderer.renderPolygon(a)};Grape2D.WireframeRenderer.prototype.renderText=function(a){this.renderer.renderText(a)};Grape2D.WireframeRenderer.prototype.renderAbsoluteText=function(a){this.renderer.renderText(a)};Grape2D.WireframeRenderer.prototype.start=function(a){this.renderer.start(a)};Grape2D.WireframeRenderer.prototype.end=function(){this.renderer.end()};
Grape2D.WireframeRenderer.prototype.appendToDOMElement=function(a){this.renderer.appendToDOMElement(a)};Grape2D.WireframeRenderer.prototype.getDOMElement=function(){return this.renderer.getDOMElement()};Grape2D.WireframeRenderer.prototype.setStrokeColorMode=function(){this.renderer.setStrokeColorMode()};Grape2D.WireframeRenderer.prototype.setFillColorMode=function(){this.renderer.setFillColorMode()};Grape2D.WireframeRenderer.prototype.setColor=function(a){this.renderer.setColor(a)};
Grape2D.WireframeRenderer.prototype.renderColoredShape=function(a){this.renderer.renderColoredShape(a)};Grape2D.WireframeRenderer.prototype.renderLineSegment=function(a,b){this.renderer.renderLineSegment(a,b)};Grape2D.WireframeRenderer.prototype.renderPoint=function(a){this.renderer.renderPoint(a)};Grape2D.IShape=function(){};Grape2D.IShape.prototype={constructor:Grape2D.IShape,getPosition:function(){},setPosition:function(a){},render:function(a){},createBV:function(a){},getStaticType:function(){}};Grape2D.Shape=function(a){Grape2D.IShape.call(this);a=a||{};this.position=new Grape2D.Vector;a.position&&this.position.set(a.position)};Grape2D.Shape.prototype=Object.create(Grape2D.IShape.prototype);Grape2D.Shape.prototype.getPosition=function(){return this.position};Grape2D.Shape.prototype.setPosition=function(a){this.position.set(a)};Grape2D.Shape.prototype.render=function(a){};Grape2D.Shape.prototype.createBV=function(a){return null};Grape2D.Shape.prototype.getStaticType=function(){return""};Grape2D.ColoredShape=function(a){Grape2D.IShape.call(this);this.color=a.color||new Grape2D.Color;this.shape=a.shape};Grape2D.ColoredShape.prototype=Object.create(Grape2D.IShape.prototype);Grape2D.ColoredShape.prototype.getColor=function(){return this.color};Grape2D.ColoredShape.prototype.setColor=function(a){this.color=a};Grape2D.ColoredShape.prototype.getShape=function(){return this.shape};Grape2D.ColoredShape.prototype.setShape=function(a){this.shape=a};
Grape2D.ColoredShape.prototype.getPosition=function(){return this.shape.getPosition()};Grape2D.ColoredShape.prototype.setPosition=function(a){this.shape.setPosition(a)};Grape2D.ColoredShape.prototype.render=function(a){a.renderColoredShape(this)};Grape2D.ColoredShape.prototype.createBV=function(a){return this.shape.createBV(a)};Grape2D.ColoredShape.prototype.getStaticType=function(){return Grape2D.ColoredShape.TYPE};Grape2D.ColoredShape.TYPE="COLOREDSHAPE";Grape2D.AABB=function(a){Grape2D.Shape.call(this,a);this.min=new Grape2D.Vector;this.max=new Grape2D.Vector;if(a.width&&a.height)this.setWidth(a.width),this.setHeight(a.height);else{var b=this.getPosition();this.min.setX(a.minX);this.min.setY(a.minY);this.max.setX(a.maxX);this.max.setY(a.maxY);b.setX(a.minX+(this.max.getX()-this.min.getX())/2);b.setY(a.minY+(this.max.getY()-this.min.getY())/2)}};Grape2D.AABB.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.AABB.prototype.getMin=function(){return this.min};
Grape2D.AABB.prototype.getMinX=function(){return this.min.getX()};Grape2D.AABB.prototype.getMinY=function(){return this.min.getY()};Grape2D.AABB.prototype.getMax=function(){return this.max};Grape2D.AABB.prototype.getMaxX=function(){return this.max.getX()};Grape2D.AABB.prototype.getMaxY=function(){return this.max.getY()};Grape2D.AABB.prototype.getWidth=function(){return Grape2D.Math.abs(this.max.getX()-this.min.getX())};
Grape2D.AABB.prototype.getHeight=function(){return Grape2D.Math.abs(this.max.getY()-this.min.getY())};Grape2D.AABB.prototype.getHalfWidth=function(){return this.getWidth()/2};Grape2D.AABB.prototype.getHalfHeight=function(){return this.getHeight()/2};Grape2D.AABB.prototype.setWidth=function(a){a/=2;this.min.setX(this.getPosition().getX()-a);this.max.setX(this.getPosition().getX()+a)};
Grape2D.AABB.prototype.setHeight=function(a){a/=2;this.min.setY(this.getPosition().getY()-a);this.max.setY(this.getPosition().getY()+a)};Grape2D.AABB.prototype.render=function(a){a.renderAABB(this)};Grape2D.AABB.prototype.createBV=function(a){return a.createFromAABB(this)};Grape2D.AABB.prototype.getStaticType=function(){return Grape2D.AABB.TYPE};
Grape2D.AABB.prototype.setPosition=function(a){var b=a.clone().sub(this.getPosition());this.min.add(b);this.max.add(b);Grape2D.Shape.prototype.setPosition.call(this,a)};Grape2D.AABB.TYPE="AABB";Grape2D.Circle=function(a){Grape2D.Shape.call(this,a);this.radius=a.radius};Grape2D.Circle.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.Circle.prototype.getRadius=function(){return this.radius};Grape2D.Circle.prototype.setRadius=function(a){this.radius=a};Grape2D.Circle.prototype.render=function(a){a.renderCircle(this)};Grape2D.Circle.prototype.createBV=function(a){return a.createFromCircle(this)};Grape2D.Circle.prototype.getStaticType=function(){return Grape2D.Circle.TYPE};
Grape2D.Circle.TYPE="Circle";Grape2D.Polygon=function(a){Grape2D.Shape.call(this,a);this.vertexList=a.vertexList;this.computedVertexList=[];this.computeVertexList()};Grape2D.Polygon.prototype=Object.create(Grape2D.Shape.prototype);Grape2D.Polygon.prototype.getVertexList=function(){return this.vertexList};Grape2D.Polygon.prototype.setVertexList=function(a){this.vertexList=a;this.computeVertexList()};Grape2D.Polygon.prototype.getComputedVertexList=function(){return this.computedVertexList};Grape2D.Polygon.prototype.render=function(a){a.renderPolygon(this)};
Grape2D.Polygon.prototype.createBV=function(a){return a.createFromPolygon(this)};Grape2D.Polygon.prototype.getStaticType=function(){return Grape2D.Polygon.TYPE};Grape2D.Polygon.prototype.computeVertexList=function(){this.computedVertexList=[];for(var a=0;a<this.vertexList.length;a++)this.computedVertexList.push(this.getPosition().clone().add(this.vertexList[a]))};Grape2D.Polygon.prototype.setPosition=function(a){Grape2D.Shape.prototype.setPosition.call(this,a);this.computeVertexList()};
Grape2D.Polygon.TYPE="Polygon";Grape2D.Ray=function(a,b,c){this.start=(new Grape2D.Vector).set(a);this.direction=(new Grape2D.Vector).set(b);this.length=c;this.end=b.clone().multiplyByScalar(c).add(a)};Grape2D.Ray.prototype={constructor:Grape2D.Ray,getStart:function(){return this.start},getDirection:function(){return this.direction},getLength:function(){return this.length},getEnd:function(){return this.end},getStaticType:function(){return Grape2D.Ray.STATIC_TYPE}};
Grape2D.Ray.createFromPoints=function(a,b){var c=b.clone().sub(a).normalize();return new Grape2D.Ray(a,c,a.distanceTo(b))};Grape2D.Ray.STATIC_TYPE="Ray";Grape2D.IEntity=function(){};Grape2D.IEntity.prototype={constructor:Grape2D.IEntity,getPosition:function(){},setPosition:function(a){},getBoundingBox:function(){},setBoundingBox:function(a){},getBoundingBoxOffset:function(){},setBoundingBoxOffset:function(a){},update:function(a){},process:function(a){}};Grape2D.IEntityProcessor=function(){};Grape2D.IEntityProcessor.prototype={constructor:Grape2D.IEntityProcessor,processEntity:function(a){},processREntity:function(a){},processNetworkEntity:function(a){}};Grape2D.RenderableEntity=function(){Grape2D.IEntity.call(this)};Grape2D.RenderableEntity.prototype=Object.create(Grape2D.IEntity.prototype);Grape2D.RenderableEntity.prototype.getRenderPosition=function(){};Grape2D.Entity=function(a){this.position=new Grape2D.Vector;a.position&&this.position.set(a.position);this.boundingBox=a.boundingBox;this.boundingBoxOffset=new Grape2D.Vector;a.boundingBoxOffset&&this.boundingBoxOffset.set(a.boundingBoxOffset);this.computeBoundingBoxPosition()};Grape2D.Entity.prototype=Object.create(Grape2D.IEntity.prototype);Grape2D.Entity.prototype.getRenderPosition=function(){return this.position};Grape2D.Entity.prototype.getPosition=function(){return this.position};
Grape2D.Entity.prototype.setPosition=function(a){this.position.set(a)};Grape2D.Entity.prototype.getBoundingBox=function(){return this.boundingBox};Grape2D.Entity.prototype.setBoundingBox=function(a){this.boundingBox=a;this.computeBoundingBoxPosition()};Grape2D.Entity.prototype.getBoundingBoxOffset=function(){return this.boundingBoxOffset};Grape2D.Entity.prototype.setBoundingBoxOffset=function(a){this.boundingBoxOffset.set(a);this.computeBoundingBoxPosition()};
Grape2D.Entity.prototype.computeBoundingBoxPosition=function(){this.boundingBox.setPosition(this.position.clone().add(this.boundingBoxOffset))};Grape2D.Entity.prototype.update=function(a){};Grape2D.Entity.prototype.process=function(a){a.processEntity(this)};Grape2D.REntity=function(a){this.entity=a.entity;this.texture=a.texture;this.textureOffset=new Grape2D.Vector;a.textureOffset&&this.textureOffset.set(a.textureOffset)};Grape2D.REntity.prototype=Object.create(Grape2D.IEntity.prototype);Grape2D.REntity.prototype.render=function(a){a.renderREntity(this)};Grape2D.REntity.prototype.getEntity=function(){return this.entity};Grape2D.REntity.prototype.setEntity=function(a){this.entity=a};Grape2D.REntity.prototype.getTexture=function(){return this.texture};
Grape2D.REntity.prototype.setTexture=function(a){this.texture=a};Grape2D.REntity.prototype.getTextureOffset=function(){return this.textureOffset};Grape2D.REntity.prototype.setTextureOffset=function(a){this.textureOffset=a};Grape2D.REntity.prototype.getPosition=function(){return this.entity.getRenderPosition()};Grape2D.REntity.prototype.setPosition=function(a){return this.entity.setPosition(a)};Grape2D.REntity.prototype.getBoundingBox=function(){return this.entity.getBoundingBox()};
Grape2D.REntity.prototype.setBoundingBox=function(a){return this.entity.setBoundingBox(a)};Grape2D.REntity.prototype.getBoundingBoxOffset=function(){return this.entity.getBoundingBoxOffset()};Grape2D.REntity.prototype.setBoundingBoxOffset=function(a){return this.entity.setBoundingBoxOffset(a)};Grape2D.REntity.prototype.update=function(a){this.entity.update(a)};Grape2D.REntity.prototype.process=function(a){a.processREntity(this)};Grape2D.INetworkEntity=function(){};Grape2D.INetworkEntity.prototype=Object.create(Grape2D.IEntity.prototype);Grape2D.INetworkEntity.prototype.getUUID=function(){};Grape2D.INetworkEntity.prototype.updateNetworkProperties=function(){};Grape2D.NetworkEntity=function(a,b){this.entity=a;this.uuid=b||Grape2D.utils.UUIDGeneratorSingleton.generate();this.interpolatingPosition=new Grape2D.Vector};Grape2D.NetworkEntity.prototype=Object.create(Grape2D.INetworkEntity.prototype);Grape2D.NetworkEntity.prototype.getUUID=function(){return this.uuid};Grape2D.NetworkEntity.prototype.getEntity=function(){return this.entity};Grape2D.NetworkEntity.prototype.setEntity=function(a){this.entity=a};
Grape2D.NetworkEntity.prototype.getRenderPosition=function(){return Grape2D.Vector.lerp(this.getPosition(),this.interpolatingPosition,Grape2D.SnapshotManagerSingleton.getLerpPercent())};Grape2D.NetworkEntity.prototype.getPosition=function(){return this.entity.getPosition()};Grape2D.NetworkEntity.prototype.setPosition=function(a){return this.entity.setPosition(a)};Grape2D.NetworkEntity.prototype.getBoundingBox=function(){return this.entity.getBoundingBox()};
Grape2D.NetworkEntity.prototype.setBoundingBox=function(a){return this.entity.setBoundingBox(a)};Grape2D.NetworkEntity.prototype.getBoundingBoxOffset=function(){return this.entity.getBoundingBoxOffset()};Grape2D.NetworkEntity.prototype.setBoundingBoxOffset=function(a){return this.entity.setBoundingBoxOffset(a)};Grape2D.NetworkEntity.prototype.update=function(a){};
Grape2D.NetworkEntity.prototype.updateNetworkProperties=function(){var a=Grape2D.SnapshotManagerSingleton.getNetworkEntity(this.getEntity());this.interpolatingPosition.setXY(a.position.x,a.position.y)};Grape2D.NetworkEntity.prototype.process=function(a){a.processNetworkEntity(this)};Grape2D.DefaultSnapshotDecoder=function(){this.entities={};this.events=[];this.time=0};Grape2D.DefaultSnapshotDecoder.prototype={constructor:Grape2D.DefaultSnapshotDecoder};Grape2D.DefaultSnapshotDecoder.prototype.decode=function(a){this.entities={};this.events=[];this.time=0;var b=JSON.parse(a);a=b.events;var c=b.entities;this.time=b.time;for(var d in c)this.entities[d]=this.createNetworkEntity(c[d]);for(d=0;b=a[d++];)this.events.push(this.createNetworkEvent(b))};
Grape2D.DefaultSnapshotDecoder.prototype.createNetworkEntity=function(a){return{position:{x:a.position.x,y:a.position.y}}};Grape2D.DefaultSnapshotDecoder.prototype.createNetworkEvent=function(a){return{type:a.type,data:a.data}};Grape2D.DefaultSnapshotDecoder.prototype.getNetworkEntities=function(){return this.entities};Grape2D.DefaultSnapshotDecoder.prototype.getNetworkEvents=function(){return this.events};Grape2D.DefaultSnapshotDecoder.prototype.getTime=function(){return this.time};
Grape2D.DefaultSnapshotDecoder.prototype.getResultPacked=function(){return{time:this.time,networkEvents:this.events,networkEntities:this.entities}};Grape2D.DefaultSnapshotEncoder=function(a){this.clock=a;this.events=[];this.entities={}};Grape2D.DefaultSnapshotEncoder.prototype=Object.create(Grape2D.IEntityProcessor.prototype);Grape2D.DefaultSnapshotEncoder.prototype.start=function(){this.events=[];this.entities={}};Grape2D.DefaultSnapshotEncoder.prototype.processEntity=function(a){};Grape2D.DefaultSnapshotEncoder.prototype.processREntity=function(a){a.process(this)};
Grape2D.DefaultSnapshotEncoder.prototype.processNetworkEntity=function(a){this.entities[a.getUUID()]={position:{x:a.getPosition().getX(),y:a.getPosition().getY()}}};Grape2D.DefaultSnapshotEncoder.prototype.addNetworkEvent=function(a){this.events.push(a)};Grape2D.DefaultSnapshotEncoder.prototype.getSnapshotEncoded=function(){var a=JSON.stringify({time:this.clock.getTime(),networkEvents:this.events,NetworkEntities:this.entities});this.events=[];this.entities={};return a};Grape2D.SnapshotHistory=function(a){this.cap=a||10;this.history=[]};
Grape2D.SnapshotHistory.prototype={constructor:Grape2D.SnapshotHistory,add:function(a){this.history.length>=this.cap&&this.history.shift();this.history.push(a);this.history.sort(function(a,c){return a.getTime()-c.getTime()})},getBefore:function(a){for(var b=this.history.length-1;0<=b;b--)if(this.history[b].time<a)return this.history[b];return null},getAfter:function(a){for(var b=0;b<this.history.length;b++)if(this.history[b].time>a)return this.history[b];return null},getHistory:function(){return this.history},
getCap:function(){return this.cap},setCap:function(a){for(this.cap=a;this.history.length>this.cap;)this.history.shift()}};Grape2D.SnapshotManager=function(a,b,c){this.clock=a;this.history=b;this.lerp=c||100;this.iLerp=1/this.lerp;this.currentSnapshot=null;this.lerpPercent=0};
Grape2D.SnapshotManager.prototype={constructor:Grape2D.SnapshotManager,getSnapshot:function(){return this.currentSnapshot},getNetworkEntity:function(a){return this.currentSnapshot?this.currentSnapshot[a]:null},getLerpPercent:function(){return this.lerpPercent},update:function(){var a=this.clock.getTime();this.lerpPercent=(this.currentSnapshot=this.history.getBefore(a))?(a-this.lerp-this.currentSnapshot.getTime())/this.iLerp:0}};Grape2D.SnapshotManagerSingleton={instance:null,setInstance:function(a){Grape2D.SnapshotManagerSingleton.instance=a},getInstance:function(){return Grape2D.SnapshotManagerSingleton.instance},getNetworkEntity:function(a){return Grape2D.SnapshotManagerSingleton.instance.getNetworkEntity(a)},getLerpPercent:function(){return Grape2D.SnapshotManagerSingleton.instance.getLerpPercent()},update:function(){Grape2D.SnapshotManagerSingleton.instance.update()}};Grape2D.InputManager=function(a){this.mouseUp=[];this.mouseDown=[];this.mouseMove=[];this.mouseOver=[];this.mouseOut=[];this.mouseWheel=[];this.click=[];this.dragStartClbk=[];this.drag=[];this.dragStop=[];this.dragStart=new Grape2D.Vector;this.isDragging=!1;this.resize=[];this.keyDown={};this.keyUp={};this.keyPress={};this.rendererBinding=a;this.bindToRenderer(a)};
Grape2D.InputManager.prototype={constructor:Grape2D.InputManager,bindToRenderer:function(a){this.rendererBinding=a;a=this.rendererBinding.getDOMElement();var b=this;a.addEventListener("mouseup",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseUp),!1);a.addEventListener("mousedown",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseDown),!1);a.addEventListener("mousemove",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseMove),!1);a.addEventListener("mouseover",Grape2D.InputManager.bindFn(this.rendererBinding,
this.mouseOver),!1);a.addEventListener("mouseout",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseOut),!1);a.addEventListener("mousewheel",Grape2D.InputManager.bindFn(this.rendererBinding,this.mouseWheel),!1);a.addEventListener("click",Grape2D.InputManager.bindFn(this.rendererBinding,this.click),!1);this.addMouseDown(function(a){b.dragStart.set(a.getPosition());b.isDragging=!0});var c=!1;this.addMouseMove(function(a){if(b.isDragging){var e=new Grape2D.Vector(a.getRaw().pageX,a.getRaw().pageY);
a=new Grape2D.InputManagerDragEvent(a.getRaw(),b.dragStart);for(var f=b.getDragBindStack(),g=0;g<f.length;g++)f[g](a);b.dragStart.set(e);if(!c)for(e=b.dragStartClbk,f=0;f<e.length;f++)e[f](a);c=!0}});this.addMouseUp(function(a){if(b.isDragging&&c){var e=b.dragStop;new Grape2D.Vector(a.getRaw().pageX,a.getRaw().pageY);a=new Grape2D.InputManagerDragEvent(a.getRaw(),b.dragStart);for(var f=0;f<e.length;f++)e[f](a)}c=b.isDragging=!1});this.addMouseOut(function(a){if(b.isDragging&&c){var e=b.dragStop;new Grape2D.Vector(a.getRaw().pageX,
a.getRaw().pageY);a=new Grape2D.InputManagerDragEvent(a.getRaw(),b.dragStart);for(var f=0;f<e.length;f++)e[f](a)}c=b.isDragging=!1})},getMouseUpBindStack:function(){return this.mouseUp},addMouseUp:function(a){this.mouseUp.push(a)},removeMouseUp:function(a){0<=this.mouseUp.indexOf(a)&&this.mouseUp.splice(this.mouseUp.indexOf(a),1)},getMouseDownBindStack:function(){return this.mouseDown},addMouseDown:function(a){this.mouseDown.push(a)},removeMouseDown:function(a){0<=this.mouseDown.indexOf(a)&&this.mouseDown.splice(this.mouseDown.indexOf(a),
1)},getMouseMoveBindStack:function(){return this.mouseMove},addMouseMove:function(a){this.mouseMove.push(a)},removeMouseMove:function(a){0<=this.mouseMove.indexOf(a)&&this.mouseMove.splice(this.mouseMove.indexOf(a),1)},getMouseOverBindStack:function(){return this.mouseOver},addMouseOver:function(a){this.mouseOver.push(a)},removeMouseOver:function(a){0<=this.mouseOver.indexOf(a)&&this.mouseOver.splice(this.mouseOver.indexOf(a),1)},getMouseOutBindStack:function(){return this.mouseOut},addMouseOut:function(a){this.mouseOut.push(a)},
removeMouseOut:function(a){0<=this.mouseOut.indexOf(a)&&this.mouseOut.splice(this.mouseOut.indexOf(a),1)},getMouseWheelBindStack:function(){return this.mouseWheel},addMouseWheel:function(a){this.mouseWheel.push(a)},removeMouseWheel:function(a){0<=this.mouseWheel.indexOf(a)&&this.mouseWheel.splice(this.mouseWheel.indexOf(a),1)},getResizeBindStack:function(){return this.resize},addResize:function(a){this.resize.push(a);Grape2D.InputManager.registerGlobalResize(a)},removeResize:function(a,b){0<=this.resize.indexOf(b)&&
this.resize.splice(this.resize.indexOf(b),1);Grape2D.InputManager.unregisterGlobalResize(b)},getKeyDownBindStack:function(){return this.keyDown},addKeyDown:function(a,b){this.keyDown[a]||(this.keyDown[a]=[]);this.keyDown[a].push(b);Grape2D.InputManager.registerGlobalKeyDown(a,b)},removeKeyDown:function(a,b){if(this.keyDown[a]){var c=this.keyDown[a].indexOf(b);0<=c&&(this.keyDown[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyDown(a,b))}},getKeyUpBindStack:function(){return this.keyDown},addKeyUp:function(a,
b){this.keyUp[a]||(this.keyUp[a]=[]);this.keyUp[a].push(b);Grape2D.InputManager.registerGlobalKeyUp(a,b)},removeKeyUp:function(a,b){if(this.keyUp[a]){var c=this.keyUp[a].indexOf(b);0<=c&&(this.keyUp[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyUp(a,b))}},getKeyPressBindStack:function(){return this.keyPress},addKeyPress:function(a,b){this.keyPress[a]||(this.keyPress[a]=[]);this.keyPress[a].push(b);Grape2D.InputManager.registerGlobalKeyPress(a,b)},removeKeyPress:function(a,b){if(this.keyPress[a]){var c=
this.keyPress[a].indexOf(b);0<=c&&(this.keyPress[a].splice(c,1),Grape2D.InputManager.unregisterGlobalKeyPress(a,b))}},getDragBindStack:function(){return this.drag},addDragStart:function(a){this.dragStartClbk.push(a)},addDrag:function(a){this.drag.push(a)},addDragStop:function(a){this.dragStop.push(a)},removeDrag:function(a){0<=this.drag.indexOf(a)&&this.drag.splice(this.drag.indexOf(a),1)},getClickBindStack:function(){return this.click},addClick:function(a){this.click.push(a)},removeClick:function(a){0<=
this.click.indexOf(a)&&this.click.splice(this.click.indexOf(a),1)}};Grape2D.InputManager.bindFn=function(a,b){return function(a){var d=0;for(a=new Grape2D.InputManagerMouseEvent(a);d<b.length;d++)b[d](a)}};Grape2D.InputManager.registerGlobalResize=function(a){Grape2D.InputManager.globalRegistry.resize.push(a)};Grape2D.InputManager.unregisterGlobalResize=function(a){a=Grape2D.InputManager.globalRegistry.resize.indexOf(a);0<=a&&Grape2D.InputManager.globalRegistry.resize.splice(a,1)};
Grape2D.InputManager.registerGlobalKeyDown=function(a,b){Grape2D.InputManager.globalRegistry.keyDown[a]||(Grape2D.InputManager.globalRegistry.keyDown[a]=[]);Grape2D.InputManager.globalRegistry.keyDown[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyDown=function(a,b){if(Grape2D.InputManager.globalRegistry.keyDown[a]){var c=Grape2D.InputManager.globalRegistry.keyDown[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyDown[a].splice(c,1)}};
Grape2D.InputManager.registerGlobalKeyUp=function(a,b){Grape2D.InputManager.globalRegistry.keyUp[a]||(Grape2D.InputManager.globalRegistry.keyUp[a]=[]);Grape2D.InputManager.globalRegistry.keyUp[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyUp=function(a,b){if(Grape2D.InputManager.globalRegistry.keyUp[a]){var c=Grape2D.InputManager.globalRegistry.keyUp[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyUp[a].splice(c,1)}};
Grape2D.InputManager.registerGlobalKeyPress=function(a,b){Grape2D.InputManager.globalRegistry.keyPress[a]||(Grape2D.InputManager.globalRegistry.keyPress[a]=[]);Grape2D.InputManager.globalRegistry.keyPress[a].push(b)};Grape2D.InputManager.unregisterGlobalKeyPress=function(a,b){if(Grape2D.InputManager.globalRegistry.keyPress[a]){var c=Grape2D.InputManager.globalRegistry.keyPress[a].indexOf(b);0<=c&&Grape2D.InputManager.globalRegistry.keyPress[a].splice(c,1)}};
Grape2D.InputManager.keyDispatcher=function(a){return function(b){var c=b.keyCode;if(a[c])for(var d=0;d<a[c].length;d++)a[c][d](b)}};Grape2D.InputManager.resizeDispatcher=function(){return function(a){for(var b=0;b<Grape2D.InputManager.globalRegistry.resize.length;b++)Grape2D.InputManager.globalRegistry.resize[b](a)}};
Grape2D.InputManager.setupGlobals=function(){Grape2D.NODE||(window.addEventListener("resize",Grape2D.InputManager.resizeDispatcher(),!1),window.addEventListener("keyup",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyUp),!1),window.addEventListener("keydown",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyDown),!1),window.addEventListener("keypress",Grape2D.InputManager.keyDispatcher(Grape2D.InputManager.globalRegistry.keyPress),!1))};
Grape2D.InputManager.globalRegistry={resize:[],keyDown:{},keyUp:{},keyPress:{}};
Grape2D.InputManager.KEY={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Backspace:8,Tab:9,Enter:13,SHIFT:16,CTRL:17,ALT:18,META:91,META_RIGHT:93,
"Caps Lock":20,Esc:27,Spacebar:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,"Num Lock":144,ScrLk:145,"Pause/Break":19};Grape2D.InputManager.setupGlobals();Grape2D.InputManagerEvent=function(a){this.raw=a};Grape2D.InputManagerEvent.prototype={constructor:Grape2D.InputManagerEvent,getRaw:function(){return this.raw}};Grape2D.InputManagerMouseEvent=function(a){Grape2D.InputManagerEvent.call(this,a);var b=a.target.getBoundingClientRect();this.target=a.target;this.position=new Grape2D.Vector(a.clientX-b.left,a.clientY-b.top);this.button=a.button;this.wheelDelta=0;"mousewheel"==a.type&&(this.wheelDelta=a.wheelDelta)};Grape2D.InputManagerMouseEvent.prototype=Object.create(Grape2D.InputManagerEvent.prototype);Grape2D.InputManagerMouseEvent.prototype.getTarget=function(){return this.target};
Grape2D.InputManagerMouseEvent.prototype.getPosition=function(){return this.position};Grape2D.InputManagerMouseEvent.prototype.getWheelDelta=function(){return this.wheelDelta};Grape2D.InputManagerDragEvent=function(a,b){Grape2D.InputManagerEvent.call(this,a);var c=a.target.getBoundingClientRect();this.target=a.target;this.start=(new Grape2D.Vector).set(b);this.end=new Grape2D.Vector(a.clientX-c.left,a.clientY-c.top);this.delta=this.end.clone().sub(this.start)};Grape2D.InputManagerDragEvent.prototype=Object.create(Grape2D.InputManagerEvent.prototype);Grape2D.InputManagerDragEvent.prototype.getTarget=function(){return this.target};
Grape2D.InputManagerDragEvent.prototype.getStart=function(){return this.start};Grape2D.InputManagerDragEvent.prototype.getEnd=function(){return this.end};Grape2D.InputManagerDragEvent.prototype.getDelta=function(){return this.delta};Grape2D.WASDController=function(a){this.dLock=this.sLock=this.aLock=this.wLock=!1;this.im=new Grape2D.InputManager(a);var b=this;this.im.addKeyDown(Grape2D.InputManager.KEY.W,function(){b.sLock||b.wLock||(b.w(),b.wLock=!0)});this.im.addKeyUp(Grape2D.InputManager.KEY.W,function(){b.wLock&&b.wUp();b.wLock=!1});this.im.addKeyDown(Grape2D.InputManager.KEY.S,function(){b.wLock||b.sLock||(b.s(),b.sLock=!0)});this.im.addKeyUp(Grape2D.InputManager.KEY.S,function(){b.sLock&&b.sUp();b.sLock=!1});this.im.addKeyDown(Grape2D.InputManager.KEY.A,
function(){b.dLock||b.aLock||(b.a(),b.aLock=!0)});this.im.addKeyUp(Grape2D.InputManager.KEY.A,function(){b.aLock&&b.aUp();b.aLock=!1});this.im.addKeyDown(Grape2D.InputManager.KEY.D,function(){b.aLock||b.dLock||(b.d(),b.dLock=!0)});this.im.addKeyUp(Grape2D.InputManager.KEY.D,function(){b.dLock&&b.dUp();b.dLock=!1})};
Grape2D.WASDController.prototype={constructor:Grape2D.WASDController,w:function(){},wUp:function(){},isW:function(){return this.wLock},a:function(){},aUp:function(){},isA:function(){return this.aLock},s:function(){},sUp:function(){},isS:function(){return this.sLock},d:function(){},dUp:function(){},isD:function(){return this.dLock}};Grape2D.Camera=function(a){a=a||{};this.scale=a.scale||new Grape2D.Vector(1,1);this.lookAt=a.lookAt||new Grape2D.Vector;this.projection=a.projection||new Grape2D.Matrix;this.cM=new Grape2D.Matrix;this.icM=new Grape2D.Matrix;this.computeMatrix()};
Grape2D.Camera.prototype={constructor:Grape2D.Camera,getProjection:function(){return this.projection},computeMatrix:function(){this.cM.setFromMatrix(this.projection);this.cM.scale(this.scale.getX(),this.scale.getY());this.icM=this.cM.clone().invert()},wcsToVcs:function(a,b){return b?this.cM.multiplyByMatrix(b).multiplyByVector(a.clone().sub(this.getLookAt())):this.cM.multiplyByVector(a.clone().sub(this.getLookAt()))},vcsToWcs:function(a,b){var c=b.clone();c.setX(c.getX()-a.getHalfWidth());c.setY(c.getY()-
a.getHalfHeight());return c=this.icM.multiplyByVector(c).add(this.getLookAt())},rescale:function(a){this.scale.set(a);this.computeMatrix()},setLookAt:function(a){this.lookAt.set(a)},getLookAt:function(){return this.lookAt},getScale:function(){return this.scale},computeShape:function(a){var b=(new Grape2D.Vector).set(this.lookAt),c=a.getWidth()/this.scale.getX();a=a.getHeight()/this.scale.getY();return new Grape2D.AABB({position:b,width:c,height:a})}};Grape2D.FollowingCamera=function(a){Grape2D.Camera.call(this,a);this.entityToFollow=a.entityToFollow};Grape2D.FollowingCamera.prototype=Object.create(Grape2D.Camera.prototype);Grape2D.FollowingCamera.prototype.getLookAt=function(){return this.entityToFollow.getPosition()};Grape2D.FollowingCamera.prototype.getEntityToFollow=function(){return this.entityToFollow};Grape2D.FollowingCamera.prototype.setEntityToFollow=function(a){this.entityToFollow=a};Grape2D.Map=function(){};Grape2D.Map.prototype={constructor:Grape2D.Map,add:function(a){},remove:function(a){},query:function(a){},queryPoint:function(a){},queryRay:function(a,b,c){},clear:function(){},update:function(a,b){},rebuild:function(){}};Grape2D.SimpleMap=function(){this.entities=[]};Grape2D.SimpleMap.prototype=Object.create(Grape2D.Map);Grape2D.SimpleMap.prototype.add=function(a){this.entities.push(a)};Grape2D.SimpleMap.prototype.remove=function(a){this.entities.splice(this.entities.indexOf(a),1)};Grape2D.SimpleMap.prototype.query=function(a){return this.entities};Grape2D.SimpleMap.prototype.queryPoint=function(a){return this.entities};Grape2D.SimpleMap.prototype.queryRay=function(a,b,c){return null};
Grape2D.SimpleMap.prototype.clear=function(){this.entities=[]};Grape2D.SimpleMap.prototype.update=function(a,b){for(var c=0;c<this.entities.length;c++)this.entities[c].update(a,b)};Grape2D.SimpleMap.prototype.rebuild=function(){};Grape2D.CollisionChecker=function(){};
Grape2D.CollisionChecker.prototype={constructor:Grape2D.CollisionChecker,aabbVsAabb:function(a,b){},aabbVsCircle:function(a,b){},aabbVsPolygon:function(a,b){},aabbVsPoint:function(a,b){},aabbVsRay:function(a,b){},circleVsAabb:function(a,b){},circleVsCircle:function(a,b){},circleVsPolygon:function(a,b){},circleVsPoint:function(a,b){},circleVsRay:function(a,b){},polygonVsAabb:function(a,b){},polygonVsCircle:function(a,b){},polygonVsPolygon:function(a,b){},polygonVsPoint:function(a,b){},polygonVsRay:function(a,
b){}};Grape2D.GenericCollisionChecker=function(){};Grape2D.GenericCollisionChecker.prototype=Object.create(Grape2D.CollisionChecker);Grape2D.GenericCollisionChecker.prototype.aabbVsAabb=function(a,b){return 0<Grape2D.Math.overlaps({min:a.getMinX(),max:a.getMaxX()},{min:b.getMinX(),max:b.getMaxX()})&&0<Grape2D.Math.overlaps({min:a.getMinY(),max:a.getMaxY()},{min:b.getMinY(),max:b.getMaxY()})};
Grape2D.GenericCollisionChecker.prototype.aabbVsCircle=function(a,b){var c=Grape2D.Math.clamp(b.getPosition().getX(),a.getMinX(),a.getMaxX()),d=Grape2D.Math.clamp(b.getPosition().getY(),a.getMinY(),a.getMaxY());return Grape2D.Math.sq(b.getPosition().getX()-c)+Grape2D.Math.sq(b.getPosition().getY()-d)<=Grape2D.Math.sq(b.getRadius())};Grape2D.GenericCollisionChecker.prototype.aabbVsPoint=function(a,b){return a.getMinX()<=b.getX()&&a.getMaxX()>=b.getX()&&a.getMinY()<=b.getY()&&a.getMaxY()>=b.getY()};
Grape2D.GenericCollisionChecker.prototype.aabbVsRay=function(a,b){return!1};Grape2D.GenericCollisionChecker.prototype.circleVsAabb=function(a,b){return this.aabbVsCircle(b,a)};Grape2D.GenericCollisionChecker.prototype.circleVsCircle=function(a,b){return Grape2D.Math.sqrt(Grape2D.Math.sq(b.getPosition().getX()-a.getPosition().getX())+Grape2D.Math.sq(b.getPosition().getY()-a.getPosition().getY()))<=a.getRadius()+b.getRadius()};
Grape2D.GenericCollisionChecker.prototype.circleVsPoint=function(a,b){return Grape2D.Math.sqrt(Grape2D.Math.sq(a.getPosition().getX()-b.getX())+Grape2D.Math.sq(a.getPosition().getY()-b.getY()))<=a.getRadius()};Grape2D.GenericCollisionChecker.prototype.circleVsRay=function(a,b){return!1};Grape2D.GenericCollisionChecker.prototype.polygonVsAabb=function(a,b){return this.aabbVsPolygon(b,a)};Grape2D.GenericCollisionChecker.prototype.polygonVsCircle=function(a,b){return this.circleVsPolygon(b,a)};
Grape2D.GenericCollisionChecker.prototype.aabbVsPolygon=function(a,b){return!1};
Grape2D.GenericCollisionChecker.prototype.circleVsPolygon=function(a,b){for(var c=Grape2D.SATUtils.computePolygonAxis(b),d=b.getComputedVertexList(),e=0;e<d.length;e++)c.push(a.getPosition().clone().sub(d[e]).normalize());for(var d=Grape2D.SATUtils.computeIntervals(d,c),f=[],e=0;e<c.length;e++)f.push({min:a.getPosition().dot(c[e])-a.getRadius(),max:a.getPosition().dot(c[e])+a.getRadius()});for(e=0;e<d.length;e++)if(0>Grape2D.Math.overlaps(d[e],f[e]))return!1;return!0};
Grape2D.GenericCollisionChecker.prototype.polygonVsPolygon=function(a,b){return!1};Grape2D.GenericCollisionChecker.prototype.polygonVsPoint=function(a,b){var c=a.getComputedVertexList(),d=[],e;for(e=0;e<c.length;e++)d.push(c[e].clone().sub(b));for(e=0;e<d.length;e++)if(c=(e+1)%d.length,0>d[c].getX()*d[e].getY()-d[e].getX()*d[c].getY())return!1;return!0};Grape2D.GenericCollisionChecker.prototype.polygonVsRay=function(a,b){return!1};Grape2D.SATUtils={selectAxis:function(a,b){for(var c=[],d,e=0;e<a.length;e++)c.push(a[e]);e=0;for(d=!0;e<b.length;e++,d=!0){for(var f=0;f<a.length;f++)if(c[f].isParallelTo(b[e])){d=!1;break}d&&c.push(b[e])}return c},computePolygonAxis:function(a){var b=[];a=a.getComputedVertexList();var c,d;for(d=0;d<a.length;d++)c=(d+1)%a.length,b.push(Grape2D.Vector.createFromPoints(a[d],a[c]).normalize().rightNormal());return b},computeIntervals:function(a,b){for(var c=[],d=Infinity,e=-Infinity,f,g,h=0;h<b.length;h++){for(var d=
Infinity,e=-Infinity,k=0;k<a.length;k++)f=a[k].dot(b[h]),g=a[(k+1)%a.length].dot(b[h]),f>e&&(e=f),f<d&&(d=f),g>e&&(e=g),g<d&&(d=f);c.push({min:d,max:e})}return c}};Grape2D.SATCollisionChecker=function(){};Grape2D.SATCollisionChecker.prototype=Object.create(Grape2D.GenericCollisionChecker.prototype);Grape2D.SATCollisionChecker.prototype.aabbVsPolygon=function(a,b){var c=new Grape2D.Polygon({vertexList:Grape2D.SATCollisionChecker.aabbToVertexList(a)});return this.polygonVsPolygon(c,b)};
Grape2D.SATCollisionChecker.prototype.polygonVsPolygon=function(a,b){for(var c=this.selectAxis(this.computeAxis(a),this.computeAxis(b)),d=this.computeIntervals(a.getComputedVertexList(),c),e=this.computeIntervals(b.getComputedVertexList(),c),f,g=0;g<c.length;g++)if(f=Grape2D.Math.overlaps(d[g],e[g]),0>f)return!1;return!0};
Grape2D.SATCollisionChecker.prototype.computeAxis=function(a){var b=[];a=a.getComputedVertexList();var c,d;for(d=0;d<a.length;d++)c=(d+1)%a.length,b.push(Grape2D.Vector.createFromPoints(a[d],a[c]).normalize().rightNormal());return b};Grape2D.SATCollisionChecker.prototype.selectAxis=function(a,b){for(var c=[],d,e=0;e<a.length;e++)c.push(a[e]);e=0;for(d=!0;e<b.length;e++,d=!0){for(var f=0;f<a.length;f++)if(c[f].isParallelTo(b[e])){d=!1;break}d&&c.push(b[e])}return c};
Grape2D.SATCollisionChecker.prototype.computeIntervals=function(a,b){for(var c=[],d=Infinity,e=-Infinity,f,g,h=0;h<b.length;h++){for(var d=Infinity,e=-Infinity,k=0;k<a.length;k++)f=a[k].dot(b[h]),g=a[(k+1)%a.length].dot(b[h]),f>e&&(e=f),f<d&&(d=f),g>e&&(e=g),g<d&&(d=f);c.push({min:d,max:e})}return c};
Grape2D.SATCollisionChecker.prototype.aabbVsRay=function(a,b){for(var c=b.getDirection().rightNormal(),d=Infinity,e=-Infinity,f,g=Grape2D.SATCollisionChecker.aabbToVertexList(a),h=0;h<g.length;h++)f=g[h].dot(c),f>e&&(e=f),f<d&&(d=f);f=b.getStart().dot(c);return d<=f&&f<=e?(e=b.getStart().getX(),f=b.getEnd().getX(),c=b.getStart().getY(),d=b.getEnd().getY(),e=e>f?{min:f,max:e}:{min:e,max:f},c=c>d?{min:d,max:c}:{min:c,max:d},0<=Grape2D.Math.overlaps(e,{min:a.getMinX(),max:a.getMaxX()})&&0<=Grape2D.Math.overlaps(c,
{min:a.getMinY(),max:a.getMaxY()})):!1};Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST=[new Grape2D.Vector,new Grape2D.Vector,new Grape2D.Vector,new Grape2D.Vector];
Grape2D.SATCollisionChecker.aabbToVertexList=function(a){Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[0].setX(a.getMinX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[0].setY(a.getMinY());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[1].setX(a.getMaxX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[1].setY(a.getMinY());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[2].setX(a.getMaxX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[2].setY(a.getMaxY());
Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[3].setX(a.getMinX());Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST[3].setY(a.getMaxY());return Grape2D.SATCollisionChecker.SHARED_AABB_TO_VERTEX_LIST};
Grape2D.SATCollisionChecker.prototype.circleVsRay=function(a,b){var c=a.getPosition().clone().sub(b.getStart()).dot(b.getDirection()),c=0>c?b.getStart().clone():c>=b.getLength()?b.getEnd().clone():b.getDirection().clone().multiplyByScalar(c).add(b.getStart());c.negate().add(a.getPosition());return c.lengthSquared()<=Grape2D.Math.sq(a.getRadius())};
Grape2D.SATCollisionChecker.prototype.polygonVsRay=function(a,b){var c=b.getDirection(),d=c.rightNormal(),e=a.getComputedVertexList(),f={min:0,max:0},g;g=this.computeIntervals(e,[d])[0];d=b.getStart().dot(d);return g.min<=d&&d<=g.max?(g=this.computeIntervals(e,[c])[0],e=b.getStart().dot(c),c=b.getEnd().dot(c),e>c?(f.max=e,f.min=c):(f.max=c,f.min=e),0<=Grape2D.Math.overlaps(g,f)):!1};Grape2D.CollisionDispatcher={aabbVsAabb:function(a,b,c){return a.aabbVsAabb(b,c)},aabbVsCircle:function(a,b,c){return a.aabbVsCircle(b,c)},aabbVsPolygon:function(a,b,c){return a.aabbVsPolygon(b,c)},aabbVsPoint:function(a,b,c){return a.aabbVsPoint(b,c)},aabbVsRay:function(a,b,c){return a.aabbVsRay(b,c)},circleVsAabb:function(a,b,c){return a.circleVsAabb(b,c)},circleVsCircle:function(a,b,c){return a.circleVsCircle(b,c)},circleVsPolygon:function(a,b,c){return a.circleVsPolygon(b,c)},circleVsPoint:function(a,
b,c){return a.circleVsPoint(b,c)},circleVsRay:function(a,b,c){return a.circleVsRay(b,c)},polygonVsAabb:function(a,b,c){return a.polygonVsAabb(b,c)},polygonVsCircle:function(a,b,c){return a.polygonVsCircle(b,c)},polygonVsPolygon:function(a,b,c){return a.polygonVsPolygon(b,c)},polygonVsPoint:function(a,b,c){return a.polygonVsPoint(b,c)},polygonVsRay:function(a,b,c){return a.polygonVsRay(b,c)},dcache:{},dispatch:function(a,b,c){return Grape2D.CollisionDispatcher.dcache[b.getStaticType()][c.getStaticType()](a,
b,c)}};
Grape2D.CollisionDispatcher.dcache={AABB:{AABB:Grape2D.CollisionDispatcher.aabbVsAabb,Circle:Grape2D.CollisionDispatcher.aabbVsCircle,Polygon:Grape2D.CollisionDispatcher.aabbVsPolygon,Vector:Grape2D.CollisionDispatcher.aabbVsPoint,Ray:Grape2D.CollisionDispatcher.aabbVsRay},Circle:{AABB:Grape2D.CollisionDispatcher.circleVsAabb,Circle:Grape2D.CollisionDispatcher.circleVsCircle,Polygon:Grape2D.CollisionDispatcher.circleVsPolygon,Vector:Grape2D.CollisionDispatcher.circleVsPoint,Ray:Grape2D.CollisionDispatcher.circleVsRay},Polygon:{AABB:Grape2D.CollisionDispatcher.polygonVsAabb,
Circle:Grape2D.CollisionDispatcher.polygonVsCircle,Polygon:Grape2D.CollisionDispatcher.polygonVsPolygon,Vector:Grape2D.CollisionDispatcher.polygonVsPoint,Ray:Grape2D.CollisionDispatcher.polygonVsRay}};Grape2D.CollisionCheckerSingleton={instance:new Grape2D.SATCollisionChecker,getCollisionChecker:function(){return Grape2D.CollisionCheckerSingleton.instance},setCollisionChecker:function(a){Grape2D.CollisionCheckerSingleton.instance=a},collide:function(a,b){return Grape2D.CollisionDispatcher.dispatch(Grape2D.CollisionCheckerSingleton.instance,a,b)}};Grape2D.CollisionResolver=function(){};
Grape2D.CollisionResolver.prototype={constructor:Grape2D.CollisionResolver,aabbVsAabb:function(a){var b=a.getA(),c=a.getB(),d=c.getPosition().clone().sub(b.getPosition()),b=b.getBoundingBox(),e=c.getBoundingBox(),f=(b.getMaxX()-b.getMinX())/2,g=(e.getMaxX()-e.getMinX())/2,c=f+g-Grape2D.Math.abs(d.getX());return 0<=c&&(f=(b.getMaxY()-b.getMinY())/2,g=(e.getMaxY()-e.getMinY())/2,b=f+g-Grape2D.Math.abs(d.getY()),0<b)?(c<b?(0>d.getX()?a.setNormal(new Grape2D.Vector(-1,0)):a.setNormal(new Grape2D.Vector(1,
0)),a.setPenetration(c)):(0>d.getY()?a.setNormal(new Grape2D.Vector(0,-1)):a.setNormal(new Grape2D.Vector(0,1)),a.setPenetration(b)),!0):!1},aabbVsCircle:function(a){var b=a.getA().getBoundingBox(),c=a.getB().getBoundingBox(),d=c.getPosition().clone().sub(b.getPosition()),e=d.clone(),f=b.getHalfWidth(),g=b.getHalfHeight(),b=!1;e.setX(Grape2D.Math.clamp(e.getX(),-f,f));e.setY(Grape2D.Math.clamp(e.getY(),-g,g));d.equals(e)&&(b=!0,Grape2D.Math.abs(d.getX())>Grape2D.Math.abs(d.getY())?0<e.getX()?e.setX(f):
e.setX(-f):0<e.getY()?e.setY(g):e.setY(-g));d=d.clone().sub(e);e=d.lengthSquared();c=c.getRadius();if(e>c*c&&!b)return!1;e=Grape2D.Math.sqrt(e);b?(a.setNormal(d.normalize().negate()),a.setPenetration(c+e)):(a.setNormal(d.normalize()),a.setPenetration(c-e));return!0},aabbVsPolygon:function(a){var b=a.getA().getBoundingBox(),c=new Grape2D.Polygon({vertexList:[new Grape2D.Vector(-b.getHalfWidth(),-b.getHalfHeight()),new Grape2D.Vector(b.getHalfWidth(),-b.getHalfHeight()),new Grape2D.Vector(b.getHalfWidth(),
b.getHalfHeight()),new Grape2D.Vector(-b.getHalfWidth(),b.getHalfHeight())]});a.getA().setBoundingBox(c);c=this.polygonVsPolygon(a);a.getA().setBoundingBox(b);return c},aabbVsRay:function(a){return!1},circleVsAabb:function(a){var b=this.aabbVsCircle(a.invert());a.invert();return b},circleVsCircle:function(a){var b=a.getA().getBoundingBox(),c=a.getB().getBoundingBox(),d=c.getPosition().clone().sub(b.getPosition()),c=b.getRadius()+c.getRadius();if(d.lengthSquared()>Grape2D.Math.sq(c))return!1;var e=
d.length();0!=e?(a.setPenetration(c-e),a.setNormal(d.normalize())):(a.setPenetration(b.getRadius()),a.setNormal(new Grape2D.Vector(1,0)));return!0},circleVsPolygon:function(a){for(var b=a.getB().getBoundingBox(),c=a.getA().getBoundingBox(),d=Grape2D.SATUtils.computePolygonAxis(b),e=b.getComputedVertexList(),b=0;b<e.length;b++)d.push(c.getPosition().clone().sub(e[b]).normalize());for(var f,g=Infinity,e=Grape2D.SATUtils.computeIntervals(e,d),h=[],b=0;b<d.length;b++)h.push({min:c.getPosition().dot(d[b])-
c.getRadius(),max:c.getPosition().dot(d[b])+c.getRadius()});for(b=0;b<e.length;b++){c=Grape2D.Math.overlaps(e[b],h[b]);if(0>c)return!1;g>c&&(f=d[b],g=c)}a.setPenetration(g);a.setNormal(f.negate());return!0},circleVsRay:function(a){return!1},polygonVsAabb:function(a){var b=this.aabbVsPolygon(a.invert());a.invert();return b},polygonVsCircle:function(a){var b=this.circleVsPolygon(a.invert());a.invert();return b},polygonVsPolygon:function(a){for(var b=a.getA().getBoundingBox(),c=a.getB().getBoundingBox(),
d=Grape2D.SATUtils.computePolygonAxis(b),e=Grape2D.SATUtils.computePolygonAxis(c),d=Grape2D.SATUtils.selectAxis(d,e),e=Grape2D.SATUtils.computeIntervals(b.getComputedVertexList(),d),f=Grape2D.SATUtils.computeIntervals(c.getComputedVertexList(),d),g,h,k=Infinity,l=0;l<d.length;l++){g=Grape2D.Math.overlaps(e[l],f[l]);if(0>g)return!1;k>g&&(h=d[l],k=g)}a.setPenetration(k);0>h.dot(c.getPosition().clone().sub(b.getPosition()))&&h.negate();a.setNormal(h);return!0},polygonVsRay:function(a){return!1}};Grape2D.Manifold=function(a,b){this.a=a;this.b=b;this.penetration=0;this.normal=new Grape2D.Vector};
Grape2D.Manifold.prototype={constructor:Grape2D.Manifold,getA:function(){return this.a},setA:function(a){this.a=a},getB:function(){return this.b},setB:function(a){this.b=a},getPenetration:function(){return this.penetration},setPenetration:function(a){this.penetration=a},getNormal:function(){return this.normal},setNormal:function(a){this.normal.set(a)},invert:function(){var a=this.a;this.a=this.b;this.b=a;this.normal.negate();return this}};Grape2D.ManifoldDispatcher={aabbVsAabb:function(a,b){return a.aabbVsAabb(b)},aabbVsCircle:function(a,b){return a.aabbVsCircle(b)},aabbVsPolygon:function(a,b){return a.aabbVsPolygon(b)},aabbVsRay:function(a,b){return a.aabbVsRay(b)},circleVsAabb:function(a,b){return a.circleVsAabb(b)},circleVsCircle:function(a,b){return a.circleVsCircle(b)},circleVsPolygon:function(a,b){return a.circleVsPolygon(b)},circleVsRay:function(a,b){return a.circleVsRay(b)},polygonVsAabb:function(a,b){return a.polygonVsAabb(b)},
polygonVsCircle:function(a,b){return a.polygonVsCircle(b)},polygonVsPolygon:function(a,b){return a.polygonVsPolygon(b)},polygonVsRay:function(a,b){return a.polygonVsRay(b)},dcache:{},dispatch:function(a,b){return Grape2D.ManifoldDispatcher.dcache[b.getA().getBoundingBox().getStaticType()][b.getB().getBoundingBox().getStaticType()](a,b)}};
Grape2D.ManifoldDispatcher.dcache={AABB:{AABB:Grape2D.ManifoldDispatcher.aabbVsAabb,Circle:Grape2D.ManifoldDispatcher.aabbVsCircle,Polygon:Grape2D.ManifoldDispatcher.aabbVsPolygon,Ray:Grape2D.ManifoldDispatcher.aabbVsRay},Circle:{AABB:Grape2D.ManifoldDispatcher.circleVsAabb,Circle:Grape2D.ManifoldDispatcher.circleVsCircle,Polygon:Grape2D.ManifoldDispatcher.circleVsPolygon,Ray:Grape2D.ManifoldDispatcher.circleVsRay},Polygon:{AABB:Grape2D.ManifoldDispatcher.polygonVsAabb,Circle:Grape2D.ManifoldDispatcher.polygonVsCircle,
Polygon:Grape2D.ManifoldDispatcher.polygonVsPolygon,Ray:Grape2D.ManifoldDispatcher.polygonVsRay}};Grape2D.BVHTree=function(){};Grape2D.BVHTree.prototype=Object.create(Grape2D.Map.prototype);Grape2D.TopDownBVHTree=function(a){this.objs=a||[];this.rootNode=null;this.objs.length&&this.rebuild()};Grape2D.TopDownBVHTree.prototype=Object.create(Grape2D.BVHTree.prototype);Grape2D.TopDownBVHTree.prototype.rebuild=function(){this.rootNode=new Grape2D.TopDownBVHNode(null,this.objs)};Grape2D.TopDownBVHTree.prototype.add=function(a){this.objs.push(a)};Grape2D.TopDownBVHTree.prototype.remove=function(a){this.objs.splice(this.objs.indexOf(a),1)};
Grape2D.TopDownBVHTree.prototype.query=function(a){return this.rootNode?this.rootNode.query(a):[]};Grape2D.TopDownBVHTree.prototype.queryPoint=function(a){return this.rootNode?this.rootNode.query(a):[]};Grape2D.TopDownBVHTree.prototype.queryRay=function(a){return this.rootNode?this.rootNode.queryRay(a):null};Grape2D.TopDownBVHTree.prototype.clear=function(){this.objs=[];this.rootNode=null};
Grape2D.TopDownBVHTree.prototype.update=function(a,b){for(var c=0;c<this.objs.length;c++)this.objs[c].update(a,b)};Grape2D.TopDownBVHTree.prototype.getRootNode=function(){return this.rootNode};Grape2D.TopDownBVHTree.MAX_DEPTH=5;Grape2D.TopDownBVHTree.DEFAULT_PER_LEAF=2;Grape2D.TopDownBVHNode=function(a,b){this.bv=Grape2D.BVFactorySingleton.getPlaceHolder();this.leaf=!1;this.objects=[];this.parent=a;this.right=this.left=null;this.depth=a?a.getDepth()+1:0;this.compute(b)};
Grape2D.TopDownBVHNode.prototype={constructor:Grape2D.TopDownBVHNode,compute:function(a){var b;if(a.length<=Grape2D.TopDownBVHTree.DEFAULT_PER_LEAF||this.depth>=Grape2D.TopDownBVHTree.MAX_DEPTH)for(this.leaf=!0,b=0;b<a.length;b++)this.objects.push(a[b]);else{var c=Grape2D.BVHStrategySingleton.getStrategy().solve(a),d=Grape2D.BVFactorySingleton.getFactory();if(c.endState)for(this.leaf=!0,b=0;b<a.length;b++)this.objects.push(a[b]);else{this.bv=d.merge(a[0].getBoundingBox(),a[1].getBoundingBox());for(b=
2;b<a.length;b++)this.bv=d.merge(this.bv,a[b].getBoundingBox());this.left=new Grape2D.TopDownBVHNode(this,c.left);this.right=new Grape2D.TopDownBVHNode(this,c.right)}}},isLeaf:function(){return this.leaf},getBoundingVolume:function(){return this.bv},getParent:function(){return this.parent},getObjects:function(){return this.objects},getLeft:function(){return this.left},getRight:function(){return this.right},query:function(a){var b=[],c;if(this.leaf)for(c=0;c<this.objects.length;c++)Grape2D.CollisionCheckerSingleton.collide(this.objects[c].getBoundingBox(),
a)&&b.push(this.objects[c]);else if(Grape2D.CollisionCheckerSingleton.collide(this.bv,a)){var d=this.left.query(a);for(c=0;c<d.length;c++)b.push(d[c]);d=this.right.query(a);for(c=0;c<d.length;c++)b.push(d[c])}return b},queryRay:function(a){var b;if(this.leaf)for(b=0;b<this.objects.length;b++){if(Grape2D.CollisionCheckerSingleton.collide(this.objects[b].getBoundingBox(),a))return this.objects[b]}else if(Grape2D.CollisionCheckerSingleton.collide(this.bv,a)&&((b=this.left.queryRay(a))||(b=this.right.queryRay(a))))return b;
return null},getDepth:function(){return this.depth}};Grape2D.BVHStrategy=function(){};Grape2D.BVHStrategy.prototype={constructor:Grape2D.BVHStrategy,solve:function(a){}};Grape2D.MedianCutBVHStrategy=function(){};Grape2D.MedianCutBVHStrategy.prototype=Object.create(Grape2D.BVHStrategy.prototype);
Grape2D.MedianCutBVHStrategy.prototype.solve=function(a){for(var b={left:[],right:[],endState:!1},c=Infinity,d=-Infinity,e=Infinity,f=-Infinity,g=0,h,k=0;k<a.length;k++)h=a[k].getBoundingBox().getPosition(),c>h.getX()&&(c=h.getX()),d<h.getX()&&(d=h.getX()),e>h.getY()&&(e=h.getY()),f<h.getY()&&(f=h.getY());if(0===d-c&&0===f-e)return b.endState=!0,b;if(Grape2D.Math.abs(d)-Grape2D.Math.abs(c)>=Grape2D.Math.abs(f)-Grape2D.Math.abs(e))for(g=c+Grape2D.Math.abs((d-c)/2),k=0;k<a.length;k++)h=a[k].getBoundingBox().getPosition(),
h.getX()>g?b.right.push(a[k]):b.left.push(a[k]);else for(g=e+Grape2D.Math.abs((f-e)/2),k=0;k<a.length;k++)h=a[k].getBoundingBox().getPosition(),h.getY()>g?b.right.push(a[k]):b.left.push(a[k]);return b};Grape2D.BVHStrategySingleton={strategy:new Grape2D.MedianCutBVHStrategy,setStrategy:function(a){Grape2D.BVHStrategySingleton.strategy=a},getStrategy:function(){return Grape2D.BVHStrategySingleton.strategy}};Grape2D.BVFactory=function(){};Grape2D.BVFactory.prototype={constructor:Grape2D.BVFactory,createFromAABB:function(a){},createFromCircle:function(a){},createFromPolygon:function(a){},createSceneBV:function(a,b){},getPlaceHolder:function(){}};Grape2D.AabbBVFactory=function(){};Grape2D.AabbBVFactory.prototype=Object.create(Grape2D.BVFactory.prototype);Grape2D.AabbBVFactory.prototype.createFromAABB=function(a){return a};Grape2D.AabbBVFactory.prototype.createFromCircle=function(a){var b=2*a.getRadius();return new Grape2D.AABB({position:a.getPosition(),width:b,height:b})};
Grape2D.AabbBVFactory.prototype.createFromPolygon=function(a){var b=Infinity,c=-Infinity,d=Infinity,e=-Infinity;a=a.getVertexList();for(var f,g=0;g<a.length;g++)f=a[g],b>f.getX()&&(b=f.getX()),c<f.getX()&&(c=f.getX()),d>f.getY()&&(d=f.getY()),c<f.getY()&&(e=f.getY());b=c-b;d=e-d;return new Grape2D.AABB({position:new Grape2D.Vector(b/2+b,d/2+d),width:b,height:d})};
Grape2D.AabbBVFactory.prototype.createSceneBV=function(a,b){return new Grape2D.AABB({position:b.getLookAt(),width:a.getWidth()/b.getScale().getX(),height:a.getHeight()/b.getScale().getY()})};
Grape2D.AabbBVFactory.prototype.merge=function(a,b){var c=a.createBV(this),d=b.createBV(this),e=Grape2D.Math.min(c.getMinX(),d.getMinX()),f=Grape2D.Math.max(c.getMaxX(),d.getMaxX()),g=Grape2D.Math.min(c.getMinY(),d.getMinY()),c=Grape2D.Math.max(c.getMaxY(),d.getMaxY());return new Grape2D.AABB({minX:e,minY:g,maxX:f,maxY:c})};Grape2D.AabbBVFactory.prototype.getPlaceHolder=function(){return Grape2D.AabbBVFactory.PLACE_HOLDER};Grape2D.AabbBVFactory.PLACE_HOLDER=new Grape2D.AABB({width:0,height:0});Grape2D.BVFactorySingleton={bvfactory:new Grape2D.AabbBVFactory,getFactory:function(){return Grape2D.BVFactorySingleton.bvfactory},setFactory:function(a){Grape2D.BVFactorySingleton.bvfactory=a},create:function(a){return a.createBV(Grape2D.BVFactorySingleton.bvfactory)},getPlaceHolder:function(){return Grape2D.BVFactorySingleton.bvfactory.getPlaceHolder()}};Grape2D.ITexture=function(){};Grape2D.ITexture.prototype={constructor:Grape2D.ITexture,getWidth:function(){},getHalfWidth:function(){},getHeight:function(){},getHalfHeight:function(){},render:function(a,b){}};Grape2D.Texture=function(a){a=a||{};this.width=2;this.hwidth=1;this.height=2;this.hheight=1;this.buffer=new Grape2D.Canvas({width:this.width,height:this.height});this.glBuffer=null;a.image?this.bufferImage(a.image):a.useTexure&&(this.buffer=a.useTexure)};Grape2D.Texture.prototype=Object.create(Grape2D.ITexture);Grape2D.Texture.prototype.getWidth=function(){return this.width};Grape2D.Texture.prototype.getHeight=function(){return this.height};
Grape2D.Texture.prototype.setWidth=function(a){this.width=a;this.hwidth=this.width/2};Grape2D.Texture.prototype.setHeight=function(a){this.height=a;this.hheight=this.height/2};Grape2D.Texture.prototype.getHalfWidth=function(){return this.hwidth};Grape2D.Texture.prototype.getHalfHeight=function(){return this.hheight};Grape2D.Texture.prototype.getBuffer=function(){return this.buffer.canvas};Grape2D.Texture.prototype.getGlBuffer=function(){return this.glBuffer};
Grape2D.Texture.prototype.setGlBuffer=function(a){this.glBuffer=a};Grape2D.Texture.prototype.bufferImage=function(a){this.setWidth(a.width);this.setHeight(a.height);this.buffer=(new Grape2D.Canvas({width:this.width,height:this.height})).drawImage(a,0,0,this.width,this.height,0,0,this.width,this.height);this.glBuffer=null};Grape2D.Texture.prototype.render=function(a,b){a.renderTexture(this,b)};
Grape2D.Texture.createFromImage=function(a,b){var c=new Image,d=new Grape2D.Texture;c.crossOrigin="Anonymous";c.onload=function(a){d.bufferImage(this);b&&b(d,this,a)};c.src=a;return d};Grape2D.VoidTexture=function(){};Grape2D.VoidTexture.prototype=Object.create(Grape2D.ITexture);Grape2D.VoidTexture.prototype.getWidth=function(){return 0};Grape2D.VoidTexture.prototype.getHalfWidth=function(){return 0};Grape2D.VoidTexture.prototype.getHeight=function(){return 0};Grape2D.VoidTexture.prototype.getHalfHeight=function(){return 0};Grape2D.VoidTexture.prototype.render=function(){};Grape2D.VoidTexture.STATIC=new Grape2D.VoidTexture;Grape2D.IText=function(){Grape2D.ITexture.call(this)};Grape2D.IText.prototype=Object.create(Grape2D.ITexture.prototype);Grape2D.IText.prototype.getText=function(){};Grape2D.IText.prototype.setText=function(a){};Grape2D.IText.prototype.getColor=function(){};Grape2D.IText.prototype.setColor=function(a){};Grape2D.IText.prototype.getSize=function(){};Grape2D.IText.prototype.setSize=function(a){};Grape2D.IText.prototype.getFont=function(){};Grape2D.IText.prototype.setFont=function(a){};Grape2D.Text=function(a){this.text=a.text||"";this.position=new Grape2D.Vector;a.position&&this.setPosition(a.position);this.buffer=new Grape2D.Texture;this.size=a.size||10;this.font=a.font||"sans-serif";this.color=a.color||new Grape2D.Color;this.refreshBuffer()};Grape2D.Text.prototype=Object.create(Grape2D.IText.prototype);Grape2D.Text.prototype.getText=function(){return this.text};Grape2D.Text.prototype.getPosition=function(){return this.position};Grape2D.Text.prototype.getBuffer=function(){return this.buffer};
Grape2D.Text.prototype.getWidth=function(){return this.buffer.getWidth()};Grape2D.Text.prototype.getHeight=function(){return this.buffer.getHeight()};Grape2D.Text.prototype.getHalfWidth=function(){return this.buffer.getHalfWidth()};Grape2D.Text.prototype.getHalfHeight=function(){return this.buffer.getHalfHeight()};Grape2D.Text.prototype.setText=function(a){this.text=a;this.refreshBuffer()};
Grape2D.Text.prototype.refreshBuffer=function(){var a=this.text.split("\n"),b=-Infinity,c=this.buffer.buffer;c.clear();c.setFont(this.size+"px "+this.font);for(var d=0,e;e=a[d++];)b=Math.max(c.measureText(e).width,b);b=Grape2D.Math.nextPowerOfTwo(b);d=Grape2D.Math.nextPowerOfTwo(a.length*this.size*1.2);c.setWidth(b);this.buffer.setWidth(b);c.setHeight(d);this.buffer.setHeight(d);c.setFont(this.size+"px "+this.font);c.setFillStyle(this.color);c.setStrokeStyle(this.color);for(d=0;e=a[d++];)c.fillText(e,
0,d*this.size)};Grape2D.Text.prototype.setPosition=function(a){this.position.set(a)};Grape2D.Text.prototype.setColor=function(a){this.color.set(a);this.refreshBuffer()};Grape2D.Text.prototype.getColor=function(){return this.color};Grape2D.Text.prototype.setSize=function(a){this.size=a;this.refreshBuffer()};Grape2D.Text.prototype.getSize=function(){return this.size};Grape2D.Text.prototype.setFont=function(a){this.font=a;this.refreshBuffer()};Grape2D.Text.prototype.getFont=function(){return this.font};
Grape2D.Text.prototype.render=function(a){a.renderText(this)};Grape2D.Text.getTextSize=function(a,b){a=a.replace("\n","<br>");var c=document.createElement("span");c.innerHTML=a;c.style.font=b;c.hidden=!0;document.body.appendChild(c);document.body.removeChild(c);return{width:c.offsetWidth,height:c.offsetHeight}};Grape2D.AbsoluteText=function(a){Grape2D.IText.call(this);this.text=new Grape2D.Text(a)};Grape2D.AbsoluteText.prototype=Object.create(Grape2D.IText.prototype);Grape2D.AbsoluteText.prototype.getText=function(){return this.text.getText()};Grape2D.AbsoluteText.prototype.setText=function(a){this.text.setText(a)};Grape2D.AbsoluteText.prototype.getColor=function(){return this.text.getColor()};Grape2D.AbsoluteText.prototype.setColor=function(a){this.text.setColor(a)};
Grape2D.AbsoluteText.prototype.getSize=function(){return this.text.getSize()};Grape2D.AbsoluteText.prototype.setSize=function(a){this.text.getSize(a)};Grape2D.AbsoluteText.prototype.getFont=function(){return this.text.getFont()};Grape2D.AbsoluteText.prototype.setFont=function(a){this.text.setFont(a)};Grape2D.AbsoluteText.prototype.getWidth=function(){return this.text.getWidth()};Grape2D.AbsoluteText.prototype.setWidth=function(a){this.text.setWidth(a)};Grape2D.AbsoluteText.prototype.getHeight=function(){return this.text.getHeight()};
Grape2D.AbsoluteText.prototype.setHeight=function(a){this.text.setHeight(a)};Grape2D.AbsoluteText.prototype.getHalfWidth=function(){return this.text.getHalfWidth()};Grape2D.AbsoluteText.prototype.getHalfHeight=function(){return this.text.getHalfHeight()};Grape2D.AbsoluteText.prototype.getPosition=function(){return this.text.getPosition()};Grape2D.AbsoluteText.prototype.setPosition=function(a){this.text.setPosition(a)};Grape2D.AbsoluteText.prototype.getBuffer=function(){return this.text.getBuffer()};
Grape2D.AbsoluteText.prototype.render=function(a){a.renderAbsoluteText(this)};Grape2D.Scene=function(){};Grape2D.Scene.prototype={constructor:Grape2D.Scene,update:function(a){},render:function(a,b){}};Grape2D.SceneGroup=function(){this.childs=[]};Grape2D.SceneGroup.prototype=Object.create(Grape2D.Scene.prototype);Grape2D.SceneGroup.prototype.update=function(a){for(var b=0;b<this.childs.length;b++)this.childs[b].update(a)};Grape2D.SceneGroup.prototype.render=function(a,b){for(var c=0;c<this.childs.length;c++)this.childs[c].render(a,b)};Grape2D.SceneGroup.prototype.addChild=function(a){this.childs.push(a)};
Grape2D.SceneGroup.prototype.removeChild=function(a){this.childs.splice(this.childs.indexOf(a),1)};Grape2D.SceneLayer=function(a){a=a||{};this.map=a.map||new Grape2D.SimpleMap};Grape2D.SceneLayer.prototype=Object.create(Grape2D.Scene.prototype);Grape2D.SceneLayer.prototype.update=function(a){this.map.update(a)};Grape2D.SceneLayer.prototype.render=function(a,b){var c=this.map.query(Grape2D.BVFactorySingleton.getFactory().createSceneBV(a,b));a.start(b);for(var d=0;d<c.length;d++)c[d].render(a);a.end()};Grape2D.SceneLayer.prototype.getMap=function(){return this.map};Grape2D.Game=function(){};Grape2D.Game.prototype={constructor:Grape2D.Game,setup:function(){},start:function(){},stop:function(){},render:function(){},update:function(a){},animate:function(){}};Grape2D.SimpleGame=function(a,b,c){this.camera=c;this.clock=new Grape2D.utils.Clock;this.renderer=a;this.scene=b;this.raf=-1;this.fpsText=new Grape2D.AbsoluteText({text:"0 fps"})};Grape2D.SimpleGame.prototype=Object.create(Grape2D.Game.prototype);Grape2D.SimpleGame.prototype.getCamera=function(){return this.camera};Grape2D.SimpleGame.prototype.getClock=function(){return this.clock};Grape2D.SimpleGame.prototype.getRenderer=function(){return this.renderer};Grape2D.SimpleGame.prototype.getScene=function(){return this.scene};
Grape2D.SimpleGame.prototype.setup=function(){};Grape2D.SimpleGame.prototype.start=function(){this.animate()};Grape2D.SimpleGame.prototype.stop=function(){Grape2D.utils.cancelAnimationFrame(this.raf)};Grape2D.SimpleGame.prototype.render=function(){this.scene.render(this.renderer,this.camera)};Grape2D.SimpleGame.prototype.update=function(a){this.scene.update(a)};
Grape2D.SimpleGame.prototype.animate=function(){var a=this,b=this.clock.update();this.raf=Grape2D.utils.requestAnimationFrame(function(){a.animate()});this.update(b);this.render();this.fpsText.setText(this.clock.getFps()+" fps"+(this.clock.getFrameCount()%5?"+":""));this.fpsText.render(this.renderer)};Grape2D.WebSocket=function(a){a=a||{};this.onmessageCallback=[];this.oncloseCallback=[];this.onopenCallback=[];this.onsendCallback=[];this.ws=null;this.address=a.address;this.protocol=a.protocol||void 0;this.metrics=new Grape2D.WebSocketMetrics(this,a.clock||void 0)};
Grape2D.WebSocket.prototype={constructor:Grape2D.WebSocket,send:function(a){if(this.isOpen()){this.ws.send(a);for(var b=0;b<this.onsendCallback.length;b++)this.onsendCallback[b](a)}},addOnSend:function(a){this.onsendCallback.push(a)},removeOnSend:function(a){a=this.onsendCallback.indexOf(a);-1<a&&this.onsendCallback.splice(a,1)},addOnMessage:function(a){this.onmessageCallback.push(a)},removeOnMessage:function(a){a=this.onmessageCallback.indexOf(a);-1<a&&this.onmessageCallback.splice(a,1)},addOnClose:function(a){this.oncloseCallback.push(a)},
removeOnClose:function(a){a=this.oncloseCallback.indexOf(a);-1<a&&this.oncloseCallback.splice(a,1)},addOnOpen:function(a){this.onopenCallback.push(a)},removeOnOpen:function(a){a=this.onopenCallback.indexOf(a);-1<a&&this.onopenCallback.splice(a,1)},close:function(){this.ws.close()},open:function(){var a=this;this.ws=new WebSocket(this.address,this.protocol);this.ws.onopen=function(b){for(var c=0;c<a.onopenCallback.length;c++)a.onopenCallback[c](b)};this.ws.onmessage=function(b){for(var c=0;c<a.onmessageCallback.length;c++)a.onmessageCallback[c](b.data,
b)};this.ws.onclose=function(b){for(var c=0;c<a.oncloseCallback.length;c++)a.oncloseCallback[c](b)}},getMetrics:function(){return this.metrics},isOpen:function(){return this.ws.readyState==this.ws.OPEN}};Grape2D.WebSocketMetrics=function(a,b){this.ws=a;this.syncAc=this.pingSamplesReceived=this.pingAc=0;this.pingSamples=10;this.lastSent=this.lastReceived=this.start=this.bytesReceived=this.bytesSent=this.lastPing=this.pingValue=0;this.syncClock=b||new Grape2D.utils.SynchronizedClock;var c=this;this.ws.addOnOpen(function(){c.start=c.syncClock.getTime()});this.ws.addOnMessage(function(a){a=a.length;c.bytesReceived+=a;c.lastReceived=a});this.ws.addOnSend(function(a){a=a.length;c.bytesSent+=a;c.lastSent=
a})};
Grape2D.WebSocketMetrics.prototype={constructor:Grape2D.WebSocketMetrics,ping:function(a){this.pingStop=!0;this.pongSamplesReceived=this.syncAc=this.pingAc=0;for(var b=this,c=function(){b.ws.send(a((new Date).getTime()))},d=this.pingSamples;0<d;d--)setTimeout(c,20*d)},pong:function(a,b){this.ws.send(a(b,this.syncClock.getTime()))},pongReceived:function(a,b,c){var d;d=c-a;this.pingAc+=d;this.syncAc+=0.5*(b-a+(b-c))-0.5*d;this.pingSamplesReceived++;this.lastPing=c;this.pingSamplesReceived==this.pingSamples&&(this.pingValue=
Grape2D.Math.ceil(this.pingAc/this.pingSamples),this.pingSamplesReceived=0,this.syncClock.sync(Grape2D.Math.floor(this.syncAc/this.pingSamples)))},getPing:function(){return this.pingValue},getLastPing:function(){return this.lastPing},getLastBytesSent:function(){return this.lastSent},getBytesSent:function(){return this.bytesSent},getBytesSentPerSec:function(){return this.bytesSent/((new Date).getTime()-this.start)},getLastBytesReceived:function(){return this.lastReceived},getBytesReceived:function(){return this.bytesSent},
getBytesReceivedPerSec:function(){return this.bytesReceived/((new Date).getTime()-this.start)}};Grape2D.LagSimulator=function(a){a=a||{};this.latency=a.latency||0;this.variation=a.variation||0};Grape2D.LagSimulator.prototype={constructor:Grape2D.LagSimulator,getLatency:function(){return this.latency},setLatency:function(a){this.latency=a},getVariation:function(){return this.variation},setVariation:function(a){this.variation=a},simulate:function(a){var b=Grape2D.Math.randInt(this.latency-this.variation,this.latency+this.variation);setTimeout(function(){a(b)},b)}};Grape2D.utils.MessageDispatcher=function(){this.stack=[]};Grape2D.utils.MessageDispatcher.prototype={constructor:Grape2D.utils.MessageDispatcher,add:function(a,b){this.stack.push({regex:a,callback:b})},remove:function(a){a=a.toString();for(var b=0;b<this.stack.length;b++)this.stack[b].regex.toString()==a&&this.stack.splice(b,1)},dispatch:function(a,b){for(var c,d=0;d<this.stack.length;d++)c=this.stack[d],c.regex.test(a)&&this.stack[d].callback(a,b)}};Grape2D.utils.JSONMessageDispatcher=function(a){Grape2D.utils.MessageDispatcher.call(this);this.property=a};Grape2D.utils.JSONMessageDispatcher.prototype=Object.create(Grape2D.utils.MessageDispatcher.prototype);Grape2D.utils.JSONMessageDispatcher.prototype.dispatch=function(a,b){var c,d,e;try{c=JSON.parse(a),e=c[this.property]}catch(f){return}for(var g=0;g<this.stack.length;g++)d=this.stack[g],d.regex.test(e)&&this.stack[g].callback(c,b)};Grape2D.utils.TimerDispatcher=function(){this.tm=[]};Grape2D.utils.TimerDispatcher.prototype={constructor:Grape2D.utils.TimerDispatcher,add:function(a,b,c){this.tm.push({interval:a,callback:b,remaining:a,remove:c||!1})},dispatch:function(a){for(var b,c=[],d=0;d<this.tm.length;d++)b=this.tm[d],b.remaining<=a?(b.callback(),b.remove?c.push(d):b.remaining=Grape2D.Math.clamp(b.interval-(b.remaining-a),0,b.interval)):b.remaining-=a;for(d=0;d<c.length;d++)this.tm.splice(c[d],1)}};
Grape2D.utils.TimerDispatcher.SECOND=1E3;Grape2D.utils.TimerDispatcher.MINUTE=60*Grape2D.utils.TimerDispatcher.SECOND;Grape2D.utils.TimerDispatcher.HOUR=60*Grape2D.utils.TimerDispatcher.MINUTE;Grape2D.ISoundManager=function(){};Grape2D.ISoundManager.prototype={constructor:Grape2D.ISoundManager};Grape2D.SoundManager=function(){this.audioContext=null;"undefined"!=typeof Grape2D.WINDOW.AudioContext?this.audioContext=new Grape2D.WINDOW.AudioContext:"undefined"!=typeof Grape2D.WINDOW.webkitAudioContext&&(this.audioContext=new Grape2D.WINDOW.webkitAudioContext)};Grape2D.SoundManager.prototype=Object.create(Grape2D.ISoundManager.prototype);Grape2D.SoundManager.prototype.getContext=function(){return this.audioContext};Grape2D.SoundManager.prototype.getInstance=function(){return this.audioContext};
Grape2D.SoundManager.prototype.getDestination=function(){return this.audioContext.destination};Grape2D.SoundManagerSingleton={instance:new Grape2D.SoundManager,getInstance:function(){return Grape2D.SoundManagerSingleton.instance},getContext:function(){return Grape2D.SoundManagerSingleton.instance.getContext()},getDestination:function(){return Grape2D.SoundManagerSingleton.instance.getDestination()}};Grape2D.SoundIO=function(){};Grape2D.SoundIO.prototype={constructor:Grape2D.SoundIO,connect:function(a){},getDestination:function(){}};Grape2D.ISound=function(){};Grape2D.ISound.prototype=Object.create(Grape2D.SoundIO.prototype);Grape2D.ISound.prototype.connect=function(a){};Grape2D.ISound.prototype.play=function(a,b,c){};Grape2D.ISound.prototype.stop=function(){};Grape2D.Sound=function(a){this.soundSource=null;this.duration=0;this.buffer=null;a&&this.setBuffer(a);this.connectingTo=null};Grape2D.Sound.prototype=Object.create(Grape2D.ISound.prototype);Grape2D.Sound.prototype.prepare=function(){this.soundSource=Grape2D.SoundManagerSingleton.getContext().createBufferSource();this.soundSource.buffer=this.buffer;this.connectingTo&&this.soundSource.connect(this.connectingTo.getDestination())};
Grape2D.Sound.prototype.play=function(a,b,c){this.prepare();this.soundSource.start(a||0,b||0,c||this.duration)};Grape2D.Sound.prototype.stop=function(){this.soundSource.stop(0)};Grape2D.Sound.prototype.setBuffer=function(a){this.buffer=a;this.duration=Grape2D.Math.floorPositive(a.duration)};Grape2D.Sound.prototype.connect=function(a){this.connectingTo=a;return this};
Grape2D.Sound.createFromFile=function(a,b){var c=new XMLHttpRequest,d=new Grape2D.Sound;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(a){Grape2D.SoundManagerSingleton.getContext().decodeAudioData(c.response,function(a){d.setBuffer(a);b&&b(d)})};c.send();return d};Grape2D.SoundGain=function(a){this.gain=Grape2D.SoundManagerSingleton.getContext().createGain();a&&this.setGain(a)};Grape2D.SoundGain.prototype=Object.create(Grape2D.SoundIO.prototype);Grape2D.SoundGain.prototype.getGain=function(){return this.gain.gain.value};Grape2D.SoundGain.prototype.setGain=function(a){this.gain.gain.value=a};Grape2D.SoundGain.prototype.connect=function(a){this.gain.connect(a.getDestination());return this};Grape2D.SoundGain.prototype.getDestination=function(){return this.gain};Grape2D.SoundDelay=function(a){this.delay=Grape2D.SoundManagerSingleton.getContext().createDelay(a||1);this.setDelay(a||1)};Grape2D.SoundDelay.prototype=Object.create(Grape2D.SoundIO.prototype);Grape2D.SoundDelay.prototype.getDelay=function(){return this.delay.delayTime.value};Grape2D.SoundDelay.prototype.setDelay=function(a){this.delay.delayTime.value=a};Grape2D.SoundDelay.prototype.connect=function(a){this.delay.connect(a.getDestination());return this};
Grape2D.SoundDelay.prototype.getDestination=function(){return this.delay};Grape2D.SoundPanner=function(a){this.panner=Grape2D.SoundManagerSingleton.getContext().createPanner();this.position=new Grape2D.Vector;a.position&&this.setPosition(a.position);this.velocity=new Grape2D.Vector;a.velocity&&this.setVelocity(a.velocity);this.orientation=new Grape2D.Vector;a.orientation&&this.setOrientation(a.orientation);a.panningModel&&this.setPanningModel(a.panningModel);a.distanceModel&&this.setDistanceModel(a.distanceModel);a.refDistance&&this.setRefDistance(a.refDistance);a.maxDistance&&
this.setMaxDistance(a.maxDistance);a.rolloffFactor&&this.setRolloffFactor(a.rolloffFactor);a.coneInnerAngle&&this.setConeInnerAngle(a.coneInnerAngle);a.coneOuterAngle&&this.setConeOuterAngle(a.coneOuterAngle);a.coneOuterGain&&this.setConeOuterGain(a.coneOuterGain)};Grape2D.SoundPanner.prototype=Object.create(Grape2D.SoundIO.prototype);Grape2D.SoundPanner.prototype.getPosition=function(){return this.position};
Grape2D.SoundPanner.prototype.setPosition=function(a){this.position.set(a);this.panner.setPosition(a.getX(),a.getY(),0)};Grape2D.SoundPanner.prototype.getVelocity=function(){return this.velocity};Grape2D.SoundPanner.prototype.setVelocity=function(a){this.velocity.set(a);this.panner.setVelocity(a.getX(),a.getY(),0)};Grape2D.SoundPanner.prototype.getOrientation=function(){return this.orientation};
Grape2D.SoundPanner.prototype.setOrientation=function(a){this.velocity.set(a);this.panner.setOrientation(a.getX(),a.getY(),0)};Grape2D.SoundPanner.prototype.getPanningModel=function(){return this.panner.panningModel};Grape2D.SoundPanner.prototype.setPanningModel=function(a){this.panner.panningModel=a};Grape2D.SoundPanner.prototype.getDistanceModel=function(){return this.panner.distanceModel};Grape2D.SoundPanner.prototype.setDistanceModel=function(a){this.panner.distanceModel=a};
Grape2D.SoundPanner.prototype.getRefDistance=function(){return this.panner.refDistance};Grape2D.SoundPanner.prototype.setRefDistance=function(a){this.panner.refDistance=a};Grape2D.SoundPanner.prototype.getMaxDistance=function(){return this.panner.maxDistance};Grape2D.SoundPanner.prototype.setMaxDistance=function(a){this.panner.maxDistance=a};Grape2D.SoundPanner.prototype.getRolloffFactor=function(){return this.panner.rolloffFactor};
Grape2D.SoundPanner.prototype.setRolloffFactor=function(a){this.panner.rolloffFactor=a};Grape2D.SoundPanner.prototype.getConeInnerAngle=function(){return this.panner.coneInnerAngle};Grape2D.SoundPanner.prototype.setConeInnerAngle=function(a){this.panner.coneInnerAngle=a};Grape2D.SoundPanner.prototype.getConeOuterAngle=function(){return this.panner.coneOuterAngle};Grape2D.SoundPanner.prototype.setConeOuterAngle=function(a){this.panner.coneOuterAngle=a};
Grape2D.SoundPanner.prototype.getConeOuterGain=function(){return this.panner.coneOuterGain};Grape2D.SoundPanner.prototype.setConeOuterGain=function(a){this.panner.coneOuterGain=a};Grape2D.SoundPanner.prototype.connect=function(a){this.panner.connect(a);return this};Grape2D.SoundPanner.prototype.getDestination=function(){return this.panner};Grape2D.SoundPanner.PANNING_MODEL={EQUALPOWER:"equalpower",HRTF:"hrtf"};Grape2D.SoundPanner.DISTANCE_MODEL={LINEAR:"linear",INVERSE:"inverse",EXPONENTIAL:"exponential"};Grape2D.SoundBiquadFilter=function(){this.biquadFilter=Grape2D.SoundManagerSingleton.getContext().createBiquadFilter()};Grape2D.SoundBiquadFilter.prototype=Object.create(Grape2D.SoundIO.prototype);Grape2D.SoundBiquadFilter.prototype.getType=function(){return this.biquadFilter.type};Grape2D.SoundBiquadFilter.prototype.setType=function(a){this.biquadFilter.type=a};Grape2D.SoundBiquadFilter.prototype.getFrequency=function(){return this.biquadFilter.frequency};
Grape2D.SoundBiquadFilter.prototype.setFrequency=function(a){this.biquadFilter.frequency=a};Grape2D.SoundBiquadFilter.prototype.getDetune=function(){return this.biquadFilter.detune};Grape2D.SoundBiquadFilter.prototype.setDetune=function(a){this.biquadFilter.detune=a};Grape2D.SoundBiquadFilter.prototype.getQ=function(){return this.biquadFilter.Q};Grape2D.SoundBiquadFilter.prototype.setQ=function(a){this.biquadFilter.Q=a};Grape2D.SoundBiquadFilter.prototype.getGain=function(){return this.biquadFilter.gain};
Grape2D.SoundBiquadFilter.prototype.setGain=function(a){this.biquadFilter.gain=a};Grape2D.SoundBiquadFilter.prototype.connect=function(a){this.biquadFilter.connect(a.getDestination());return this};Grape2D.SoundBiquadFilter.prototype.getDestination=function(){return this.biquadFilter};Grape2D.LowpassFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(0);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.LowpassFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.HighpassFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(1);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.HighpassFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.BandpassFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(2);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.BandpassFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.LowshelfFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(3);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.LowshelfFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.HighshelfFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(4);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.HighshelfFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.PeakingFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(5);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.PeakingFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.NotchFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(6);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.NotchFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype);Grape2D.AllpassFilter=function(a,b,c){Grape2D.SoundBiquadFilter.call(this);this.setType(7);this.setFrequency(a);this.setQ(b);this.setGain(c)};Grape2D.AllpassFilter.prototype=Object.create(Grape2D.SoundBiquadFilter.prototype); })()
